var input={initInputs:function(){this.initMouse();this.initKeyboard()},mousePosition:{x:0,y:0},initMouse:function(){gameSurface.canvas.onmousedown=function(a){return input.onLeftClick(a)};gameSurface.canvas.oncontextmenu=function(a){return input.onRightClick(a)};gameSurface.canvas.onmousemove=function(a){return input.onMouseMove(a)};gameSurface.canvas.onmouseup=function(a){return input.onMouseUp(a)};gameSurface.canvas.onmousewheel=function(a){return input.onMouseWheel(a)};gameSurface.canvas.ondblclick=
function(a){return input.onDoubleClick(a)}},TOOLBAR_KEYBOARD_SHORTCUTS:[81,87,69,82,65,83,68,70],initKeyboard:function(){document.onkeydown=function(a){return input.onKeyDown(a)};document.onkeyup=function(a){return input.onKeyUp(a)}}};input.onLeftClick=function(a){if(1==a.which){var b=a.x;a=a.y;if(0<GUI.toolbar.length&&a>gameSurface.canvas.height-GUI.TOOLBAR_HEIGHT&&b/(GUI.BUTTONS_WIDTH+GUI.BUTTONS_SPACE)<GUI.toolbar.length&&b%(GUI.BUTTONS_WIDTH+GUI.BUTTONS_SPACE)>GUI.BUTTONS_SPACE)return userInput.clickOnToolbar(GUI.toolbar[parseInt(b/(GUI.BUTTONS_WIDTH+GUI.BUTTONS_SPACE))]),!1;if(null!=gameContent.building)return userInput.tryBuildHere(),!1;userInput.clickToSelect(b,a);return!0}};
input.onDoubleClick=function(a){1==a.which&&userInput.doubleClickToSelect(a.x,a.y);return!1};input.onRightClick=function(a){null!=gameContent.building?userInput.leaveConstructionMode():0<gameContent.selected.length&&rank.isAlly(gameManager.myArmy,gameContent.selected[0])&&(gameContent.selected[0].f==gameData.FAMILIES.unit||gameContent.selected[0].f==gameData.FAMILIES.building)&&userInput.dispatchUnitAction(a.x,a.y);return!1};
input.onMouseMove=function(a){userInput.selectGroup(a.x,a.y);userInput.updateConstructionMode(a.x,a.y);userInput.checkIfMapScrolling(a.x,a.y);userInput.updateMouseIcon(a.x,a.y);this.mousePosition={x:a.x,y:a.y}};input.onMouseUp=function(){userInput.removeSelectionRectangle()};input.onMouseWheel=function(a){0<Math.abs(a.wheelDelta)&&userInput.changeZoom(a.clientX,a.clientY,a.wheelDelta/Math.abs(a.wheelDelta));return!1};
input.onKeyDown=function(a){var b=window.event?a.which:a.keyCode;switch(b){case 38:return gameWindow.updateVerticalScrolling(1),a.preventDefault(),!0;case 40:return gameWindow.updateVerticalScrolling(-1),a.preventDefault(),!0;case 39:return gameWindow.updateHorizontalScrolling(1),!0;case 37:return gameWindow.updateHorizontalScrolling(-1),a.preventDefault(),!0}for(var c in input.TOOLBAR_KEYBOARD_SHORTCUTS)if(input.TOOLBAR_KEYBOARD_SHORTCUTS[c]==b)return userInput.pressToolbarShortcut(c),!1;return!0};
input.onKeyUp=function(a){switch(window.event?a.which:a.keyCode){case 38:return gameWindow.updateVerticalScrolling(0),!1;case 40:return gameWindow.updateVerticalScrolling(0),!1;case 39:return gameWindow.updateHorizontalScrolling(0),!1;case 37:return gameWindow.updateHorizontalScrolling(0),!1}};var userInput={clickOnToolbar:function(a){a.isEnabled&&(a.id==GUI.TOOLBAR_BUTTONS.build.id?GUI.showBuildings=!0:null!=a.constructionColors&&a.isEnabled?this.enterConstructionMode(a):a==GUI.TOOLBAR_BUTTONS.cancel?orderDispatcher.sendOrderToEngine(order.tS.cancelConstruction,[gameContent.selected[0].id]):gameContent.selected[0].f==gameData.FAMILIES.building&&orderDispatcher.sendOrderToEngine(order.tS.buy,[this.getSelectedElementsIds(),a]))},enterConstructionMode:function(a){gameContent.building=a;this.updateConstructionMode(input.mousePosition.x,
input.mousePosition.y)},updateConstructionMode:function(a,b){if(null!=gameContent.building)try{gameContent.building.p=gameWindow.getAbsolutePositionFromPixel(a,b);gameContent.building.canBeBuiltHere=!0;for(var c in gameContent.building.shape){var d=gameContent.building.shape[c],e;for(e in d)0<d[e]&&(tools.getPartPosition(gameContent.building,c,e),gameContent.building.shape[c][e]=10)}}catch(g){}},leaveConstructionMode:function(){gameContent.building=null;GUI.showBuildings=!1},changeZoom:function(a,
b,c){gameWindow.zoom+=c;gameWindow.zoom=Math.max(gameWindow.ZOOM_MIN,gameWindow.zoom);gameWindow.zoom=Math.min(gameWindow.ZOOM_MAX,gameWindow.zoom);gameWindow.getAbsolutePositionFromPixel(a,b);gameWindow.updateGameWindowSize()},pressToolbarShortcut:function(a){a<GUI.toolbar.length&&this.clickOnToolbar(GUI.toolbar[a])},updateMouseIcon:function(a,b){var c=gameWindow.getAbsolutePositionFromPixel(a,b),d=gameWindow.scroll.dx,e=-gameWindow.scroll.dy;null!=tools.getElementUnder(c.x,c.y)?GUI.updateMouse(GUI.MOUSE_ICONS.select):
0<d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopRight):0<d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowRight):0<d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomRight):0>d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopLeft):0>d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowLeft):0>d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomLeft):0==d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTop):0==d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottom):GUI.updateMouse(GUI.MOUSE_ICONS.standard)},checkIfMapScrolling:function(a,
b){a<gameWindow.SCROLL_THRESHOLD?gameWindow.updateHorizontalScrolling(-1):a>gameSurface.canvas.width-gameWindow.SCROLL_THRESHOLD?gameWindow.updateHorizontalScrolling(1):gameWindow.updateHorizontalScrolling(0);b<gameWindow.SCROLL_THRESHOLD?gameWindow.updateVerticalScrolling(1):b>gameSurface.canvas.height-gameWindow.SCROLL_THRESHOLD?gameWindow.updateVerticalScrolling(-1):gameWindow.updateVerticalScrolling(0)},tryBuildHere:function(){gameContent.building.canBeBuiltHere&&(orderDispatcher.sendOrderToEngine(order.tS.buildThatHere,
[this.getSelectedElementsIds(),gameContent.building,gameContent.building.p.x,gameContent.building.p.y]),this.leaveConstructionMode())},dispatchUnitAction:function(a,b){var c=gameWindow.getAbsolutePositionFromPixel(a,b);orderDispatcher.sendOrderToEngine(order.tS.a,[this.getSelectedElementsIds(),c.x,c.y])},getSelectedElementsIds:function(){var a=[],b;for(b in gameContent.selected)a.push(gameContent.selected[b].id);return a}};userInput.SELECTION_RECTANGLE_THRESHOLD=2;userInput.clickToSelect=function(a,b){this.leaveConstructionMode();gameContent.selectionRectangle=[];gameContent.selectionRectangle[0]=a;gameContent.selectionRectangle[1]=b;gameContent.selected=[];var c=gameWindow.getAbsolutePositionFromPixel(a,b),d;for(d in gameContent.gameElements){var e=gameContent.gameElements[d];tools.isElementThere(e,{x:c.x,y:c.y})?(e.isSelected=!0,gameContent.selected.push(e)):e.isSelected=!1}};
userInput.selectGroup=function(a,b){if(0<gameContent.selectionRectangle.length&&Math.abs(a-gameContent.selectionRectangle[0])>this.SELECTION_RECTANGLE_THRESHOLD&&Math.abs(b-gameContent.selectionRectangle[1])>this.SELECTION_RECTANGLE_THRESHOLD){GUI.updateMouse(GUI.MOUSE_ICONS.select);gameContent.selectionRectangle[2]=a-gameContent.selectionRectangle[0];gameContent.selectionRectangle[3]=b-gameContent.selectionRectangle[1];gameContent.selected=[];var c=!1,d=gameWindow.getAbsolutePositionFromPixel(gameContent.selectionRectangle[0],
gameContent.selectionRectangle[1]),e=parseInt(gameContent.selectionRectangle[2]/gameWindow.PIXEL_BY_NODE),g=parseInt(gameContent.selectionRectangle[3]/gameWindow.PIXEL_BY_NODE),h;for(h in gameContent.gameElements){var f=gameContent.gameElements[h];rank.isAlly(gameManager.myArmy,f)&&f.f!=gameData.FAMILIES.terrain&&(0<gameContent.selectionRectangle[2]&&f.p.x<=d.x+e&&f.p.x>=d.x||f.p.x>=d.x+e&&f.p.x<=d.x)&&(0<gameContent.selectionRectangle[3]&&f.p.y<=d.y+g&&f.p.y>=d.y||f.p.y>=d.y+g&&f.p.y<=d.y)?(f.isSelected=
!0,gameContent.selected.push(f),f.f==gameData.FAMILIES.unit&&(c=!0)):f.isSelected=!1}if(c)for(c=gameContent.selected.length;c--;)f=gameContent.selected[c],f.f==gameData.FAMILIES.building&&(f.isSelected=!1,gameContent.selected.splice(c,1))}};userInput.removeSelectionRectangle=function(){gameContent.selectionRectangle=[]};
userInput.doubleClickToSelect=function(){if(0<gameContent.selected.length&&rank.isAlly(gameManager.myArmy,gameContent.selected[0])){var a=gameContent.selected[0],b;for(b in gameContent.gameElements){var c=gameContent.gameElements[b];c.f==a.f&&(rank.isAlly(gameManager.myArmy,c)&&c.t==a.t)&&(c.isSelected=!0,gameContent.selected.push(c))}}};var gameSurface={init:function(){gameSurface.canvas=document.getElementById("canvas");gameSurface.canvas.height=document.height;gameSurface.canvas.width=document.width;gameSurface.ctx=gameSurface.canvas.getContext("2d");gameSurface.grd=gameSurface.ctx.createLinearGradient(0,0,200,0);gameSurface.grd.addColorStop(0,"white");gameSurface.grd.addColorStop(1,"green");gameWindow.updateGameWindowSize()},draw:function(){this.ctx.fillStyle="#fff";this.ctx.fillRect(0,0,gameSurface.canvas.width,gameSurface.canvas.height);
for(var a in gameContent.gameElements){var b=gameContent.gameElements[a];if(b.p.x>=gameWindow.x&&b.p.x<=gameWindow.x+gameWindow.width&&b.p.y>=gameWindow.y&&b.p.y<=gameWindow.y+gameWindow.height){var c=gameData.ELEMENTS[b.f][b.r][b.t].shape;b.isSelected&&(this.ctx.strokeStyle="#00ff00",this.ctx.strokeRect(-1+(b.p.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c[0].length/2),-1+(b.p.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c.length/2),c[0].length*
gameWindow.PIXEL_BY_NODE+2,c.length*gameWindow.PIXEL_BY_NODE+2));this.ctx.fillStyle=null!=b.c?b.c:gameData.ELEMENTS[b.f][b.r][b.t].c;this.ctx.fillRect((b.p.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c.length/2),(b.p.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c.length/2),c[0].length*gameWindow.PIXEL_BY_NODE,c.length*gameWindow.PIXEL_BY_NODE);if(b.f==gameData.FAMILIES.building){0<b.qp&&(this.ctx.fillStyle=this.grd,this.ctx.fillRect((b.p.x-
gameWindow.x)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c.length/2),(b.p.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c.length/2),b.qp/100*gameWindow.PIXEL_BY_NODE*c.length,5));100>b.cp&&(this.ctx.fillStyle=this.grd,this.ctx.fillRect((b.p.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c[0].length/2),(b.p.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c.length/2),b.cp/100*gameWindow.PIXEL_BY_NODE*
c[0].length,5));for(var d in b.q)this.ctx.fillStyle="#ff0",this.ctx.fillRect((b.p.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE+d*gameWindow.PIXEL_BY_NODE-gameWindow.PIXEL_BY_NODE*parseInt(c[0].length/2),(b.p.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE)}}}4==gameContent.selectionRectangle.length&&(this.ctx.fillStyle="#0000ff",this.ctx.strokeRect(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1],gameContent.selectionRectangle[2],gameContent.selectionRectangle[3]));
if(null!=gameContent.building&&null!=gameContent.building.p&&0<=gameContent.building.p.x)for(a in this.ctx.fillStyle="#333",gameContent.building.shape)for(var e in gameContent.building.shape[a])b=gameContent.building.shape[a][e],0<b&&(this.ctx.strokeStyle=10==b?"#00ff00":"#ff0000",b=tools.getPartPosition(gameContent.building,a,e),this.ctx.strokeRect((b.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE,(b.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE));for(a=0;a<
GUI.toolbar.length;a++)this.ctx.fillStyle=GUI.toolbar[a].isEnabled?"#000":"#f00",this.ctx.fillRect(10+90*a,gameSurface.canvas.height-80,80,80);this.ctx.font="20px Arial";for(a=0;a<gameLogic.players[gameManager.myArmy].re.length;a++)this.ctx.fillText(gameLogic.players[gameManager.myArmy].re[a],20+100*a,20);this.ctx.fillText(gameLogic.players[gameManager.myArmy].pop.current+"/"+gameLogic.players[gameManager.myArmy].pop.max,canvas.width-60,20);0<gameContent.selected.length&&rank.isAlly(gameManager.myArmy,
gameContent.selected[0])&&(this.ctx.strokeStyle="#ff00ff",null!=gameContent.selected[0].a?this.ctx.strokeRect((gameContent.selected[0].a.p.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE,(gameContent.selected[0].a.p.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE):null!=gameContent.selected[0].mt&&null!=gameContent.selected[0].mt.x?this.ctx.strokeRect((gameContent.selected[0].mt.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE,(gameContent.selected[0].mt.y-gameWindow.y)*
gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE):gameContent.selected[0].f==gameData.FAMILIES.building&&null!=gameContent.selected[0].rp&&this.ctx.strokeRect((gameContent.selected[0].rp.x-gameWindow.x)*gameWindow.PIXEL_BY_NODE,(gameContent.selected[0].rp.y-gameWindow.y)*gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE,gameWindow.PIXEL_BY_NODE))}};var gameContent={gameElements:[],selected:[],building:null,selectionRectangle:[],updateGameContent:function(){this.gameElements=gameLogic.gameElements;gameContent.updateSelectedElements()},updateSelectedElements:function(){for(var a in this.selected){var b=this.selected[a],c;for(c in this.gameElements){var d=this.gameElements[c];if(d.id==b.id){d.isSelected=!0;d.f==gameData.FAMILIES.unit?(b.a=d.a,b.pa=d.pa,b.mt=d.mt):d.f==gameData.FAMILIES.building&&(b.rp=d.rp);break}}}}};var gameManager={isOfflineGame:!1,iterate:0,startGame:function(){gameSurface.init();input.initInputs();gameThread.start();this.isOfflineGame&&(engineManager.createNewGame(map,players),gameLoop.start());document.getElementById("connecting").className+=" hide";document.getElementById("canvas").className=""},updateGame:function(){this.iterate=1E3<this.iterate?0:this.iterate+1;this.isOfflineGame&&0==this.iterate%2&&gameContent.updateGameContent();GUI.update();gameWindow.update();gameSurface.draw()},joinGame:function(){this.getPlayerId();
this.isOfflineGame||this.connectToServer();document.getElementById("connecting").className="fullScreen";document.getElementById("playButton").className+=" hide"},connectToServer:function(){gameManager.socket=io.connect("http://localhost:6969");this.socket.on("askUserData",function(){var a={};a.playerId=gameManager.playerId;gameManager.socket.emit("userData",a)});this.socket.on("gameStart",function(a){gameLogic.players=a.players;gameManager.myArmy=a.myArmy;gameManager.map=a.map;gameManager.startGame()});
this.socket.on("gameData",function(a){gameLogic.players=a.players;gameContent.gameElements=a.gameElements;gameContent.updateSelectedElements()})},createPlayerId:function(){var a=(new Date).getTime()+Math.random();utils.createCookie("rts_player_id",a);return a},getPlayerId:function(){var a=utils.readCookie("rts_player_id");null==a&&(a=this.createPlayerId());this.playerId=a}};var gameThread={FPS:40,start:function(){setInterval(function(){gameManager.updateGame()},1E3/this.FPS)}};var gameWindow={MAP_SCROLL_SPEED:5,SCROLL_THRESHOLD:30,width:0,height:0,x:0,y:0,PIXEL_BY_NODE:15,zoom:15,ZOOM_MAX:30,ZOOM_MIN:10,scroll:{dx:0,dy:0},updateGameWindowSize:function(){this.height=parseInt(gameSurface.canvas.height/this.PIXEL_BY_NODE);this.width=parseInt(gameSurface.canvas.width/this.PIXEL_BY_NODE)},moveGameWindowPositionTo:function(a,b){this.x=Math.max(0,Math.min(Math.max(0,gameManager.map.size.x-this.width),a));this.y=Math.max(0,Math.min(Math.max(0,gameManager.map.size.y-this.height),
b))},moveGameWindowPositionBy:function(a,b){this.moveGameWindowPositionTo(this.x+a,this.y+b)},updateHorizontalScrolling:function(a){this.scroll.dx=a*this.MAP_SCROLL_SPEED},updateVerticalScrolling:function(a){this.scroll.dy=-a*this.MAP_SCROLL_SPEED},stopMapScrolling:function(){this.updateHorizontalScrolling(0);this.updateVerticalScrolling(0)},update:function(){this.PIXEL_BY_NODE=this.zoom;this.moveGameWindowPositionBy(this.scroll.dx,this.scroll.dy)},getAbsolutePositionFromPixel:function(a,b){return{x:parseInt(a/
this.PIXEL_BY_NODE)+this.x,y:parseInt(b/this.PIXEL_BY_NODE)+this.y}}};var GUI={toolbar:[],TOOLBAR_HEIGHT:80,BUTTONS_WIDTH:80,BUTTONS_SPACE:10,TOOLBAR_BUTTONS:{build:{id:0,color:"#aaa",isEnabled:!0},cancel:{id:1,color:"#ff0",isEnabled:!0}},MOUSE_ICONS:{standard:"default",arrowTop:"n-resize",arrowTopRight:"ne-resize",arrowTopLeft:"nw-resize",arrowBottom:"s-resize",arrowBottomRight:"se-resize",arrowBottomLeft:"sw-resize",arrowRight:"e-resize",arrowLeft:"w-resize",select:"crosshair"},showBuildings:!1,update:function(){this.updateToolbar()},updateToolbar:function(){0<gameContent.selected.length&&
rank.isAlly(gameManager.myArmy,gameContent.selected[0])?gameContent.selected[0].f==gameData.FAMILIES.building?this.toolbar=100>gameContent.selected[0].cp?[GUI.TOOLBAR_BUTTONS.cancel]:production.getWhatCanBeBought(gameContent.selected[0].o,gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.selected[0].r][gameContent.selected[0].t].buttons):gameContent.selected[0].f==gameData.FAMILIES.unit&&(this.toolbar=this.showBuildings?this.getBuildingButtons():gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.selected[0].r][gameContent.selected[0].t].buttons):
this.toolbar=[]},getBuildingButtons:function(){return production.getWhatCanBeBought(gameContent.selected[0].o,gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.selected[0].r])},updateMouse:function(a){document.body.style.cursor=a}};var orderDispatcher={sendOrderToEngine:function(a,b){gameManager.isOfflineGame?order.dispatchReceivedOrder(a,b):gameManager.socket.emit("order",[a,b])}};var utils={getAbsolutePositionFromPixel:function(a,b){return{x:parseInt(a/gameWindow.PIXEL_BY_NODE)+gameWindow.x,y:parseInt(b/gameWindow.PIXEL_BY_NODE)+gameWindow.y}},readCookie:function(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;c++){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null},createCookie:function(a,b){document.cookie=a+"="+b+"; path=/"}};