var action={ACTION_TYPES:{move:0,attack:1,gather:2,patrol:3,build:4,hold:5},BUILD_ACTION_SPEED:3,ATTACK_SPEED_CONSTANT:5,doTheBuild:function(b,a,c){100>c.cp?0==b.iterate%this.BUILD_ACTION_SPEED&&(production.updateConstruction(b,c),a.fl=gameData.ELEMENTS_FLAGS.building):c.l<tools.getElementData(c).l?0==b.iterate%this.BUILD_ACTION_SPEED&&(production.repairBuilding(b,c),a.fl=gameData.ELEMENTS_FLAGS.building):order.goToElementNextOrder(b,a)},doTheAttack:function(b,a,c){0==b.iterate%(this.ATTACK_SPEED_CONSTANT-
tools.getElementData(a).attackSpeed)&&(fightLogic.attack(b,a,c),a.fl=gameData.ELEMENTS_FLAGS.attacking)},doTheGathering:function(b,a,c){0==b.iterate%tools.getElementData(a).gatheringSpeed&&(production.gatherResources(b,a,c),a.fl=gameData.ELEMENTS_FLAGS.mining)}};var AI={searchForNewResources:function(b,a,c){b=tools.getNearestStuff(b,a,gameData.FAMILIES.land,c);a.a=null!=b?new gameData.Order(action.ACTION_TYPES.gather,null,b.id,c):null},searchForNewEnemy:function(b,a){var c=tools.getNearestStuff(b,a,gameData.FAMILIES.unit,null,gameData.RANKS.enemy);null==c&&(c=tools.getNearestStuff(b,a,gameData.FAMILIES.building,null,gameData.RANKS.enemy));null!=c&&(a.a=new gameData.Order(action.ACTION_TYPES.attack,null,c.id))},targetReaction:function(b,a,c){var d=tools.getElementData(a);
d.isBuilder||1<d.range&&1==tools.getElementData(c).range?(b=tools.getFreeTilesAroundElements(b,a),0<b.length&&(b=b[parseInt(Math.random()*(b.length-1))],a.a=new gameData.Order(action.ACTION_TYPES.move,b,null))):a.a=new gameData.Order(action.ACTION_TYPES.attack,null,c.id)}};var aiOrders={update:function(b,a){},buildHouses:function(b,a,c){if(a.pop.current>a.pop.max-8){a=null;var d=0;for(d in b.gameElements.unit){var e=b.gameElements.unit[d];if(e.o==c&&gameData.ELEMENTS[e.f][e.r][e.t].isBuilder&&(a=e,null!=e.a&&e.a.type==action.ACTION_TYPES.build))return}c=a.p;for(var f=0,f=0;10>f;f++){order.move(b,[a],parseInt(Math.random()*b.grid[0].length-1),parseInt(Math.random()*b.grid.length-1),!1);var g=tools.getFreeTilesAroundElements(b,a);for(d in g){c=g[d];var h=tools.getNeighbors(b.grid,
c.x,c.y),l;for(l in h)if(c=h[l],this.canBeBuiltHere(b,c,gameData.ELEMENTS[gameData.FAMILIES.building][e.t][1])){order.buildThatHere(b,[a.id],gameData.ELEMENTS[gameData.FAMILIES.building][a.t][1],c.x,c.y,!1);return}}}}},trainHarvesters:function(b,a){for(var c in b.gameElements.building){var d=b.gameElements.building[c];d.o==a&&"Town Hall"==gameData.ELEMENTS[d.f][d.r][d.t].name&&2>d.q.length&&order.buy(b,[d.id],gameData.ELEMENTS[gameData.FAMILIES.unit][0][0])}},harvest:function(b,a){var c=[],d;for(d in b.gameElements.unit){var e=
b.gameElements.unit[d];e.o==a&&(!gameData.ELEMENTS[e.f][e.r][e.t].isBuilder||(null!=e.a||0!=e.pa.length||null!=e.mt&&null!=e.mt.x)||c.push(e))}for(var f in c)f<c.length/2?(d=tools.getNearestStuff(b,c[f],gameData.FAMILIES.land,1,null,!1),null!=d&&order.gather(b,[c[f]],tools.getNearestStuff(b,c[f],gameData.FAMILIES.land,1,null,!1),!1)):(d=tools.getNearestStuff(b,c[f],gameData.FAMILIES.land,1,null,!1),null!=d&&order.gather(b,[c[f]],tools.getNearestStuff(b,c[f],gameData.FAMILIES.land,0,null,!1),!1))},
canBeBuiltHere:function(b,a,c){c.p=a;a=tools.getPartPosition(c,0,0);var d=a.x+c.shape[0].length-1;c=a.y+c.shape.length-1;for(var e=a.x;e<=d;e++)for(var f=a.y;f<=c;f++)if(null!=b.grid[e]&&null!=b.grid[e][f]&&0<b.grid[e][f].c)return!1;return!0}};var fightLogic={WEAPON_TYPES:{normal:0,piercing:1,siege:2,magic:3},ARMOR_TYPES:{unarmored:0,light:1,medium:2,heavy:3,building:4},WEAPONS_EFFICIENCY:[[1,1,1.5,1,0.4],[1.5,1.5,0.5,0.5,0.2],[1.5,1,0.5,0.5,2],[1.5,1.5,1.5,1.5,0.1]],attack:function(b,a,c){var d=tools.getElementData(a),e=tools.getElementData(c),d=Math.max(0,parseInt(d.attack*this.WEAPONS_EFFICIENCY[d.weaponType][e.armorType]*(1+0.2*Math.random()))-e.defense);this.applyDamage(b,d,c,a);tools.addUniqueElementToArray(b.modified,c);c.f==gameData.FAMILIES.unit&&
null==c.a&&AI.targetReaction(b,c,a);b.players[c.o].ra[a.o]=gameData.RANKS.enemy},applyDamage:function(b,a,c,d){0<c.l?(c.l-=a,0>=c.l&&(c.fl=gameData.ELEMENTS_FLAGS.dying,null!=d&&(d.fr+=1,d.a=null,tools.addUniqueElementToArray(b.modified,d),c.murderer=d.o,AI.searchForNewEnemy(b,d)),c.f==gameData.FAMILIES.building&&(production.removeBuilding(b,c),gameCreation.removeGameElement(b,c),delete b.gameElements.building[c.id]))):null!=d&&AI.searchForNewEnemy(b,d)}};var gameCreation={PROBABILITY_TREE:0.6,ZONE_SIZE:8,createNewGame:function(b,a){var c=new gameData.Game,d;for(d in a){var e=a[d],f;for(f in b.ir.re)e.re.push(b.ir.re[f].value);for(var g in a)g==d?e.ra.push(gameData.RANKS.me):e.ra.push(gameData.RANKS.enemy);c.players.push(e)}this.createNewMap(c,b,a);stats.init(c);return c},createNewMap:function(b,a,c){b.grid=this.initGrid(a.size);a.t.id==gameData.MAP_TYPES.random.id&&this.createRandomMap(b,a,c)},initGrid:function(b){for(var a=[],c=0;c<b.x;c++){a[c]=
[];for(var d=0;d<b.y;d++)a[c][d]={c:0,x:c,y:d}}return a},createRandomMap:function(b,a,c){for(var d=parseInt(a.size.x/this.ZONE_SIZE),e=parseInt(a.size.y/this.ZONE_SIZE),f=[],g=0;g<d;g++){f.push([]);for(var h=0;h<e;h++)f[g].push(-10)}this.dispatchPlayers(b,f,c,d,e);c=[];for(g in a.ve.zones)for(var h=a.ve.zones[g],l=0;l<h.factor;l++)c.push(h.t);for(g=0;g<d;g++)for(h=0;h<e;h++)0>f[g][h]?this.populateZone(b,a,{x:g*this.ZONE_SIZE+1,y:h*this.ZONE_SIZE+1},{x:(g+1)*this.ZONE_SIZE-1,y:(h+1)*this.ZONE_SIZE-
1},c[parseInt(Math.random()*c.length)]):this.populateZone(b,a,{x:g*this.ZONE_SIZE+1,y:h*this.ZONE_SIZE+1},{x:(g+1)*this.ZONE_SIZE-1,y:(h+1)*this.ZONE_SIZE-1},f[g][h])},populateZone:function(b,a,c,d,e){switch(e){case gameData.ZONES.forest:this.createForest(b,c,d);break;case gameData.ZONES.goldmine:this.createGoldMine(b,a,c,d);break;case gameData.ZONES.water:this.createWaterZone(b,a,c,d)}},createForest:function(b,a,c){for(var d=a.x;d<c.x;d++)for(var e=a.y;e<c.y;e++)Math.random()<this.PROBABILITY_TREE&&
this.addGameElement(b,new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.land][0][0],d,e))},createGoldMine:function(b,a,c,d){a=this.getRandomPositionInZoneForElement(gameData.ELEMENTS[gameData.FAMILIES.land][0][1],c,d);this.addGameElement(b,new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.land][0][1],a.x,a.y))},createWaterZone:function(b,a,c,d){for(a=c.x;a<d.x;a++)for(var e=c.y;e<d.y;e++)this.addGameElement(b,new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.land][0][2],a,e))},
getRandomPositionInZoneForElement:function(b,a,c){return{x:parseInt(a.x+b.shape[0].length/2+Math.random()*(c.x-a.x-b.shape[0].length)),y:parseInt(a.y+b.shape.length/2+Math.random()*(c.y-a.y-b.shape.length))}},addGameElement:function(b,a){var c=gameData.ELEMENTS[a.f][a.r][a.t].shape;b.gameElements[Object.keys(gameData.FAMILIES)[a.f]][a.id]=a;for(var d in c){var e=c[d],f;for(f in e)if(0<e[f]){var g=tools.getPartPosition(a,d,f);b.grid[g.x][g.y].c=a.id}}tools.addUniqueElementToArray(b.added,a)},removeGameElement:function(b,
a){var c=gameData.ELEMENTS[a.f][a.r][a.t].shape,d;for(d in c){var e=c[d],f;for(f in e)if(0<e[f]){var g=tools.getPartPosition(a,d,f);b.grid[g.x][g.y].c=0}}tools.addUniqueElementToArray(b.removed,a)},dispatchPlayers:function(b,a,c,d,e){d=this.getAvailableInitialPositions(c.length);for(var f in c){var g=parseInt(d.length*Math.random());e=d[g];e={x:this.convertCoordinates(a[0].length,e.x),y:this.convertCoordinates(a.length,e.y)};d.splice(g,1);a[e.x][e.y]=gameData.ZONES.basecamp;g={x:e.x*this.ZONE_SIZE+
parseInt(this.ZONE_SIZE/4)+parseInt(Math.random()*this.ZONE_SIZE/2),y:e.y*this.ZONE_SIZE+parseInt(this.ZONE_SIZE/4)+parseInt(Math.random()*this.ZONE_SIZE/2)};this.setupBasecamp(b,c[f],g);this.placeZoneRandomlyAround(gameData.ZONES.forest,a,e.x,e.y);this.placeZoneRandomlyAround(gameData.ZONES.goldmine,a,e.x,e.y)}},placeZoneRandomlyAround:function(b,a,c,d){for(var e=null,f=null;null==e||1==a[e][f];)e=Math.min(a[0].length-1,Math.max(0,parseInt(c+2*Math.random()-1))),f=Math.min(a.length-1,Math.max(0,
parseInt(d+2*Math.random()-1)));a[e][f]=b},setupBasecamp:function(b,a,c){var d=gameData.BASECAMPS[a.r];c=new gameData.Building(d.buildings[0],c.x,c.y,a.o,!0);this.addGameElement(b,c);c=tools.getFreeTilesAroundElements(b,c);for(var e in d.units)this.addGameElement(b,new gameData.Unit(d.units[e],c[e].x,c[e].y,a.o))},getAvailableInitialPositions:function(b){var a=[];if(4!=b)for(var c=[[0,0,0],[0,1,0],[0,0,0]],d=0;d<b;d++){for(var e=null,f=null;null==e||0<c[e][f];)e=parseInt(3*Math.random()),f=parseInt(3*
Math.random());c[e][f]=1;a.push({x:e,y:f});3>=b&&(2>e&&(c[e+1][f]=1),0<e&&(c[e-1][f]=1),2>f&&(c[e][f+1]=1),0<f&&(c[e][f-1]=1))}else 0.5>Math.random()?(a.push({x:0,y:0}),a.push({x:0,y:2}),a.push({x:2,y:0}),a.push({x:2,y:2})):(a.push({x:1,y:0}),a.push({x:1,y:2}),a.push({x:0,y:1}),a.push({x:2,y:1}));return a},convertCoordinates:function(b,a){return 0==a?1:1==a?parseInt(b/2):b-2}};var gameData={FAMILIES:{unit:0,building:1,land:2},ELEMENTS:[[],[],[]],RANKS:{me:0,ally:1,neutral:2,enemy:3},PLAYER_STATUSES:{ig:0,defeat:1,victory:2,watcher:3,surrender:4},ELEMENTS_FLAGS:{nothing:0,moving:1,attacking:2,mining:3,dying:5,building:6},unitId:0,createUniqueId:function(b){this.unitId+=1;return parseInt("1"+b+""+this.unitId)}};var gameLogic={FREQUENCY:3,update:function(b){b.modified=[];b.added=[];b.removed=[];for(var a in b.orders)order.dispatchReceivedOrder(b,b.orders[a][0],b.orders[a][1]);b.orders=[];for(var c in b.players)b.players[c].s!=gameData.PLAYER_STATUSES.surrender&&(b.players[c].s=gameData.PLAYER_STATUSES.defeat),b.players[c].ai&&aiOrders.update(b,b.players[c]);for(c in b.gameElements.unit){var d=b.gameElements.unit[c];this.resolveActions(b,d);this.updateMoves(b,d);this.protectAround(b,d)}for(c in b.gameElements.building)d=
b.gameElements.building[c],b.players[d.o].s!=gameData.PLAYER_STATUSES.surrender&&(b.players[d.o].s=gameData.PLAYER_STATUSES.ig),this.updateBuildings(b,d),null!=tools.getElementData(d).attack&&(this.resolveActions(b,d),this.protectAround(b,d));this.addNewBuildings(b);this.removeDeads(b);this.checkGameOver(b);stats.update(b);c=[];for(a in b.chat)c.push(b.chat[a]);b.chat=[];return{modified:b.modified,added:b.added,removed:b.removed,players:b.players,chat:c}},addNewBuildings:function(b){for(var a in b.newBuildings)b.newBuildings[a].l=
1,gameCreation.addGameElement(b,b.newBuildings[a]);b.newBuildings=[];for(a in b.cancelBuildings)gameCreation.removeGameElement(b,b.cancelBuildings[a]);b.cancelBuildings=[]},updateMoves:function(b,a){null!=a.a&&null!=a.a.moveTo&&(move.moveElement(b,a,a.a.moveTo),a.fl=gameData.ELEMENTS_FLAGS.moving,tools.addUniqueElementToArray(b.modified,a))},resolveActions:function(b,a){if(null!=a.a&&null!=a.a.id){var c=tools.getElementById(b,a.a.id);if(null!=c){var d=tools.getElementData(a),e=tools.getElementsDistance(a,
c);1==e?(a.a.moveTo=null,a.fl=gameData.ELEMENTS_FLAGS.nothing,d.isBuilder&&c.f==gameData.FAMILIES.building&&rank.isAlly(b.players,a.o,c)?null!=a.ga?production.getBackResources(b,a):action.doTheBuild(b,a,c):d.isBuilder&&c.f==gameData.FAMILIES.land?action.doTheGathering(b,a,c):rank.isEnemy(b.players,a.o,c)&&action.doTheAttack(b,a,c)):e<=d.range?rank.isEnemy(b.players,a.o,c)&&(a.a.moveTo=null,action.doTheAttack(b,a,c)):(c=tools.getClosestPart(a,c),a.a.moveTo={x:c.x,y:c.y});tools.addUniqueElementToArray(b.modified,
a)}else a.a.type==action.ACTION_TYPES.gather?AI.searchForNewResources(b,a,a.a.info):a.a.type!=action.ACTION_TYPES.move&&a.a.type!=action.ACTION_TYPES.patrol||order.goToElementNextOrder(b,a)}},removeDeads:function(b){for(var a in b.gameElements.unit){var c=b.gameElements.unit[a];0>=c.l&&(production.removeUnit(b,c),gameCreation.removeGameElement(b,c),delete b.gameElements.unit[c.id])}},updateBuildings:function(b,a){0<a.q.length&&(production.updateQueueProgress(b,a),tools.addUniqueElementToArray(b.modified,
a))},checkGameOver:function(b){var a=0,c=-1,d;for(d in b.players)b.players[d].s==gameData.PLAYER_STATUSES.defeat||b.players[d].s==gameData.PLAYER_STATUSES.surrender?a++:c=b.players[d].o;a==b.players.length-1&&(b.players[c].s=gameData.PLAYER_STATUSES.victory)},protectAround:function(b,a){var c=tools.getElementData(a);(null==a.a||a.a.type==action.ACTION_TYPES.move&&a.a.info==order.SPECIAL_ORDERS.attack)&&(!c.isBuilder&&(a.f==gameData.FAMILIES.unit||100<=a.cp&&null!=c.attack))&&AI.searchForNewEnemy(b,
a)}};var move={ASTAR_MAX_STEPS_SEARCH:4,DESTINATION_SEARCH_NUMBER:5,ASTAR_MAX_RADIUS_SEARCH:10,moveElement:function(b,a,c){var d=tools.getElementData(a);if(0==b.iterate%d.speed){var e=0;a:for(;0<b.grid[c.x][c.y].c&&e<this.DESTINATION_SEARCH_NUMBER;){e++;c=astar.neighbors(b.grid,c.x,c.y,!0);for(var f in c)if(0==c[f].c){c=c[f];a.a.moveTo={x:c.x,y:c.y};break a}c={x:c[1].x,y:c[1].y}}if(0<c.c)a.a.moveTo=null;else if(e=astar.search(b.grid,a.p,b.grid[c.x][c.y],!0),0<e.length){d=d.shape;for(f in d)for(var g in d[f])0<
d[f][g]&&(c=tools.getPartPosition(a,f,g),b.grid[c.x][c.y].c=0);a.p.x=e[0].x;a.p.y=e[0].y;for(f in d)for(g in d[f])0<d[f][g]&&(c=tools.getPartPosition(a,f,g),b.grid[c.x][c.y].c=a.id);a.a.moveTo.x==a.p.x&&a.a.moveTo.y==a.p.y&&(a.a.type==action.ACTION_TYPES.move?(a.a=null,0<a.pa.length&&order.goToElementNextOrder(b,a)):(a.a.moveTo=null,a.fl=gameData.ELEMENTS_FLAGS.nothing))}}}},astar={init:function(b,a,c){var d=Math.max(0,Math.min(a.x,c.x)-move.ASTAR_MAX_RADIUS_SEARCH),e=Math.min(b[0].length-1,Math.max(a.x,
c.x)+move.ASTAR_MAX_RADIUS_SEARCH),f=Math.max(0,Math.min(a.y,c.y)-move.ASTAR_MAX_RADIUS_SEARCH);for(a=Math.min(b.length-1,Math.max(a.y,c.y)+move.ASTAR_MAX_RADIUS_SEARCH);d<e;d++)for(c=f;c<a;c++){var g=b[d][c];g.f=0;g.g=0;g.h=0;g.cost=1;g.visited=!1;g.closed=!1;g.parent=null}},heap:function(){return new BinaryHeap(function(b){return b.f})},search:function(b,a,c,d,e){astar.init(b,a,c);e=e||astar.manhattan;d=!!d;var f=astar.heap();for(f.push(b[a.x][a.y]);0<f.size();){a=f.pop();if(a===c||f.size()>this.ASTAR_MAX_STEPS_SEARCH){b=
a;for(c=[];b.parent;)c.push(b),b=b.parent;return c.reverse()}a.closed=!0;for(var g=astar.neighbors(b,a.x,a.y,d),h=0,l=g.length;h<l;h++){var k=g[h];if(!(k.closed||0<k.c)){var m=a.g+k.cost,n=k.visited;if(!n||m<k.g)k.visited=!0,k.parent=a,k.h=k.h||e(k,c),k.g=m,k.f=k.g+k.h,n?f.rescoreElement(k):f.push(k)}}}return[]},manhattan:function(b,a){var c=Math.abs(a.x-b.x),d=Math.abs(a.y-b.y);return c+d},neighbors:function(b,a,c,d){var e=[];b[a-1]&&b[a-1][c]&&e.push(b[a-1][c]);b[a+1]&&b[a+1][c]&&e.push(b[a+1][c]);
b[a]&&b[a][c-1]&&e.push(b[a][c-1]);b[a]&&b[a][c+1]&&e.push(b[a][c+1]);d&&(b[a-1]&&b[a-1][c-1]&&e.push(b[a-1][c-1]),b[a+1]&&b[a+1][c-1]&&e.push(b[a+1][c-1]),b[a-1]&&b[a-1][c+1]&&e.push(b[a-1][c+1]),b[a+1]&&b[a+1][c+1]&&e.push(b[a+1][c+1]));return e}};function BinaryHeap(b){this.content=[];this.scoreFunction=b}
BinaryHeap.prototype={push:function(b){this.content.push(b);this.sinkDown(this.content.length-1)},pop:function(){var b=this.content[0],a=this.content.pop();0<this.content.length&&(this.content[0]=a,this.bubbleUp(0));return b},remove:function(b){for(var a=this.content.length,c=0;c<a;c++)if(this.content[c]==b){var d=this.content.pop();c!=a-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(b)?this.sinkDown(c):this.bubbleUp(c));return}throw Error("Node not found.");},size:function(){return this.content.length},
rescoreElement:function(b){this.sinkDown(this.content.indexOf(b))},sinkDown:function(b){for(var a=this.content[b];0<b;){var c=Math.floor((b+1)/2)-1,d=this.content[c];if(this.scoreFunction(a)<this.scoreFunction(d))this.content[c]=a,this.content[b]=d,b=c;else break}},bubbleUp:function(b){for(var a=this.content.length,c=this.content[b],d=this.scoreFunction(c);;){var e=2*(b+1),f=e-1,g=null;if(f<a){var h=this.scoreFunction(this.content[f]);h<d&&(g=f)}e<a&&this.scoreFunction(this.content[e])<(null==g?d:
h)&&(g=e);if(null!=g)this.content[b]=this.content[g],this.content[g]=c,b=g;else break}}};var order={TYPES:{action:0,buildThatHere:1,buy:2,cancelConstruction:3,chat:4,diplomacy:5,surrender:6,stop:7,hold:8},SPECIAL_ORDERS:{normal:0,attack:1,patrol:2},dispatchReceivedOrder:function(b,a,c){switch(a){case 0:this.convertDestinationToOrder(b,c[0],c[1],c[2],c[3],c[4]);break;case 1:this.buildThatHere(b,c[0],c[1],c[2],c[3],c[4]);break;case 2:this.buy(b,c[0],c[1]);break;case 3:this.cancelConstruction(b,c[0]);break;case 4:this.receiveChatMessage(b,c[0],c[1]);break;case 5:this.updateDiplomacy(b,c[0],
c[1],c[2]);break;case 6:this.surrender(b,c[0]);break;case 7:this.stopUnits(b,c[0]);break;case 8:this.holdUnits(b,c[0])}},buildThatHere:function(b,a,c,d,e,f){a=tools.getGameElementsFromIds(b,a);c=new gameData.Building(c,d,e,a[0].o,!1);production.startConstruction(b,c);this.build(b,a,c,f)},buy:function(b,a,c){a=tools.getGameElementsFromIds(b,a);production.buyElement(b,a,c)},cancelConstruction:function(b,a){var c=tools.getGameElementsFromIds(b,[a]);production.cancelConstruction(b,c[0])},updateRallyingPoint:function(b,
a,c,d){for(var e in a){var f=a[e];0<gameData.ELEMENTS[f.f][f.r][f.t].buttons.length&&(f.rp={x:c,y:d});tools.addUniqueElementToArray(b.modified,f)}},attack:function(b,a,c){for(var d in a){var e=a[d];e.a=new gameData.Order(action.ACTION_TYPES.attack,null,c.id);e.pa=[];tools.addUniqueElementToArray(b.modified,e)}},build:function(b,a,c,d){for(var e in a){var f=a[e];d&&null!=f.a&&f.a.type!=action.ACTION_TYPES.gather?f.pa.push(new gameData.Order(action.ACTION_TYPES.build,null,c.id)):(f.a=new gameData.Order(action.ACTION_TYPES.build,
null,c.id),f.pa=[]);tools.addUniqueElementToArray(b.modified,f)}},move:function(b,a,c,d,e,f){for(var g in a){var h=a[g];e&&null!=h.a&&h.a.type!=action.ACTION_TYPES.gather?h.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:c,y:d},null,f)):(h.a=new gameData.Order(action.ACTION_TYPES.move,{x:c,y:d},null,f),h.pa=[],f==order.SPECIAL_ORDERS.patrol&&h.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:h.p.x,y:h.p.y},null,2)));tools.addUniqueElementToArray(b.modified,h)}},gather:function(b,a,c,
d){var e=tools.getElementData(c),f;for(f in a){var g=a[f];d&&null!=g.a&&g.a.type!=action.ACTION_TYPES.gather?g.pa.push(new gameData.Order(action.ACTION_TYPES.gather,null,c.id,e.resourceType)):(g.a=new gameData.Order(action.ACTION_TYPES.gather,null,c.id,e.resourceType),g.pa=[g.a]);tools.addUniqueElementToArray(b.modified,g)}},receiveChatMessage:function(b,a,c){b.chat.push({o:a,text:c})},updateDiplomacy:function(b,a,c,d){b.players[a].ra[c]=d},surrender:function(b,a){b.players[a].s=gameData.PLAYER_STATUSES.surrender},
convertDestinationToOrder:function(b,a,c,d,e,f){a=tools.getGameElementsFromIds(b,a);if(0!=a.length&&null!=b.grid[c]&&null!=b.grid[c][d]){var g=null,h=b.grid[c][d].c;0<h&&(g=tools.getGameElementsFromIds(b,[h]));if(a[0].f==gameData.FAMILIES.building)this.updateRallyingPoint(b,a,c,d);else{if(null!=g&&0<g.length)if(g[0].f==gameData.FAMILIES.unit){if(!rank.isAlly(b.players,a[0].o,g[0])){this.attack(b,a,g[0]);return}}else{if(g[0].f==gameData.FAMILIES.building){if(rank.isAlly(b.players,a[0].o,g[0]))for(var l in a)h=
a[l],tools.getElementData(h).isBuilder?order.build(b,[h],g[0],e):order.move(b,[h],c,d,e,f);else order.attack(b,a,g[0]);return}if(g[0].f==gameData.FAMILIES.land&&0<=gameData.ELEMENTS[g[0].f][0][g[0].t].resourceType){for(l in a)h=a[l],tools.getElementData(h).isBuilder?order.gather(b,[h],g[0],e):order.move(b,[h],c,d,e,f);return}}order.move(b,a,c,d,e,f)}}},goToElementNextOrder:function(b,a){if(0<a.pa.length){if(null==a.a||a.a.type!=action.ACTION_TYPES.gather){if(null!=a.a&&a.a.type==action.ACTION_TYPES.build){var c=
tools.getElementById(b,a.a.id),d=tools.getElementData(c);if(100>c.cp||c.l<d.l)return}else a.pa[0].type==action.ACTION_TYPES.move&&(a.pa[0].info==order.SPECIAL_ORDERS.patrol&&1==a.pa.length)&&(a.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:a.p.x,y:a.p.y},null,order.SPECIAL_ORDERS.patrol)),a.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:a.pa[0].moveTo.x,y:a.pa[0].moveTo.y},null,order.SPECIAL_ORDERS.patrol)));a.a=a.pa[0];a.pa.splice(0,1)}}else a.a=null,a.fl=gameData.ELEMENTS_FLAGS.nothing},
stopUnits:function(b,a){var c=tools.getGameElementsFromIds(b,a),d;for(d in c){var e=c[d];e.f==gameData.FAMILIES.unit&&(e.a=null,e.pa=[],tools.addUniqueElementToArray(b.modified,e))}},holdUnits:function(b,a){var c=tools.getGameElementsFromIds(b,a),d;for(d in c){var e=c[d];e.f==gameData.FAMILIES.unit&&(e.a=new gameData.Order(action.ACTION_TYPES.hold,null,null),e.pa=[],tools.addUniqueElementToArray(b.modified,e))}}};var production={RESOURCE_AMOUNT_PER_GATHERING_ACTION:2,BUILDINGS_QUEUE_MAX_SIZE:5,REPAIRING_SPEED:5,startConstruction:function(b,a){var c=tools.getElementData(a);this.canBuyIt(b.players,a.o,c)&&(this.paysForElement(b,a.o,c),b.newBuildings.push(a))},updateConstruction:function(b,a){var c=tools.getElementData(a);a.cp+=100/c.timeConstruction;a.l+=parseInt(c.l/c.timeConstruction);a.l=Math.min(c.l,a.l);100<=a.cp&&this.finishConstruction(b,a);tools.addUniqueElementToArray(b.modified,a)},cancelConstruction:function(b,
a){if(null!=a&&95>a.cp){this.sellsElement(b,a.o,gameData.ELEMENTS[a.f][a.r][a.t]);this.removeBuilding(b,a);for(var c in b.gameElements.unit)null!=b.gameElements.unit[c].a&&b.gameElements.unit[c].a.id==a.id&&order.goToElementNextOrder(b,b.gameElements.unit[c]);b.cancelBuildings.push(a);delete b.gameElements.building[a.id]}},finishConstruction:function(b,a){var c=tools.getElementData(a);a.cp=100;a.l=c.l;0<c.pop&&(b.players[a.o].pop.max+=c.pop);stats.updateField(b,a.o,"buildingsCreated",1)},repairBuilding:function(b,
a){var c=b.players[a.o].re;0<c[gameData.RESOURCES.wood.id]&&0<c[gameData.RESOURCES.gold.id]&&(c[gameData.RESOURCES.gold.id]--,c[gameData.RESOURCES.wood.id]--,a.l+=this.REPAIRING_SPEED,a.l=Math.min(a.l,tools.getElementData(a).l),tools.addUniqueElementToArray(b.modified,a))},removeBuilding:function(b,a){var c=tools.getElementData(a);0<c.pop&&100==a.cp&&(b.players[a.o].pop.max-=c.pop);null!=a.murderer&&stats.updateField(b,a.murderer,"buildingsDestroyed",1)},gatherResources:function(b,a,c){var d=tools.getElementData(c),
e=tools.getElementData(a);if(null==a.ga||a.ga.t!=d.resourceType)a.ga={t:d.resourceType,amount:0};var f=Math.min(e.maxGathering-a.ga.amount,this.RESOURCE_AMOUNT_PER_GATHERING_ACTION,c.ra);a.ga.amount+=f;c.ra-=f;tools.addUniqueElementToArray(b.modified,c);a.ga.amount==e.maxGathering&&(e=tools.getNearestStuff(b,a,gameData.FAMILIES.building,gameData.ELEMENTS[gameData.FAMILIES.building][b.players[a.o].r][0].t,gameData.RANKS.me,!0),a.a=new gameData.Order(action.ACTION_TYPES.gather,null,e.id,d.resourceType),
a.pa=[new gameData.Order(action.ACTION_TYPES.gather,null,c.id,d.resourceType)]);0==c.ra&&(gameCreation.removeGameElement(b,c),delete b.gameElements.land[c.id],AI.searchForNewResources(b,a,d.resourceType))},getBackResources:function(b,a){var c=a.ga.t;b.players[a.o].re[a.ga.t]+=a.ga.amount;stats.updateField(b,a.o,"resources",a.ga.amount);a.ga=null;if(0<a.pa.length&&a.pa[0].type==action.ACTION_TYPES.gather){var d=tools.getElementById(b,a.pa[0].id);null==d||0>=d.ra?AI.searchForNewResources(b,a,c):a.a=
a.pa[0]}a.pa=[]},buyElement:function(b,a,c){for(var d in a){var e=a[d];e.t==a[0].t&&(100==e.cp&&e.q.length<this.BUILDINGS_QUEUE_MAX_SIZE&&this.canBuyIt(b.players,e.o,c))&&(this.paysForElement(b,e.o,c),e.q.push(c.t),tools.addUniqueElementToArray(b.modified,e))}},updateQueueProgress:function(b,a){a.qp+=100/(gameLogic.FREQUENCY*gameData.ELEMENTS[gameData.FAMILIES.unit][a.r][a.q[0]].timeConstruction);if(100<=a.qp){var c=!0;(c=this.createNewUnit(b,a.q[0],a))?(a.qp=0,a.q.splice(0,1)):a.qp=99}tools.addUniqueElementToArray(b.modified,
a)},createNewUnit:function(b,a,c){a=gameData.ELEMENTS[gameData.FAMILIES.unit][c.r][a];var d=tools.getFreeTilesAroundElements(b,c),e=b.players[c.o].pop;return 0<d.length&&e.current+a.pop<=e.max?(a.isBuilder?stats.updateField(b,c.o,"buildersCreated",1):stats.updateField(b,c.o,"unitsCreated",1),d=d[d.length-1],a=new gameData.Unit(a,d.x,d.y,c.o),b.players[c.o].pop.current+=gameData.ELEMENTS[a.f][a.r][a.t].pop,gameCreation.addGameElement(b,a),null!=c.rp&&order.convertDestinationToOrder(b,[a.id],c.rp.x,
c.rp.y),!0):!1},removeUnit:function(b,a){0<gameData.ELEMENTS[a.f][a.r][a.t].pop&&(b.players[a.o].pop.current-=gameData.ELEMENTS[a.f][a.r][a.t].pop);null!=a.murderer&&(stats.updateField(b,a.murderer,"killed",1),stats.updateField(b,a.o,"lost",1))},canBuyIt:function(b,a,c){for(var d in c.needs){var e=c.needs[d];if(e.value>b[a].re[e.t])return!1}return!0},paysForElement:function(b,a,c){for(var d in c.needs){var e=c.needs[d];b.players[a].re[e.t]-=e.value}},sellsElement:function(b,a,c){for(var d in c.needs){var e=
c.needs[d];b.players[a].re[e.t]+=parseInt(e.value/2)}},getWhatCanBeBought:function(b,a,c){var d=[],e;for(e in c){var f=c[e];f.isEnabled=this.canBuyIt(b,a,f);d.push(f)}return d}};var rank={isEnemy:function(b,a,c){return b[a].ra[c.o]==gameData.RANKS.enemy?!0:!1},canBeAttacked:function(b,a,c){return b[a].ra[c.o]==gameData.RANKS.enemy||b[a].ra[c.o]==gameData.RANKS.neutral?!0:!1},isAlly:function(b,a,c){return b[a].ra[c.o]==gameData.RANKS.me||b[a].ra[c.o]==gameData.RANKS.ally?!0:!1}};var stats={UPDATE_FREQUENCY:100,init:function(b){for(var a in b.players)b.stats.push({pop:[],killed:0,lost:0,buildingsDestroyed:0,unitsCreated:0,resources:0,buildersCreated:0,buildingsCreated:0})},update:function(b){if(0==b.iterate%this.UPDATE_FREQUENCY)for(var a in b.players)b.stats[a].pop.push(b.players[a].pop.current)},updateField:function(b,a,c,d){b.stats[a][c]+=d}};var tools={getPositionsDistance:function(b,a){return Math.max(Math.abs(b.x-a.x),Math.abs(b.y-a.y))},getElementsDistance:function(b,a){var c=1E4;if(null!=a){var d=gameData.ELEMENTS[a.f][a.r][a.t].shape,e;for(e in d)for(var f in d[e]){var g=this.getPositionsDistance(b.p,this.getPartPosition(a,e,f));g<c&&(c=g);if(1==c)return c}}return c},getClosestPart:function(b,a){var c=1E4,d,e=gameData.ELEMENTS[a.f][a.r][a.t].shape,f;for(f in e)for(var g in e[f]){var h=this.getPositionsDistance(b.p,this.getPartPosition(a,
f,g));h<c&&(c=h,d=this.getPartPosition(a,f,g));if(1==c)return d}return d},getPartPosition:function(b,a,c){var d=null,d=null==b.shape?gameData.ELEMENTS[b.f][b.r][b.t].shape:b.shape;return{x:parseInt(b.p.x+parseInt(a)-parseInt(d[0].length/2)),y:parseInt(b.p.y+parseInt(c)-parseInt(d.length/2))}},getFreeTilesAroundElements:function(b,a){var c=[],d=gameData.ELEMENTS[a.f][a.r][a.t].shape,e;for(e in d)for(var f in d[e])if(0<d[e][f]){var g=this.getPartPosition(a,e,f),g=this.getNeighbors(b.grid,g.x,g.y),h;
for(h in g){var l=g[h];0==b.grid[l.x][l.y].c&&c.push({x:l.x,y:l.y})}}return c},getNeighbors:function(b,a,c){var d=[];b[a-1]&&null!=b[a-1][c]&&d.push({x:a-1,y:c});b[a+1]&&null!=b[a+1][c]&&d.push({x:a+1,y:c});b[a]&&null!=b[a][c-1]&&d.push({x:a,y:c-1});b[a]&&null!=b[a][c+1]&&d.push({x:a,y:c+1});b[a-1]&&null!=b[a-1][c-1]&&d.push({x:a-1,y:c-1});b[a+1]&&null!=b[a+1][c-1]&&d.push({x:a+1,y:c-1});b[a-1]&&null!=b[a-1][c+1]&&d.push({x:a-1,y:c+1});b[a+1]&&null!=b[a+1][c+1]&&d.push({x:a+1,y:c+1});return d},getGameElementsFromIds:function(b,
a){var c=[],d;for(d in a)c.push(b.gameElements[Object.keys(gameData.FAMILIES)[(""+a[d]).charAt(1)]][a[d]]);return c},addUniqueElementToArray:function(b,a){-1==b.indexOf(a)&&b.push(a)},clone:function(b){var a={},c;for(c in b)b.hasOwnProperty(c)&&"a"!=c&&(a[c]=b[c]);return a},getNearestStuff:function(b,a,c,d,e,f){var g=null;if(f){f=1E3;for(var h in b.gameElements[Object.keys(gameData.FAMILIES)[c]]){var l=b.gameElements[Object.keys(gameData.FAMILIES)[c]][h];if(!(null!=d&&l.t!=d||null!=e&&b.players[a.o].ra[l.o]!=
e)&&(k=this.getElementsDistance(a,l),k<f&&(f=k,g=l,5>f)))break}}else{var k=0;do k++,g=tools.searchInTiles(b,this.getTilesAround(b.grid,a.p,k,!1),a,c,d,e);while(null==g&&k<gameData.ELEMENTS[a.f][a.r][a.t].vision)}return g},getTilesAround:function(b,a,c,d){for(var e=[],f=a.x-c;f<=a.x+c;f++)if(null!=b[f])if(d||f==a.x-c||f==a.x+c)for(var g=a.y-c;g<=a.y+c;g++)b[f][g]&&e.push(b[f][g]);else b[f][a.y-c]?e.push(b[f][a.y-c]):b[f][a.y+c]&&e.push(b[f][a.y+c]);return e},searchInTiles:function(b,a,c,d,e,f){for(var g in a)if(0<
a[g].c){var h=b.gameElements[Object.keys(gameData.FAMILIES)[d]][a[g].c];if(null!=h&&h.f==d&&!(null!=e&&h.t!=e||null!=f&&b.players[c.o].ra[h.o]!=f))return h}return null},getElementById:function(b,a){return b.gameElements[Object.keys(gameData.FAMILIES)[(""+a)[1]]][a]},getElementData:function(b){return gameData.ELEMENTS[b.f][b.r][b.t]}};gameData.Building=function(b,a,c,d,e){this.f=gameData.FAMILIES.building;this.id=gameData.createUniqueId(this.f);this.t=b.t;this.o=d;this.r=b.r;this.p={x:a,y:c};this.fl=0;this.cp=e?100:0;this.rp=null;this.q=[];this.fr=this.qp=0;this.l=b.l;this.a=null;this.toJSON=function(){return this}};gameData.Game=function(){this.stats=[];this.players=[];this.grid=[];this.gameElements={land:{},building:{},unit:{}};this.newBuildings=[];this.cancelBuildings=[];this.orders=[];this.modified=[];this.added=[];this.removed=[];this.chat=[];this.iterate=-1;this.update=function(){this.iterate=100<this.iterate?0:this.iterate+1;return gameLogic.update(this)}};gameData.Map=function(b,a,c,d){this.t=b;this.size=a;this.ve=c;this.ir=d};gameData.Order=function(b,a,c,d){this.type=b;this.moveTo=a;this.id=c;this.info=d;this.toJSON=function(){var a=null;null!=this.moveTo&&(a={x:this.moveTo.x,y:this.moveTo.y});return{type:this.type,moveTo:a,id:this.id,info:this.info}}};gameData.Player=function(b,a,c,d){this.pid=b;this.o=a;this.r=c;this.n="";this.re=[];this.ra=[];this.s=gameData.PLAYER_STATUSES.ig;this.tec=[];this.pop={max:0,current:0};this.ai=!1;"undefined"!=typeof d&&d&&(this.ai=!0);for(var e in gameData.BASECAMPS[this.r].buildings)b=gameData.BASECAMPS[this.r].buildings[e],0<b.pop&&(this.pop.max+=b.pop);for(e in gameData.BASECAMPS[this.r].units)b=gameData.BASECAMPS[this.r].units[e],0<b.pop&&(this.pop.current+=b.pop)};gameData.Terrain=function(b,a,c){this.f=gameData.FAMILIES.land;this.id=gameData.createUniqueId(this.f);this.t=b.t;this.r=0;this.p={x:a,y:c};this.ra=b.ra;this.toJSON=function(){return this}};gameData.Unit=function(b,a,c,d){this.f=gameData.FAMILIES.unit;this.id=gameData.createUniqueId(this.f);this.t=b.t;this.r=b.r;this.o=d;this.p={x:a,y:c};this.fl=0;this.a=null;this.pa=[];this.fr=0;this.ga=null;this.l=b.l;this.toJSON=function(){var a=null;null!=this.a&&(a=this.a.toJSON());return{id:this.id,f:this.f,t:this.t,r:this.r,o:this.o,p:{x:this.p.x,y:this.p.y},fl:this.fl,fr:this.fr,ga:this.ga,pa:this.pa,l:this.l,a:a}}};