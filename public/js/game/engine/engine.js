var action={doTheBuild:function(a,b){100>b.constructionProgress?production.updateConstruction(b):a.action=null},doTheAttack:function(a,b){0==gameLoop.iterate%gameData.ELEMENTS[a.family][a.race][a.type].attackSpeed&&fightLogic.attack(a,b)},doTheGathering:function(a,b){0==gameLoop.iterate%gameData.ELEMENTS[a.family][a.race][a.type].gatheringSpeed&&production.gatherResources(a,b)}};var AI={RESOURCE_DISTANCE_THRESHOLD:10,searchForNewResources:function(a,b,c){c=mapLogic.getNearestResource(b,c);tools.getElementsDistance(b,c)<this.RESOURCE_DISTANCE_THRESHOLD?(a.action=c,a.patrol=c):(a.action=null,a.patrol=null)}};var engineManager={createNewGame:function(a,b){for(var c in b){var d=b[c],e;for(e in a.initialResources.resources)d.resources.push(a.initialResources.resources[e].value);for(var f in b)f==c?d.ranks.push(gameData.RANKS.me):d.ranks.push(gameData.RANKS.enemy);gameLogic.players.push(d)}mapLogic.createNewMap(a,b)},startGame:function(){gameLoop.start()},pauseGame:function(){}};var fightLogic={weaponsEfficiency:[[1,1],[1,1]],attack:function(a,b){var c=parseInt(gameData.ELEMENTS[a.family][a.race][a.type].attack*this.weaponsEfficiency[gameData.ELEMENTS[a.family][a.race][a.type].weaponType][gameData.ELEMENTS[b.family][b.race][b.type].armorType]*(1+0.2*Math.random()))-gameData.ELEMENTS[b.family][b.race][b.type].defense;this.applyDamage(c,b,a)},applyDamage:function(a,b,c){b.life-=a;null!=c&&0>=b.life&&(c.frag+=1,c.action=null)}};var gameData={FAMILIES:{unit:0,building:1,terrain:2},ELEMENTS:[[],[],[]],RANKS:{me:0,ally:1,neutral:2,enemy:3},unitId:0,createUniqueId:function(){this.unitId+=10;return(new Date).getMilliseconds()+this.unitId}};var gameLogic={myArmy:0,players:[],gameElements:[],grid:[],update:function(){for(var a in this.gameElements){var b=this.gameElements[a];this.resolveActions(b);this.updateMoves(b);this.updateBuildings(b)}this.updateFogOfWar();this.removeDeads();this.checkGameOver()},updateMoves:function(a){null!=a.moveTo&&null!=a.moveTo.x&&move.moveElement(a)},resolveActions:function(a){if(null!=a.action)if(1>=tools.getElementsDistance(a,a.action))a.moveTo={x:null,y:null},gameData.ELEMENTS[a.family][a.race][a.type].isBuilder&&
a.action.family==gameData.FAMILIES.building&&rank.isAlly(a.action)?100>a.action.constructionProgress?action.doTheBuild(a,a.action):null!=a.gathering&&production.getBackResources(a):gameData.ELEMENTS[a.family][a.race][a.type].isBuilder&&a.action.family==gameData.FAMILIES.terrain?action.doTheGathering(a,a.action):rank.isAlly(a.action)||action.doTheAttack(a,a.action);else{var b=tools.getClosestPart(a,a.action);a.moveTo={x:b.x,y:b.y}}},removeDeads:function(){for(var a=gameLogic.gameElements.length;a--;){var b=
gameLogic.gameElements[a];if(0>=b.life||0==b.resourceAmount)b.family!=gameData.FAMILIES.terrain&&(b.family==gameData.FAMILIES.building?production.removeBuilding(b):b.family==gameData.FAMILIES.unit&&production.removeUnit(b)),this.removeElement(a),mapLogic.removeGameElement(b)}},checkGameOver:function(){},updateBuildings:function(a){a.family==gameData.FAMILIES.building&&0<a.queue.length&&production.updateQueueProgress(a)},updateFogOfWar:function(){},removeElement:function(a){this.gameElements.splice(a,
1)}};var gameLoop={FREQUENCY:20,iterate:0,start:function(){setInterval(function(){gameLoop.update()},1E3/this.FREQUENCY)},update:function(){this.iterate=100<this.iterate?0:this.iterate+1;gameLogic.update()}};var move={moveElement:function(a){for(var b=gameLogic.grid[a.moveTo.x][a.moveTo.y],c=0;b.isWall&&20>c;){c++;var d=astar.neighbors(gameLogic.grid,b,!0),e;for(e in d)if(!d[e].isWall){b=d[e];a.moveTo={x:b.x,y:b.y};break}}b=astar.search(gameLogic.grid,gameLogic.grid[a.position.x][a.position.y],b,!0);if(0<b.length){for(c=gameData.ELEMENTS[a.family][a.race][a.type].speed;c>b.length;)c--;b={x:b[c-1].x,y:b[c-1].y};if(!gameLogic.grid[b.x][b.y].isWall){c=gameData.ELEMENTS[a.family][a.race][a.type].shape;for(e in c)for(var f in c[e])0<
c[e][f]&&(d=tools.getPartPosition(a,e,f),gameLogic.grid[d.x][d.y].isWall=!1);a.position=b;for(e in c)for(f in c[e])0<c[e][f]&&(d=tools.getPartPosition(a,e,f),gameLogic.grid[d.x][d.y].isWall=!0)}a.moveTo.x==a.position.x&&a.moveTo.y==a.position.y&&(a.moveTo={x:null,y:null})}}},astar={init:function(a){for(var b=0,c=a.length;b<c;b++)for(var d=0,e=a[b].length;d<e;d++){var f=a[b][d];f.f=0;f.g=0;f.h=0;f.cost=1;f.visited=!1;f.closed=!1;f.parent=null}},heap:function(){return new BinaryHeap(function(a){return a.f})},
search:function(a,b,c,d,e){astar.init(a);e=e||astar.manhattan;d=!!d;var f=astar.heap();for(f.push(b);0<f.size();){b=f.pop();if(b===c||4<f.size){a=b;for(c=[];a.parent;)c.push(a),a=a.parent;return c.reverse()}b.closed=!0;for(var g=astar.neighbors(a,b,d),h=0,k=g.length;h<k;h++){var j=g[h];if(!j.closed&&!j.isWall){var l=b.g+j.cost,m=j.visited;if(!m||l<j.g)j.visited=!0,j.parent=b,j.h=j.h||e(j,c),j.g=l,j.f=j.g+j.h,m?f.rescoreElement(j):f.push(j)}}}return[]},manhattan:function(a,b){var c=Math.abs(b.x-a.x),
d=Math.abs(b.y-a.y);return c+d},neighbors:function(a,b,c){var d=[],e=b.x;b=b.y;a[e-1]&&a[e-1][b]&&d.push(a[e-1][b]);a[e+1]&&a[e+1][b]&&d.push(a[e+1][b]);a[e]&&a[e][b-1]&&d.push(a[e][b-1]);a[e]&&a[e][b+1]&&d.push(a[e][b+1]);c&&(a[e-1]&&a[e-1][b-1]&&d.push(a[e-1][b-1]),a[e+1]&&a[e+1][b-1]&&d.push(a[e+1][b-1]),a[e-1]&&a[e-1][b+1]&&d.push(a[e-1][b+1]),a[e+1]&&a[e+1][b+1]&&d.push(a[e+1][b+1]));return d}};function BinaryHeap(a){this.content=[];this.scoreFunction=a}
BinaryHeap.prototype={push:function(a){this.content.push(a);this.sinkDown(this.content.length-1)},pop:function(){var a=this.content[0],b=this.content.pop();0<this.content.length&&(this.content[0]=b,this.bubbleUp(0));return a},remove:function(a){for(var b=this.content.length,c=0;c<b;c++)if(this.content[c]==a){var d=this.content.pop();c!=b-1&&(this.content[c]=d,this.scoreFunction(d)<this.scoreFunction(a)?this.sinkDown(c):this.bubbleUp(c));return}throw Error("Node not found.");},size:function(){return this.content.length},
rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},sinkDown:function(a){for(var b=this.content[a];0<a;){var c=Math.floor((a+1)/2)-1,d=this.content[c];if(this.scoreFunction(b)<this.scoreFunction(d))this.content[c]=b,this.content[a]=d,a=c;else break}},bubbleUp:function(a){for(var b=this.content.length,c=this.content[a],d=this.scoreFunction(c);;){var e=2*(a+1),f=e-1,g=null;if(f<b){var h=this.scoreFunction(this.content[f]);h<d&&(g=f)}if(e<b&&this.scoreFunction(this.content[e])<(null==
g?d:h))g=e;if(null!=g)this.content[a]=this.content[g],this.content[g]=c,a=g;else break}}};var order={TYPES:{action:0,buildThatHere:1,buy:2,cancelConstruction:3},dispatchReceivedOrder:function(a,b){switch(a){case 0:this.convertDestinationToOrder(b[0],b[1],b[2]);break;case 1:this.buildThatHere(b[0],b[1],b[2],b[3]);break;case 2:this.buy(b[0],b[1]);break;case 3:this.cancelConstruction(b[0])}},buildThatHere:function(a,b,c,d){a=tools.getGameElementsFromIds(a);b=new gameData.Building(b,c,d,a[0].owner);production.startConstruction(b);this.build(a,b)},buy:function(a,b){var c=tools.getGameElementsFromIds(a);
production.buyElement(c,b)},cancelConstruction:function(a){a=tools.getGameElementsFromIds(a);production.cancelConstruction(a)},updateRallyingPoint:function(a,b,c){for(var d in a){var e=a[d];0<gameData.ELEMENTS[e.family][e.race][e.type].buttons.length&&(e.rallyingPoint={x:b,y:c})}},attack:function(a,b){for(var c in a){var d=a[c];d.patrol=null;d.action=b}},build:function(a,b){for(var c in a){var d=a[c];d.patrol=null;d.action=b}},move:function(a,b,c){for(var d in a){var e=a[d];e.patrol=null;e.action=
null;e.moveTo={x:b,y:c}}},gather:function(a,b){for(var c in a){var d=a[c];d.action=b;d.patrol=b}},convertDestinationToOrder:function(a,b,c){a=tools.getGameElementsFromIds(a);if(!(b>=gameLogic.grid[0].length||c>=gameLogic.grid.length))if(a[0].family==gameData.FAMILIES.building)this.updateRallyingPoint(a,b,c);else{var d=tools.getElementUnder(b,c);if(null!=d)if(d.family==gameData.FAMILIES.unit){if(!rank.isAlly(d)){this.attack(a,d);return}}else{if(d.family==gameData.FAMILIES.building){if(rank.isAlly(d))for(var e in a){var f=
a[e];gameData.ELEMENTS[f.family][f.race][f.type].isBuilder?order.build([f],d):order.move([f],b,c)}else order.attack(a,d);return}if(d.family==gameData.FAMILIES.terrain&&0<=gameData.ELEMENTS[d.family][0][d.type].resourceType){for(e in a)f=a[e],gameData.ELEMENTS[f.family][f.race][f.type].isBuilder?(order.gather([f],d),f.action=d):order.move([f],b,c);return}}order.move(a,b,c)}}};var production={startConstruction:function(a){this.canBuyIt(a.owner,a)&&(this.paysForElement(a.owner,a),mapLogic.addGameElement(a))},updateConstruction:function(a){a.constructionProgress+=100/gameData.ELEMENTS[a.family][a.race][a.type].timeConstruction;a.color=gameData.ELEMENTS[a.family][a.race][a.type].constructionColors[parseInt((gameData.ELEMENTS[a.family][a.race][a.type].constructionColors.length-1)*a.constructionProgress/100)];100<=a.constructionProgress&&this.finishConstruction(a)},cancelConstruction:function(a){100>
a.constructionProgress&&(a.life=0,this.sellsElement(a.owner,a))},finishConstruction:function(a){a.constructionProgress=100;0<gameData.ELEMENTS[a.family][a.race][a.type].population&&(gameLogic.players[a.owner].population.max+=gameData.ELEMENTS[a.family][a.race][a.type].population)},removeBuilding:function(a){0<gameData.ELEMENTS[a.family][a.race][a.type].population&&100==a.constructionProgress&&(gameLogic.players[a.owner].population.max-=gameData.ELEMENTS[a.family][a.race][a.type].population)},gatherResources:function(a,
b){if(null==a.gathering||a.gathering.type!=gameData.ELEMENTS[b.family][b.race][b.type].resourceType)a.gathering={type:gameData.ELEMENTS[b.family][b.race][b.type].resourceType,amount:0};var c=Math.min(gameData.ELEMENTS[a.family][a.race][a.type].maxGathering-a.gathering.amount,5,b.resourceAmount);a.gathering.amount+=c;b.resourceAmount-=c;a.gathering.amount==gameData.ELEMENTS[a.family][a.race][a.type].maxGathering?(c=mapLogic.getNearestBuilding(a,gameData.ELEMENTS[gameData.FAMILIES.building][gameLogic.players[a.owner].race][0].type),
a.action=c):0==b.resourceAmount&&AI.searchForNewResources(a,a,gameData.ELEMENTS[a.patrol.family][a.patrol.race][a.patrol.type].resourceType)},getBackResources:function(a){gameLogic.players[a.owner].resources[a.gathering.type]+=a.gathering.amount;a.gathering=null;null!=a.patrol&&(0==a.patrol.resourceAmount?AI.searchForNewResources(a,a.patrol,gameData.ELEMENTS[a.patrol.family][a.patrol.race][a.patrol.type].resourceType):a.action=a.patrol)},buyElement:function(a,b){for(var c in a){var d=a[c];d.type==
a[0].type&&(100==d.constructionProgress&&5>d.queue.length&&this.canBuyIt(d.owner,b))&&(this.paysForElement(d.owner,b),d.queue.push(b))}},updateQueueProgress:function(a){a.queueProgression+=100/(gameLoop.FREQUENCY*a.queue[0].timeConstruction);if(100<=a.queueProgression){var b=!0;0<a.queue[0].speed&&(b=this.createNewUnit(a.queue[0],a));b?(a.queueProgression=0,a.queue.splice(0,1)):a.queueProgression=100}},createNewUnit:function(a,b){var c=tools.getTilesAroundElements(b),d=gameLogic.players[b.owner].population;
return 0<c.length&&d.current+a.population<=d.max?(c=c[c.length-1],a=new gameData.Unit(a,c.x,c.y,b.owner),gameLogic.players[b.owner].population.current+=gameData.ELEMENTS[a.family][a.race][a.type].population,mapLogic.addGameElement(a),null!=b.rallyingPoint&&order.convertDestinationToOrder([a.id],b.rallyingPoint.x,b.rallyingPoint.y),!0):!1},removeUnit:function(a){0<gameData.ELEMENTS[a.family][a.race][a.type].population&&(gameLogic.players[a.owner].population.current-=gameData.ELEMENTS[a.family][a.race][a.type].population)},
canBuyIt:function(a,b){for(var c in b.needs){var d=b.needs[c];if(d.value>gameLogic.players[a].resources[d.type])return!1}return!0},paysForElement:function(a,b){for(var c in b.needs){var d=b.needs[c];gameLogic.players[a].resources[d.type]-=d.value}},sellsElement:function(a,b){for(var c in b.needs){var d=b.needs[c];gameLogic.players[a].resources[d.type]+=parseInt(d.value/2)}},getWhatCanBeBought:function(a,b){var c=[],d;for(d in b){var e=b[d];e.isEnabled=this.canBuyIt(a,e);c.push(e)}return c}};var rank={isEnemy:function(a){return gameLogic.players[gameLogic.myArmy].ranks[a.owner]==gameData.RANKS.ennemy?!0:!1},isAlly:function(a){return gameLogic.players[gameLogic.myArmy].ranks[a.owner]==gameData.RANKS.me||gameLogic.players[gameLogic.myArmy].ranks[a.owner]==gameData.RANKS.ally?!0:!1}};var tools={getPositionsDistance:function(a,b){return Math.max(Math.abs(a.x-b.x),Math.abs(a.y-b.y))},getElementsDistance:function(a,b){var c=1E4;if(null!=b){var d=gameData.ELEMENTS[b.family][b.race][b.type].shape,e;for(e in d)for(var f in d[e]){var g=this.getPositionsDistance(a.position,this.getPartPosition(b,e,f));g<c&&(c=g);if(1==c)return c}}return c},getClosestPart:function(a,b){var c=1E4,d,e=gameData.ELEMENTS[b.family][b.race][b.type].shape,f;for(f in e)for(var g in e[f]){var h=this.getPositionsDistance(a.position,
this.getPartPosition(b,f,g));h<c&&(c=h,d=this.getPartPosition(b,f,g));if(1==c)return d}return d},getPartPosition:function(a,b,c){var d=null,d=null==a.shape?gameData.ELEMENTS[a.family][a.race][a.type].shape:a.shape;return{x:parseInt(a.position.x+parseInt(b)-parseInt(d[0].length/2)),y:parseInt(a.position.y+parseInt(c)-parseInt(d.length/2))}},isElementThere:function(a,b){var c=gameData.ELEMENTS[a.family][a.race][a.type].shape,d;for(d in c)for(var e in c[d])if(0<c[d][e]){var f=this.getPartPosition(a,
d,e);if(f.x==b.x&&f.y==b.y)return!0}return!1},getTilesAroundElements:function(a){var b=[],c=gameData.ELEMENTS[a.family][a.race][a.type].shape,d;for(d in c)for(var e in c[d])if(0<c[d][e]){var f=this.getPartPosition(a,d,e),f=astar.neighbors(gameLogic.grid,gameLogic.grid[f.x][f.y],!0),g;for(g in f){var h=f[g];h.isWall||b.push({x:h.x,y:h.y})}}return b},getElementUnder:function(a,b){for(var c in gameLogic.gameElements){var d=gameLogic.gameElements[c];if(tools.isElementThere(d,{x:a,y:b}))return d}return null},
getGameElementsFromIds:function(a){var b=[],c;for(c in gameLogic.gameElements){var d=gameLogic.gameElements[c],e;for(e in a)if(d.id==a[e]){b.push(d);if(b.length==a.length)return b;break}}return b}};gameData.RACES={human:0};gameData.RESOURCES={wood:0,gold:1,stone:2};gameData.ELEMENTS[gameData.FAMILIES.unit].push([{name:"builder",race:0,type:0,color:"#00f",shape:[[1]],speed:1,isBuilder:!0,price:10,buttons:[{id:0,color:"#aaa",isEnabled:!0}],timeConstruction:5,life:20,attackSpeed:3,attack:5,defense:0,weaponType:0,armorType:0,gatheringSpeed:2,maxGathering:20,population:1,needs:[{type:gameData.RESOURCES.gold,value:20}]},{name:"swordsman",race:0,type:1,color:"#aaa",shape:[[1]],speed:1,isBuilder:!1,price:30,buttons:[],timeConstruction:10,life:50,attackSpeed:2,attack:10,
defense:2,weaponType:0,armorType:0,population:1,needs:[{type:gameData.RESOURCES.gold,value:50}]},{name:"knight",race:0,type:2,color:"#ccc",shape:[[1,1],[1,1]],speed:2,isBuilder:!1,price:100,buttons:[],timeConstruction:20,life:120,attackSpeed:1,attack:20,defense:5,weaponType:0,armorType:0,population:2,needs:[{type:gameData.RESOURCES.gold,value:100}]}]);gameData.ELEMENTS[gameData.FAMILIES.building].push([{name:"townhall",race:0,type:0,shape:[[1,1,1,1],[1,1,1,1],[1,1,1,1],[1,1,1,1]],timeConstruction:60,constructionColors:["#000","#555","#888","#ccc"],buttons:[gameData.ELEMENTS[gameData.FAMILIES.unit][gameData.RACES.human][0]],needs:[{type:gameData.RESOURCES.wood,value:100},{type:gameData.RESOURCES.stone,value:100}],life:500,defense:3,armorType:1,population:8},{name:"house",race:0,type:1,shape:[[1,1,1],[1,1,1],[1,1,1]],timeConstruction:20,constructionColors:["#000",
"#555","#888","#ccc"],buttons:[],needs:[{type:gameData.RESOURCES.wood,value:50}],life:100,defense:1,armorType:1,population:5},{name:"casern",race:0,type:2,shape:[[1,1,1,1],[1,1,1,1],[1,1,1,1],[0,1,1,0]],timeConstruction:40,constructionColors:["#000","#555","#888","#ccc"],buttons:[gameData.ELEMENTS[gameData.FAMILIES.unit][gameData.RACES.human][1],gameData.ELEMENTS[gameData.FAMILIES.unit][gameData.RACES.human][2]],needs:[{type:gameData.RESOURCES.wood,value:100},{type:gameData.RESOURCES.stone,value:50}],
life:250,defense:2,armorType:1}]);gameData.BASECAMPS=[{buildings:[gameData.ELEMENTS[gameData.FAMILIES.building][gameData.RACES.human][0]],units:[gameData.ELEMENTS[gameData.FAMILIES.unit][gameData.RACES.human][0],gameData.ELEMENTS[gameData.FAMILIES.unit][gameData.RACES.human][0],gameData.ELEMENTS[gameData.FAMILIES.unit][gameData.RACES.human][0]]}];gameData.MAP_TYPES={standard:{id:0,name:"Standard"},random:{id:1,name:"Random"}};
gameData.INITIAL_RESOURCES={low:{name:"Low",resources:[{type:gameData.RESOURCES.wood,value:50},{type:gameData.RESOURCES.gold,value:50},{type:gameData.RESOURCES.stone,value:30}]},standard:{name:"Standard",resources:[{type:gameData.RESOURCES.wood,value:100},{type:gameData.RESOURCES.gold,value:100},{type:gameData.RESOURCES.stone,value:80}]},high:{name:"High",resources:[{type:gameData.RESOURCES.wood,value:250},{type:gameData.RESOURCES.gold,value:250},{type:gameData.RESOURCES.stone,value:100}]}};
gameData.MAP_SIZES={small:{name:"Small",x:80,y:80},medium:{name:"Medium",x:140,y:140},large:{name:"Large",x:200,y:200}};gameData.ZONES={nothing:0,basecamp:1,forest:2,goldmine:3,stonemine:4,water:5};gameData.VEGETATION_TYPES={standard:{name:"Standard",zones:[{type:gameData.ZONES.nothing,factor:20},{type:gameData.ZONES.forest,factor:12},{type:gameData.ZONES.goldmine,factor:1},{type:gameData.ZONES.stonemine,factor:2}]}};gameData.ELEMENTS[gameData.FAMILIES.terrain].push([{name:"tree",type:0,color:"#0f0",shape:[[1]],canMoveIn:!1,resourceType:gameData.RESOURCES.wood,resourceAmount:75},{name:"stone",type:1,color:"#000",shape:[[1,1,1],[1,1,1],[1,1,1]],canMoveIn:!1,resourceType:gameData.RESOURCES.stone,resourceAmount:500},{name:"gold",type:2,color:"#fc1",shape:[[1,1,1],[1,1,1],[1,1,1]],canMoveIn:!1,resourceType:gameData.RESOURCES.gold,resourceAmount:3E3}]);gameData.Building=function(a,b,c,d,e){this.id=gameData.createUniqueId();this.family=gameData.FAMILIES.building;this.type=a.type;this.owner=d;this.race=a.race;this.position={x:b,y:c};this.color=e?a.constructionColors[a.constructionColors.length-1]:a.constructionColors[0];this.canBeBuiltHere=this.selected=!1;this.constructionProgress=e?100:0;this.rallyingPoint=null;this.queue=[];this.queueProgression=0;this.life=a.life};gameData.Map=function(a,b,c,d){this.type=a;this.size=b;this.vegetation=c;this.initialResources=d};gameData.Player=function(a,b){this.owner=a;this.race=b;this.resources=[];this.ranks=[];this.technologies=[];this.population={max:0,current:0};for(var c in gameData.BASECAMPS[this.race].buildings){var d=gameData.BASECAMPS[this.race].buildings[c];0<d.population&&(this.population.max+=d.population)}for(c in gameData.BASECAMPS[this.race].units)d=gameData.BASECAMPS[this.race].units[c],0<d.population&&(this.population.current+=d.population)};gameData.Terrain=function(a,b,c){this.family=gameData.FAMILIES.terrain;this.type=a.type;this.race=0;this.position={x:b,y:c};this.resourceAmount=a.resourceAmount};gameData.Unit=function(a,b,c,d){this.id=gameData.createUniqueId();this.family=gameData.FAMILIES.unit;this.type=a.type;this.race=a.race;this.owner=d;this.position={x:b,y:c};this.moveTo={x:null,y:null};this.isSelected=!1;this.action=null;this.frags=0;this.patrol=this.gathering=null;this.life=a.life};var mapLogic={ZONES_NUMBER:10,PROBABILITY_TREE:0.6,createNewMap:function(a,b){this.initGrid(a.size);a.type.id==gameData.MAP_TYPES.random.id&&this.createRandomMap(a,b)},initGrid:function(a){gameLogic.grid=[];for(var b=0;b<a.x;b++){gameLogic.grid[b]=[];for(var c=0;c<a.y;c++)gameLogic.grid[b][c]={x:b,y:c,isWall:!1}}},createRandomMap:function(a,b){for(var c=parseInt(a.size.x/this.ZONES_NUMBER),d=parseInt(a.size.y/this.ZONES_NUMBER),e=[],f=0;f<this.ZONES_NUMBER;f++){e.push([]);for(var g=0;g<this.ZONES_NUMBER;g++)e[f].push(-10)}this.dispatchPlayers(e,
b,c,d);var h=[];for(f in a.vegetation.zones)for(var g=a.vegetation.zones[f],k=0;k<g.factor;k++)h.push(g.type);for(f=0;f<this.ZONES_NUMBER;f++)for(g=0;g<this.ZONES_NUMBER;g++)0>e[f][g]?this.populateZone({x:f*c+1,y:g*d+1},{x:(f+1)*c-1,y:(g+1)*d-1},h[parseInt(Math.random()*h.length)]):this.populateZone({x:f*c+1,y:g*d+1},{x:(f+1)*c-1,y:(g+1)*d-1},e[f][g])},populateZone:function(a,b,c){switch(c){case gameData.ZONES.forest:this.createForest(a,b);break;case gameData.ZONES.stonemine:this.createStoneMine(a,
b);break;case gameData.ZONES.goldmine:this.createGoldMine(a,b)}},createForest:function(a,b){for(var c=a.x;c<b.x;c++)for(var d=a.y;d<b.y;d++)Math.random()<this.PROBABILITY_TREE&&this.addGameElement(new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.terrain][0][0],c,d))},createStoneMine:function(a,b){for(var c=a.x;c<b.x;c++)for(var d=a.y;d<b.y;d++)if(0.1>Math.random()){this.addGameElement(new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.terrain][0][1],c,d));return}},createGoldMine:function(a,
b){for(var c=a.x;c<b.x;c++)for(var d=a.y;d<b.y;d++)if(0.1>Math.random()){this.addGameElement(new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.terrain][0][2],c,d));return}},addGameElement:function(a){var b=gameData.ELEMENTS[a.family][a.race][a.type].shape;gameLogic.gameElements.push(a);for(var c in b){var d=b[c],e;for(e in d)if(0<d[e]){var f=tools.getPartPosition(a,c,e);gameLogic.grid[f.x][f.y].isWall=!0}}},removeGameElement:function(a){var b=gameData.ELEMENTS[a.family][a.race][a.type].shape,
c;for(c in b){var d=b[c],e;for(e in d)if(0<d[e]){var f=tools.getPartPosition(a,c,e);gameLogic.grid[f.x][f.y].isWall=!1}}},dispatchPlayers:function(a,b,c,d){var e=this.getAvailableInitialPositions(b.length),f;for(f in b){var g=parseInt(e.length*Math.random()),h=e[g],h={x:this.convertCoordinates(a[0].length,h.x),y:this.convertCoordinates(a.length,h.y)};e.splice(g,1);a[h.x][h.y]=gameData.ZONES.basecamp;g={x:h.x*c+parseInt(c/4)+parseInt(Math.random()*c/2),y:h.y*d+parseInt(d/4)+parseInt(Math.random()*
d/2)};this.setupBasecamp(b[f],g);this.placeZoneRandomlyAround(gameData.ZONES.forest,a,h.x,h.y);this.placeZoneRandomlyAround(gameData.ZONES.goldmine,a,h.x,h.y)}},placeZoneRandomlyAround:function(a,b,c,d){for(var e=null,f=null;null==e||1==b[e][f];)e=Math.min(b[0].length-1,Math.max(0,parseInt(c+2*Math.random()-1))),f=Math.min(b.length-1,Math.max(0,parseInt(d+2*Math.random()-1)));b[e][f]=a},setupBasecamp:function(a,b){var c=gameData.BASECAMPS[a.race],d=new gameData.Building(c.buildings[0],b.x,b.y,a.owner,
!0);this.addGameElement(d);var d=tools.getTilesAroundElements(d),e;for(e in c.units)this.addGameElement(new gameData.Unit(c.units[e],d[e].x,d[e].y,a.owner))},getAvailableInitialPositions:function(a){var b=[];if(4!=a)for(var c=[[0,0,0],[0,1,0],[0,0,0]],d=0;d<a;d++){for(var e=null,f=null;null==e||0<c[e][f];)e=parseInt(3*Math.random()),f=parseInt(3*Math.random());c[e][f]=1;b.push({x:e,y:f});3>=a&&(2>e&&(c[e+1][f]=1),0<e&&(c[e-1][f]=1),2>f&&(c[e][f+1]=1),0<f&&(c[e][f-1]=1))}else 0.5>Math.random()?(b.push({x:0,
y:0}),b.push({x:0,y:2}),b.push({x:2,y:0}),b.push({x:2,y:2})):(b.push({x:1,y:0}),b.push({x:1,y:2}),b.push({x:0,y:1}),b.push({x:2,y:1}));return b},convertCoordinates:function(a,b){return 0==b?1:1==b?parseInt(a/2):a-2}};mapLogic.getNearestResource=function(a,b){var c=-1,d=null,e;for(e in gameLogic.gameElements){var f=gameLogic.gameElements[e];if(f.family==gameData.FAMILIES.terrain&&gameData.ELEMENTS[f.family][f.race][f.type].resourceType==b){var g=tools.getElementsDistance(a,f);if(2>g)return f;if(g<c||-1==c)c=g,d=f}}return d};
mapLogic.getNearestBuilding=function(a,b){var c=-1,d=null,e;for(e in gameLogic.gameElements){var f=gameLogic.gameElements[e];if(f.family==gameData.FAMILIES.building&&rank.isAlly(f)&&f.type==b){var g=tools.getElementsDistance(a,f);if(2>g)return f;if(g<c||-1==c)c=g,d=f}}return d};