var gameSurface={},scene,camera;gameSurface.IMG_PATH="js/game/data/g/";gameSurface.MODELS_PATH="js/game/data/g/3D/";gameSurface.PIXEL_BY_NODE=10;gameSurface.NEAR=1;gameSurface.FAR=2E3;gameSurface.ZOOM_MAX=30;gameSurface.ZOOM_MIN=110;gameSurface.ZOOM_STEP=10;gameSurface.ZOOM_ROTATION_STEP=0.1;gameSurface.ORDER_ROTATION_SPEED=0.05;gameSurface.FOG_DENSITY=5E-4;gameSurface.SELECTION_ENEMY_COLOR="#f00";gameSurface.SELECTION_ALLY_COLOR="#0f0";gameSurface.SELECTION_NEUTRAL_COLOR="#e3e314";
gameSurface.CAMERA_INIT_ANGLE=0.7;gameSurface.ORDER_OPACITY=0.7;gameSurface.SELECTION_RECTANGLE_HEIGHT=4*gameSurface.PIXEL_BY_NODE;gameSurface.SELECTION_RECTANGLE_OPACITY=0.5;gameSurface.SELECTION_RECTANGLE_COLOR=0;gameSurface.CAN_BUILD_CUBE_COLOR=65280;gameSurface.CANNOT_BUILD_CUBE_COLOR=16711680;gameSurface.BUILD_CUBE_OPACITY=0.5;gameSurface.MAP_SCROLL_SPEED=10;gameSurface.MAP_SCROLL_X_MIN=0;gameSurface.MAP_SCROLL_Y_MIN=0;gameSurface.CENTER_CAMERA_Y_OFFSET=8*gameSurface.PIXEL_BY_NODE;
gameSurface.BARS_HEIGHT=0.5;gameSurface.BARS_DEPTH=0.2;gameSurface.BUILDING_STRUCTURE_SIZE=5;gameSurface.BUILDING_INIT_Z=-2*gameSurface.PIXEL_BY_NODE;gameSurface.iteration=0;gameSurface.geometries=null;gameSurface.materials=null;gameSurface.terrain=null;gameSurface.scroll=[0,0];gameSurface.isKeyboardScrolling=!1;gameSurface.stuffToBeLoaded=0;gameSurface.loader=null;gameSurface.projector=null;gameSurface.order=null;gameSurface.selectionRectangle=null;gameSurface.canBuildHereMaterial=null;
gameSurface.cannotBuildHereMaterial=null;gameSurface.basicCubeGeometry=null;gameSurface.building=null;
gameSurface.init=function(){function a(){gameSurface.iteration=1E3<gameSurface.iteration?0:gameSurface.iteration+1;requestAnimationFrame(a);gameSurface.updateGameWindow();gameSurface.updateOrderPosition();TWEEN.update();0==gameSurface.iteration%5&&GUI.update();renderer.render(scene,camera)}$("#loadingLabel").html("Loading");scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,this.NEAR,this.FAR);camera.position.x=0;camera.position.y=0;camera.position.z=
this.ZOOM_MIN;camera.rotation.x=this.CAMERA_INIT_ANGLE;scene.fog=new THREE.Fog(16777215,this.FOG_DENSITY,600);renderer=new THREE.WebGLRenderer;renderer.setSize(window.innerWidth-5,window.innerHeight-5);document.body.appendChild(renderer.domElement);this.projector=new THREE.Projector;this.geometries={};this.materials={};this.loader=new THREE.JSONLoader;gameSurface.stuffToBeLoaded+=2;for(var c in gameData.ELEMENTS)for(var b in gameData.ELEMENTS[c])for(var d in gameData.ELEMENTS[c][b])gameSurface.stuffToBeLoaded+=
2;gameSurface.stuffToBeLoaded-=2;this.createScene();this.init3DModels();window.addEventListener("resize",this.onWindowResize,!1);a()};
gameSurface.createScene=function(){var a=new THREE.PointLight(16777215);a.position.x=0;a.position.y=0;a.position.z=150;scene.add(a);var c=[],b=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(this.MODELS_PATH+"skybox.jpg",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})});b.side=THREE.BackSide;for(a=0;6>a;a++)c.push(b);b=new THREE.MeshFaceMaterial(c);a=new THREE.CubeGeometry(2E3,2E3,2E3);a=new THREE.Mesh(a,b);a.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-
5;a.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;scene.add(a);this.terrain=(new TerrainGeneration(gameContent.map.size.x*this.PIXEL_BY_NODE,gameContent.map.size.y*this.PIXEL_BY_NODE,64,10)).diamondSquare();for(var b=new THREE.PlaneGeometry(2200,2200,64,64),d=0,a=0;64>=a;a++)for(c=0;64>=c;c++)d++;a=THREE.ImageUtils.loadTexture(this.MODELS_PATH+"grass.png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()});a.wrapT=a.wrapS=THREE.RepeatWrapping;a=new THREE.MeshBasicMaterial({map:a});
a=new THREE.Mesh(b,a);a.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5;a.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;a.overdraw=!0;scene.add(a);this.order=new THREE.Mesh(new THREE.TorusGeometry(5,2,2,5),new THREE.MeshLambertMaterial({color:16711680,opacity:this.ORDER_OPACITY,transparent:!0}));this.order.visible=!1;scene.add(this.order);a=new THREE.CubeGeometry(this.PIXEL_BY_NODE,this.PIXEL_BY_NODE,this.SELECTION_RECTANGLE_HEIGHT);this.selectionRectangle=new THREE.Mesh(a,new THREE.MeshLambertMaterial({color:this.SELECTION_RECTANGLE_COLOR,
opacity:this.SELECTION_RECTANGLE_OPACITY,transparent:!0}));scene.add(this.selectionRectangle);this.canBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CAN_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:!0});this.cannotBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CANNOT_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:!0});this.basicCubeGeometry=new THREE.CubeGeometry(this.PIXEL_BY_NODE,this.PIXEL_BY_NODE,this.PIXEL_BY_NODE);this.building=new THREE.Object3D;
for(a=0;a<this.BUILDING_STRUCTURE_SIZE;a++)for(c=0;c<this.BUILDING_STRUCTURE_SIZE;c++)b=new THREE.Mesh(this.basicCubeGeometry,this.canBuildHereMaterial),b.position.x=a*this.PIXEL_BY_NODE,b.position.y=c*this.PIXEL_BY_NODE,b.visible=!1,this.building.add(b);this.building.visible=!1;scene.add(this.building)};
gameSurface.init3DModels=function(){for(var a in gameData.ELEMENTS)for(var c in gameData.ELEMENTS[a])for(var b in gameData.ELEMENTS[a][c]){var d=gameData.ELEMENTS[a][c][b];null==this.geometries[d.g]&&(this.geometries[d.g]={},this.loadObject(d.g))}};gameSurface.loadObject=function(a){this.loader.load(this.MODELS_PATH+a,this.geometryLoaded(a));gameSurface.materials[a]=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+a.replace(".js",".png"),new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})})};
gameSurface.geometryLoaded=function(a){return function(c){gameSurface.geometries[a]=c;gameSurface.updateLoadingCounter()}};gameSurface.updateLoadingCounter=function(){gameSurface.stuffToBeLoaded--;0==gameSurface.stuffToBeLoaded&&gameManager.startGame()};
gameSurface.updateGameWindow=function(){camera.position.x+this.scroll[0]>=this.MAP_SCROLL_X_MIN&&camera.position.x+this.scroll[0]<=gameContent.map.size.x*this.PIXEL_BY_NODE?camera.position.x+=this.scroll[0]:this.scroll[0]=0;camera.position.y+this.scroll[1]>=this.MAP_SCROLL_Y_MIN&&camera.position.y+this.scroll[1]<=gameContent.map.size.y*this.PIXEL_BY_NODE?camera.position.y+=this.scroll[1]:this.scroll[1]=0};
gameSurface.updateScrolling=function(a,c,b){this.scroll[a]=c*this.MAP_SCROLL_SPEED;b&&(this.isKeyboardScrolling=0==c?!1:!0)};gameSurface.updateZoom=function(a){var c=camera.position.z-a*this.ZOOM_STEP;c<=this.ZOOM_MIN&&c>=this.ZOOM_MAX&&(camera.position.z=c,camera.rotation.x+=0>a?-this.ZOOM_ROTATION_STEP:this.ZOOM_ROTATION_STEP)};
gameSurface.onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth-5,window.innerHeight-5)};gameSurface.addElement=function(a){this.createObject(gameData.ELEMENTS[a.f][a.r][a.t].g,a)};
gameSurface.createObject=function(a,c){var b=new THREE.Mesh(this.geometries[a],this.materials[a]);b.elementId=c.id;this.setElementPosition(b,c.p.x,c.p.y);"tree.js"==a?(b.rotation.x=this.de2ra(90),b.rotation.y=this.de2ra(360*Math.random())):"castle.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=3,b.scale.y=3,b.scale.z=3):"goldmine.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=1.5,b.scale.y=1.5,b.scale.z=1.5,b.rotation.y=this.de2ra(360*Math.random())):"house.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=
3,b.scale.y=3,b.scale.z=3):"casern.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=2,b.scale.y=2,b.scale.z=2):"peon.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=2,b.scale.y=2,b.scale.z=2):"swordsman.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=2,b.scale.y=2,b.scale.z=2):"bowman.js"==a?(b.rotation.x=this.de2ra(90),b.scale.x=2,b.scale.y=2,b.scale.z=2):"knight.js"==a&&(b.rotation.x=this.de2ra(90),b.scale.x=2,b.scale.y=2,b.scale.z=2);c.f==gameData.FAMILIES.building&&100>c.cp&&(b.position.z+=this.BUILDING_INIT_Z);
scene.add(b);gameContent.gameElements[c.id]={d:b,s:c}};
gameSurface.updateElement=function(a){var c=gameContent.gameElements[a.id].d;a.f==gameData.FAMILIES.unit&&this.updateOrientation(c,a);this.setElementPosition(c,a.p.x,a.p.y);var b=gameData.ELEMENTS[a.f][a.r][a.t];if(a.f==gameData.FAMILIES.building)if(100>a.cp)c.position.z-=(100-a.cp)/20*this.PIXEL_BY_NODE;else if(0<a.q.length){var d=null,e;for(e in c.children)if("prog"==c.children[e].id){d=c.children[e];break}null==d?(d=new THREE.Mesh(new THREE.CubeGeometry(this.BARS_DEPTH,this.BARS_HEIGHT,1),new THREE.MeshBasicMaterial({color:16777215})),
d.id="prog",d.position.x=b.shape.length/3*this.PIXEL_BY_NODE/2,d.position.y=b.height+1,d.rotation.y=this.de2ra(90),c.add(d)):(d.scale.z=a.qp/100*b.shape.length/3*this.PIXEL_BY_NODE,d.position.x=b.shape.length/3*this.PIXEL_BY_NODE/2*(1-a.qp/100),99<=a.qp&&gameContent.players[gameContent.myArmy].pop.current==gameContent.players[gameContent.myArmy].pop.max&&this.showMessage(this.MESSAGES.popLimitReached))}else for(e in c.children)"prog"==c.children[e].id&&c.remove(c.children[e]);if(a.f!=gameData.FAMILIES.terrain)for(e in c.children)if("life"==
c.children[e].id){this.updateLifeBar(c.children[e],a,b);break}gameContent.gameElements[a.id]={d:c,s:a}};gameSurface.removeElement=function(a){scene.remove(gameContent.gameElements[a.id].d);0<=gameContent.selected.indexOf(a.id)&&gameContent.selected.splice(gameContent.selected.indexOf(a.id),1);delete gameContent.gameElements[a.id]};gameSurface.getAbsolutePositionFromPixel=function(a,c){var b=this.getFirstIntersectObject(a,c);return null!=b?this.convertScenePositionToGamePosition(b.point):{x:0,y:0}};
gameSurface.getFirstIntersectObject=function(a,c){var b=new THREE.Vector3(2*(a/window.innerWidth)-1,2*-(c/window.innerHeight)+1,0.5);this.projector.unprojectVector(b,camera);b=(new THREE.Raycaster(camera.position,b.sub(camera.position).normalize())).intersectObjects(scene.children);return 0<b.length?b[0]:null};
TerrainGeneration=function(a,c,b,d){this.width=a;this.height=c;this.segments=b;this.smoothingFactor=d;this.terrain=[];this._init=function(){this.terrain=[];for(var a=0;a<=this.segments;a++){this.terrain[a]=[];for(var b=0;b<=this.segments;b++)this.terrain[a][b]=0}};this.diamondSquare=function(){this._init();for(var a=this.segments+1,b=this.segments;2<=b;b/=2){var c=b/2;this.smoothingFactor/=2;for(var d=0;d<this.segments;d+=b)for(var f=0;f<this.segments;f+=b){var h=this.terrain[d][f]+this.terrain[d+
b][f]+this.terrain[d][f+b]+this.terrain[d+b][f+b],h=h/4,h=h+(2*this.smoothingFactor*Math.random()-this.smoothingFactor);this.terrain[d+c][f+c]=h}for(d=0;d<this.segments;d+=c)for(f=(d+c)%b;f<this.segments;f+=b)h=this.terrain[(d-c+a)%a][f]+this.terrain[(d+c)%a][f]+this.terrain[d][(f+c)%a]+this.terrain[d][(f-c+a)%a],h/=4,h+=2*this.smoothingFactor*Math.random()-this.smoothingFactor,this.terrain[d][f]=h,0===d&&(this.terrain[this.segments][f]=h),0===f&&(this.terrain[d][this.segments]=h)}return this.terrain}};
gameSurface.centerCameraOnElement=function(a){a=this.convertGamePositionToScenePosition(a.p);camera.position.x=a.x;camera.position.y=a.y-this.CENTER_CAMERA_Y_OFFSET};gameSurface.setElementPosition=function(a,c,b){var d=this.convertGamePositionToScenePosition({x:c,y:b});a.position.x=d.x;a.position.y=d.y;c=this.terrain[parseInt(65*c/gameContent.map.size.x)][parseInt(65*b/gameContent.map.size.y)];a.position.z=Math.abs(c)};gameSurface.convertGamePositionToScenePosition=function(a){return{x:a.x*this.PIXEL_BY_NODE,y:a.y*this.PIXEL_BY_NODE,z:0}};
gameSurface.convertScenePositionToGamePosition=function(a){return{x:Math.min(gameContent.map.size.x-2,Math.max(0,parseInt(a.x/this.PIXEL_BY_NODE))),y:Math.min(gameContent.map.size.y-2,Math.max(0,parseInt(a.y/this.PIXEL_BY_NODE)))}};gameSurface.drawSelectionCircle=function(a,c){for(var b=new THREE.MeshBasicMaterial({color:c}),d=new THREE.Geometry,e=0;100>=e;e++){var g=3.6*e*Math.PI/180;d.vertices.push(new THREE.Vector3(Math.cos(g)*a,0,Math.sin(g)*a))}b=new THREE.Line(d,b);b.id="select";return b};
gameSurface.drawLifeBar=function(a,c){var b=new THREE.Mesh(new THREE.CubeGeometry(this.BARS_DEPTH,this.BARS_HEIGHT,1),new THREE.MeshBasicMaterial({color:16777215}));b.id="life";b.position.x=0;b.position.y=c.height;b.rotation.y=this.de2ra(90);this.updateLifeBar(b,a,c);return b};gameSurface.updateLifeBar=function(a,c,b){var d=c.l/b.l;a.scale.z=b.shape.length/3*this.PIXEL_BY_NODE*c.l/b.l;a.material.color.setHex(this.getLifeBarColor(d))};
gameSurface.updateOrderPosition=function(){if(0<gameContent.selected.length&&(null!=gameContent.gameElements[gameContent.selected[0]].s.mt&&null!=gameContent.gameElements[gameContent.selected[0]].s.mt.x||null!=gameContent.gameElements[gameContent.selected[0]].s.rp||null!=gameContent.gameElements[gameContent.selected[0]].s.a)){var a;a=null!=gameContent.gameElements[gameContent.selected[0]].s.a?gameContent.gameElements[gameContent.selected[0]].s.a.p:null!=gameContent.gameElements[gameContent.selected[0]].s.rp?
gameContent.gameElements[gameContent.selected[0]].s.rp:gameContent.gameElements[gameContent.selected[0]].s.mt;this.setElementPosition(this.order,a.x,a.y);this.order.rotation.z+=this.ORDER_ROTATION_SPEED;this.order.visible=!0}else this.order.visible&&(this.order.visible=!1)};
gameSurface.updateSelectionRectangle=function(a,c,b,d){var e=Math.abs(a-b),g=Math.abs(c-d);0<e&&0<g?(a={x:Math.min(a,b)+e/2+1,y:Math.min(c,d)+g/2},this.selectionRectangle.position=this.convertGamePositionToScenePosition(a),this.selectionRectangle.scale.x=e,this.selectionRectangle.scale.y=g,this.selectionRectangle.visible=!0):this.selectionRectangle.visible=!1};gameSurface.de2ra=function(a){return a*(Math.PI/180)};
gameSurface.selectElement=function(a){var c=gameContent.gameElements[a].s,b=gameData.ELEMENTS[c.f][c.r][c.t],d;d=rank.isEnemy(gameContent.players,gameContent.myArmy,c)?this.SELECTION_ENEMY_COLOR:rank.isAlly(gameContent.players,gameContent.myArmy,c)?this.SELECTION_ALLY_COLOR:this.SELECTION_NEUTRAL_COLOR;gameContent.gameElements[a].d.add(this.drawSelectionCircle(b.shape.length/2*this.PIXEL_BY_NODE/2,d));c.f!=gameData.FAMILIES.terrain&&gameContent.gameElements[a].d.add(this.drawLifeBar(c,b))};
gameSurface.unselectElement=function(a){try{for(var c=gameContent.gameElements[a].d,b=c.children.length;b--;){var d=c.children[b];("select"==d.id||"life"==d.id)&&c.remove(d)}}catch(e){}};gameSurface.unselectAll=function(){for(var a in gameContent.selected)this.unselectElement(gameContent.selected[a])};
gameSurface.updateOrientation=function(a,c){var b=gameContent.gameElements[c.id].s,d=c.p.x-b.p.x,b=c.p.y-b.p.y;0==d&&0>b||(0<d&&0>b?a.rotation.y=this.de2ra(-45):0<d&&0==b?a.rotation.y=this.de2ra(-90):0<d&&0<b?a.rotation.y=this.de2ra(-135):0==d&&0<b?a.rotation.y=this.de2ra(-180):0>d&&0>b?a.rotation.y=this.de2ra(-225):0>d&&0==b?a.rotation.y=this.de2ra(-270):0>d&&0>b&&(a.rotation.y=this.de2ra(-315)))};
gameSurface.updateBuildingGeometry=function(){for(var a in this.building.children)this.building.children[a].visible=!1;var c=gameContent.building.shape;for(a in c)for(var b in c){var d;if(c[a][b]==userInput.CAN_BE_BUILT_HERE)d=this.canBuildHereMaterial;else if(c[a][b]==userInput.CANNOT_BE_BUILT_HERE)d=this.cannotBuildHereMaterial;else continue;var e=a*this.BUILDING_STRUCTURE_SIZE+parseInt(b);this.building.children[e].material=d;this.building.children[e].visible=!0}this.setElementPosition(this.building,
gameContent.building.p.x-parseInt(c.length/2),gameContent.building.p.y-parseInt(c.length/2));this.building.visible=!0};gameSurface.removeBuildingGeometry=function(){for(var a in this.building.children)this.building.children[a].visible=!1;this.building.visible=!1};
gameSurface.animateSelectionCircle=function(a){this.selectElement(a);var c=gameContent.gameElements[a].d,b,d;for(d in c.children)if("select"==c.children[d].id){b=c.children[d];break}c=(new TWEEN.Tween({alpha:1})).delay(300).to({alpha:0},300).onComplete(function(){b.visible=!1}).start();d=(new TWEEN.Tween({alpha:0})).to({alpha:1},300).onComplete(function(){b.visible=!0});var e=(new TWEEN.Tween({alpha:0})).to({alpha:1},500).onComplete(function(){gameSurface.unselectElement(a)});c.chain(d);d.chain(e)};
gameSurface.getLifeBarColor=function(a){return 0.3>a?16711680:0.6>a?6749952:65280};gameSurface.MESSAGES={popLimitReached:{id:0,text:"You need more houses"}};
gameSurface.showMessage=function(a){if(0==$("#message"+a.id).length){$("#messages").append('<div id="message'+a.id+'" class="fadeOut easeTransition">'+a.text+"</div>");var c=(new TWEEN.Tween({alpha:0})).to({alpha:1},100).onComplete(function(){$("#message"+a.id).removeClass("fadeOut")}).start(),b=(new TWEEN.Tween({alpha:0})).to({alpha:1},8E3).onComplete(function(){$("#message"+a.id).addClass("fadeOut")}),d=(new TWEEN.Tween({alpha:0})).to({alpha:1},500).onComplete(function(){$("#message"+a.id).remove()});
c.chain(b);b.chain(d)}};var GUI={toolbar:[],BUTTONS_SIZE:80,TOOLBAR_BUTTONS:{build:{buttonId:1E3,image:"build.png",isEnabled:!0,name:"Build"},cancel:{buttonId:1001,image:"cancel.png",isEnabled:!0,name:"Cancel"}},MOUSE_ICONS:{standard:'url("js/game/data/g/cursor.png"), auto',select:'url("js/game/data/g/cursor_hover.png"), auto',attack:'url("js/game/data/g/cursor_attack.png"), auto',arrowTop:"n-resize",arrowTopRight:"ne-resize",arrowTopLeft:"nw-resize",arrowBottom:"s-resize",arrowBottomRight:"se-resize",arrowBottomLeft:"sw-resize",
arrowRight:"e-resize",arrowLeft:"w-resize"},showBuildings:!1,init:function(){this.createResourcesBar();this.initInfobar();this.initMinimap()},update:function(){this.updatePopulation();this.updateResources();this.updateToolbar();this.updateInfo();this.updateMinimap()},updateToolbar:function(){if(0<gameContent.selected.length&&rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)){var a=gameContent.gameElements[gameContent.selected[0]].s;a.f==gameData.FAMILIES.building?
this.toolbar=100>a.cp?[GUI.TOOLBAR_BUTTONS.cancel]:production.getWhatCanBeBought(gameContent.players,a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r][a.t].buttons):a.f==gameData.FAMILIES.unit&&(this.toolbar=this.showBuildings?this.getBuildingButtons(a):gameData.ELEMENTS[gameData.FAMILIES.unit][a.r][a.t].buttons)}else this.toolbar=[];$("#toolbar .toolbarButton").addClass("hide");for(var c in this.toolbar)this.createToolbarButton(this.toolbar[c])},getBuildingButtons:function(a){return production.getWhatCanBeBought(gameContent.players,
a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r])},updateMouse:function(a){document.body.style.cursor=a},createResourcesBar:function(){for(var a in gameData.RESOURCES)this.createResourceElement(gameData.RESOURCES[a])},createResourceElement:function(a){a='<div id="resource'+a.id+'"><div class="spriteBefore sprite-'+a.name+'">0</div></div>';$("#resources").append(a)},updateResources:function(){var a=gameContent.players[gameContent.myArmy],c;for(c in gameData.RESOURCES){var b=gameData.RESOURCES[c];
$("div","#resource"+b.id).html(a.re[b.id])}},createToolbarButton:function(a){if(null!=$("#toolbar"+a.buttonId).html())$("#toolbar"+a.buttonId).removeClass("hide");else{var c='<div id="toolbar'+a.buttonId+'" class="toolbarButton sprite sprite-boxNormal" title="'+a.name+'"><div class="sprite sprite-'+a.image.replace(".png","")+'"></div></div>';$("#toolbar").append(c);for(var b in a.needs){var c=a.needs[b],d;for(d in gameData.RESOURCES)if(gameData.RESOURCES[d].id==c.t){var e=(this.toolbar.length-1)*
GUI.BUTTONS_SIZE-$("#toolbar"+a.buttonId).position().top+20*b+10;$("#toolbar"+a.buttonId).append('<div class="price" style="bottom: '+e+'px"><div class="spriteBefore sprite-'+gameData.RESOURCES[d].image.replace(".png","")+'15" />'+c.value+"</div></div>");break}}}a.isEnabled?$("#toolbar"+a.buttonId).removeClass("disabled"):$("#toolbar"+a.buttonId).addClass("disabled")},updatePopulation:function(){var a=gameContent.players[gameContent.myArmy];$("div","#population").html(a.pop.current+" / "+a.pop.max)},
selectButton:function(a){this.unselectButtons();$("#toolbar"+a.buttonId).addClass("sprite-boxSelect")},unselectButtons:function(){$(".toolbarButton").removeClass("sprite-boxSelect")},initInfobar:function(){$("#info").css("left",(window.innerWidth-$("#info").width())/2)},updateInfo:function(){if(0<gameContent.selected.length){var a=gameContent.gameElements[gameContent.selected[0]].s,c=gameData.ELEMENTS[a.f][a.r][a.t];$("#name").html(c.name);$("#portrait").attr("class","sprite sprite-"+c.image.replace(".png",
""));$("#stats").html("");if(a.f==gameData.FAMILIES.terrain){$("#life").html("&infin; / &infin;");for(var b in gameData.RESOURCES)if(gameData.RESOURCES[b].id==c.resourceType){this.addStatLine(gameData.RESOURCES[b].image,a.ra,"Amount of resources left");break}}else if($("#life").html(a.l+"/"+c.l),a.f==gameData.FAMILIES.building)for(b in GUI.addStatLine("defense",c.defense,"Defense"),GUI.addStatLine("pop20",c.pop,"Max Population Bonus"),a.q)c=gameData.ELEMENTS[gameData.FAMILIES.unit][a.r][a.q[b]],0==
b?GUI.addQueue(c.image,parseInt(a.qp)+"%",c.name):GUI.addQueue(c.image,"",c.name);else GUI.addStatLine("attack",c.attack,"Attack"),GUI.addStatLine("defense",c.defense,"Defense"),GUI.addStatLine("attackSpeed",c.attackSpeed,"Attack Speed"),GUI.addStatLine("range",c.range,"Range");$("#info").removeClass("hide")}else $("#info").hasClass("hide")||$("#info").addClass("hide")},addStatLine:function(a,c,b){$("#stats").append('<div class="stat" title="'+b+'"><div class="spriteBefore sprite-'+a+'">'+c+"</div></div>")},
addQueue:function(a,c,b){$("#stats").append('<div class="queue" title="'+b+'"><div id="queueProgress">'+c+'</div><div class="sprite sprite-'+a.replace(".png","")+'15"></div></div>')},initMinimap:function(){$("#minimap").click(function(a){if("IMG"!=a.target.nodeName){var c=1-a.offsetY/80;camera.position.x=a.offsetX/80*gameContent.map.size.x*gameSurface.PIXEL_BY_NODE;camera.position.y=c*gameContent.map.size.y*gameSurface.PIXEL_BY_NODE}})},updateMinimap:function(){$("#minimapLocation").css("left",64*
camera.position.x/(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE));$("#minimapLocation").css("top",60*(1-camera.position.y/(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE)))}};var gameManager={isOfflineGame:!0,offlineLoop:null,initGame:function(a){this.getPlayerId();this.isOfflineGame?this.initOfflineGame(a):this.connectToServer(a)},startGame:function(){$("#gui").removeClass("hide");$("#introScreen").addClass("hide");gameContent.init(this.waitingData);this.isOfflineGame&&(this.offlineLoop=setInterval(function(){gameContent.update(gameContent.game.update())},125))},initOfflineGame:function(a){gameContent.myArmy=0;gameContent.players=[new gameData.Player(0,0,a.army),new gameData.Player(0,
1,0)];gameContent.map=new gameData.Map(gameData.MAP_TYPES[a.mapType],gameData.MAP_SIZES[a.mapSize],gameData.VEGETATION_TYPES[a.vegetation],gameData.INITIAL_RESOURCES[a.initialResources]);gameContent.game=gameCreation.createNewGame(gameContent.map,gameContent.players);this.waitingData=gameContent.game.gameElements;gameSurface.init();GUI.init();input.initInputs()},connectToServer:function(a){gameManager.socket=io.connect("http://localhost:6969");this.socket.on("askUserData",function(){var c={};c.playerId=
gameManager.playerId;c.gameInitData=a;gameManager.socket.emit("userData",c)});this.socket.on("gameStart",function(a){gameContent.players=a.players;gameContent.myArmy=a.myArmy;gameContent.map=a.map;gameManager.waitingData=a.initElements;gameSurface.init();GUI.init();input.initInputs()});this.socket.on("gameData",function(a){gameContent.update(a)});this.socket.on("gameStats",function(a){gameManager.showStats(a)})},createPlayerId:function(){var a=(new Date).getTime()+Math.random();utils.createCookie("rts_player_id",
a);return a},getPlayerId:function(){var a=utils.readCookie("rts_player_id");null==a&&(a=this.createPlayerId());this.playerId=a},sendOrderToEngine:function(a,c){this.isOfflineGame?order.dispatchReceivedOrder(gameContent.game,a,c):gameManager.socket.emit("order",[a,c])},endGame:function(a){a==gameData.PLAYER_STATUSES.victory?($("#endGameMessage").addClass("victory"),$("#endGameMessage").html("Victory !")):($("#endGameMessage").addClass("defeat"),$("#endGameMessage").html("Defeat..."));$("#endGame").fadeIn();
$("#endGameMessage").addClass("moveToLeft");this.isOfflineGame&&(clearInterval(this.offlineLoop),this.showStats(gameContent.game.stats))},showStats:function(a){$("table","#endGameStats").css("width",window.innerWidth-60);for(var c in a){var b=a[c],d;d=c==gameContent.myArmy?"You":"Player "+c;$("#tableBody").append('<tr class="black"><td>'+d+"</td><td>"+b.killed+"</td><td>"+b.lost+"</td><td>"+b.buildingsDestroyed+"</td><td>"+b.unitsCreated+"</td><td>"+b.resources+"</td><td>"+b.buildersCreated+"</td><td>"+
b.buildingsCreated+"</td></tr>")}}};var gameContent={map:null,players:null,myArmy:null,game:null,gameElements:{},selected:[],building:null,selectionRectangle:[],init:function(a){for(var c in a){var b=a[c];gameSurface.addElement(b);b.f==gameData.FAMILIES.building&&b.o==this.myArmy&&gameSurface.centerCameraOnElement(b)}},update:function(a){for(var c in a.added){var b=a.added[c];null==this.gameElements[b.id]&&gameSurface.addElement(b)}for(c in a.removed)if(b=a.removed[c],null!=this.gameElements[b.id]){var d=this.selected.indexOf(b.id);
0<=d&&this.selected.splice(d,1);gameSurface.removeElement(b)}for(c in a.modified)b=a.modified[c],null!=this.gameElements[b.id]&&gameSurface.updateElement(b);this.players=a.players;(this.players[this.myArmy].s==gameData.PLAYER_STATUSES.victory||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.defeat)&&gameManager.endGame(this.players[this.myArmy].s)}};var utils={readCookie:function(a){a+="=";for(var c=document.cookie.split(";"),b=0;b<c.length;b++){for(var d=c[b];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null},createCookie:function(a,c){document.cookie=a+"="+c+"; path=/"},canBeBuiltHere:function(a){var c=tools.getPartPosition(a,0,0),b=c.x+a.shape[0].length-1,d=c.y+a.shape.length-1,e;for(e in gameContent.gameElements){var g=gameContent.gameElements[e].s,j=gameData.ELEMENTS[g.f][g.r][g.t].shape,
g=tools.getPartPosition(g,0,0),k=g.x+j[0].length-1,j=g.y+j.length-1;if(g.x>=c.x&&g.x<=b&&(g.y>=c.y&&g.y<=d||j>=c.y&&j<=d)||k>=c.x&&k<=b&&(g.y>=c.y&&g.y<=d||j>=c.y&&j<=d)){a.canBeBuiltHere=!1;for(var f=g.x;f<=k;f++)for(var h=g.y;h<=j;h++)f>=c.x&&(f<=b&&h>=c.y&&h<=d)&&(a.shape[f-c.x][h-c.y]=userInput.CANNOT_BE_BUILT_HERE)}}}};var inputDispatcher={TOOLBAR_KEYBOARD_SHORTCUTS:[81,87,69,82,65,83,68,70],onLeftClick:function(a){if(1==a.which){var c=a.x;a=a.y;if(0<GUI.toolbar.length&&c<GUI.BUTTONS_SIZE+10&&10<c&&a<window.innerHeight-10&&a>window.innerHeight-10-GUI.BUTTONS_SIZE*GUI.toolbar.length)return userInput.clickOnToolbar(GUI.toolbar[parseInt(GUI.toolbar.length-(window.innerHeight-a-10)/GUI.BUTTONS_SIZE)]),!1;if(null!=gameContent.building)return userInput.tryBuildHere(),!1;userInput.clickToSelect(c,a);return!0}},onDoubleClick:function(a){1==
a.which&&userInput.doubleClickToSelect(a.x,a.y);return!1},onRightClick:function(a){null!=gameContent.building?userInput.leaveConstructionMode():0<gameContent.selected.length&&(rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)&&(gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.unit||gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.building))&&userInput.dispatchUnitAction(a.x,a.y);return!1},onMouseMove:function(a){userInput.selectGroup(a.x,
a.y);userInput.updateConstructionMode(a.x,a.y)},onMouseUp:function(){userInput.removeSelectionRectangle()},onMouseWheel:function(a){0<Math.abs(a.wheelDelta)&&userInput.changeZoom(a.wheelDelta/Math.abs(a.wheelDelta));return!1},onKeyDown:function(a){a=window.event?a.which:a.keyCode;switch(a){case 38:return gameSurface.updateScrolling(1,1,!0),!0;case 40:return gameSurface.updateScrolling(1,-1,!0),!0;case 39:return gameSurface.updateScrolling(0,1,!0),!0;case 37:return gameSurface.updateScrolling(0,-1,
!0),!0}for(var c in inputDispatcher.TOOLBAR_KEYBOARD_SHORTCUTS)if(inputDispatcher.TOOLBAR_KEYBOARD_SHORTCUTS[c]==a)return userInput.pressToolbarShortcut(c),!1;return!0},onKeyUp:function(a){switch(window.event?a.which:a.keyCode){case 38:return gameSurface.updateScrolling(1,0,!0),!1;case 40:return gameSurface.updateScrolling(1,0,!0),!1;case 39:return gameSurface.updateScrolling(0,0,!0),!1;case 37:return gameSurface.updateScrolling(0,0,!0),!1}}};var input={initInputs:function(){this.initMouse();this.initKeyboard()},mousePosition:{x:0,y:0},initMouse:function(){document.onmousedown=function(a){return inputDispatcher.onLeftClick(a)};document.oncontextmenu=function(a){return inputDispatcher.onRightClick(a)};document.onmousemove=function(a){userInput.checkIfMapScrolling(a.x,a.y);userInput.updateMouseIcon(a.x,a.y);if(3<Math.abs(a.x-input.mousePosition.x)+Math.abs(a.y-input.mousePosition.y))inputDispatcher.onMouseMove(a);input.mousePosition.x=a.x;
input.mousePosition.y=a.y;return!1};document.onmouseup=function(a){return inputDispatcher.onMouseUp(a)};document.onmousewheel=function(a){return inputDispatcher.onMouseWheel(a)};document.ondblclick=function(a){return inputDispatcher.onDoubleClick(a)}},initKeyboard:function(){document.onkeydown=function(a){return inputDispatcher.onKeyDown(a)};document.onkeyup=function(a){return inputDispatcher.onKeyUp(a)}}};var userInput={CAN_BE_BUILT_HERE:10,CANNOT_BE_BUILT_HERE:1,clickOnToolbar:function(a){a.isEnabled&&(a.buttonId==GUI.TOOLBAR_BUTTONS.build.buttonId?GUI.showBuildings=!0:GUI.showBuildings&&a.isEnabled?this.enterConstructionMode(a):a.buttonId==GUI.TOOLBAR_BUTTONS.cancel.buttonId?gameManager.sendOrderToEngine(order.TYPES.cancelConstruction,[gameContent.gameElements[gameContent.selected[0]].s.id]):gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.building&&gameManager.sendOrderToEngine(order.TYPES.buy,
[gameContent.selected,a]))},enterConstructionMode:function(a){gameContent.building=a;GUI.selectButton(a);this.updateConstructionMode(input.mousePosition.x,input.mousePosition.y)},updateConstructionMode:function(a,c){if(null!=gameContent.building){gameContent.building.p=gameSurface.getAbsolutePositionFromPixel(a,c);gameContent.building.canBeBuiltHere=!0;for(var b in gameContent.building.shape)for(var d in gameContent.building.shape[b])gameContent.building.shape[b][d]=this.CAN_BE_BUILT_HERE;utils.canBeBuiltHere(gameContent.building);
gameSurface.updateBuildingGeometry()}},leaveConstructionMode:function(){gameContent.building=null;gameSurface.removeBuildingGeometry();GUI.unselectButtons();GUI.showBuildings=!1},changeZoom:function(a){gameSurface.updateZoom(a)},pressToolbarShortcut:function(a){a<GUI.toolbar.length&&this.clickOnToolbar(GUI.toolbar[a])},updateMouseIcon:function(a,c){var b=gameSurface.getFirstIntersectObject(a,c),d=gameSurface.scroll[0],e=gameSurface.scroll[1];null!=b&&null!=b.object.elementId?(b=gameContent.gameElements[b.object.elementId].s,
null!=b&&b.f!=gameData.FAMILIES.terrain&&rank.isEnemy(gameContent.players,gameContent.myArmy,b)?GUI.updateMouse(GUI.MOUSE_ICONS.attack):GUI.updateMouse(GUI.MOUSE_ICONS.select)):gameSurface.isKeyboardScrolling||(0<d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopRight):0<d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowRight):0<d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomRight):0>d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopLeft):0>d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowLeft):0>d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomLeft):
0==d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTop):0==d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottom):GUI.updateMouse(GUI.MOUSE_ICONS.standard))},SCROLL_THRESHOLD:10,checkIfMapScrolling:function(a,c){a<this.SCROLL_THRESHOLD?gameSurface.updateScrolling(0,-1,!1):a>window.innerWidth-this.SCROLL_THRESHOLD?gameSurface.updateScrolling(0,1,!1):!gameSurface.isKeyboardScrolling&&0!=gameSurface.scroll[0]&&gameSurface.updateScrolling(0,0,!1);c<this.SCROLL_THRESHOLD?gameSurface.updateScrolling(1,1,!1):c>
window.innerHeight-this.SCROLL_THRESHOLD?gameSurface.updateScrolling(1,-1,!1):!gameSurface.isKeyboardScrolling&&0!=gameSurface.scroll[1]&&gameSurface.updateScrolling(1,0,!1)},tryBuildHere:function(){gameContent.building.canBeBuiltHere&&(gameManager.sendOrderToEngine(order.TYPES.buildThatHere,[gameContent.selected,gameContent.building,gameContent.building.p.x,gameContent.building.p.y]),this.leaveConstructionMode())},dispatchUnitAction:function(a,c){var b,d=gameSurface.getFirstIntersectObject(a,c);
null!=d&&(null!=d.object.elementId?(b=gameContent.gameElements[d.object.elementId].s.p,gameSurface.animateSelectionCircle(d.object.elementId)):b={x:parseInt(d.point.x/gameSurface.PIXEL_BY_NODE),y:parseInt(d.point.y/gameSurface.PIXEL_BY_NODE)},0<=b.x&&(0<=b.y&&b.x<gameContent.map.size.x&&b.y<gameContent.map.size.y)&&gameManager.sendOrderToEngine(order.TYPES.action,[gameContent.selected,b.x,b.y]))}};userInput.SELECTION_RECTANGLE_THRESHOLD=8;
userInput.clickToSelect=function(a,c){if(!(a>window.innerWidth-85&&c>window.innerHeight-85)){this.leaveConstructionMode();gameSurface.unselectAll();gameContent.selected=[];gameContent.selectionRectangle=[];var b=gameSurface.getFirstIntersectObject(a,c);null!=b&&(null!=b.object.elementId&&(gameContent.selected.push(b.object.elementId),gameSurface.selectElement(b.object.elementId)),gameContent.selectionRectangle[0]=parseInt(b.point.x/gameSurface.PIXEL_BY_NODE),gameContent.selectionRectangle[1]=parseInt(b.point.y/
gameSurface.PIXEL_BY_NODE),gameSurface.updateSelectionRectangle(-1,-1,-1,-1))}};
userInput.selectGroup=function(a,c){if(0<gameContent.selectionRectangle.length&&Math.abs(a-gameContent.selectionRectangle[0])>this.SELECTION_RECTANGLE_THRESHOLD&&Math.abs(c-gameContent.selectionRectangle[1])>this.SELECTION_RECTANGLE_THRESHOLD){gameSurface.unselectAll();gameContent.selected=[];var b=!1,d=gameSurface.getAbsolutePositionFromPixel(a,c);if(!(0>d.x||0>d.y)){gameContent.selectionRectangle[2]=d.x;gameContent.selectionRectangle[3]=d.y;gameSurface.updateSelectionRectangle(gameContent.selectionRectangle[0],
gameContent.selectionRectangle[1],gameContent.selectionRectangle[2],gameContent.selectionRectangle[3]);for(var e in gameContent.gameElements)if(d=gameContent.gameElements[e].s,rank.isAlly(gameContent.players,gameContent.myArmy,d)&&d.f!=gameData.FAMILIES.terrain&&(0>gameContent.selectionRectangle[0]-gameContent.selectionRectangle[2]&&d.p.x<=gameContent.selectionRectangle[2]&&d.p.x>=gameContent.selectionRectangle[0]||d.p.x>=gameContent.selectionRectangle[2]&&d.p.x<=gameContent.selectionRectangle[0])&&
(0>gameContent.selectionRectangle[1]-gameContent.selectionRectangle[3]&&d.p.y<=gameContent.selectionRectangle[3]&&d.p.y>=gameContent.selectionRectangle[1]||d.p.y>=gameContent.selectionRectangle[3]&&d.p.y<=gameContent.selectionRectangle[1]))gameContent.selected.push(d.id),gameSurface.selectElement(d.id),d.f==gameData.FAMILIES.unit&&(b=!0);if(b)for(b=gameContent.selected.length;b--;)d=gameContent.gameElements[gameContent.selected[b]].s,d.f==gameData.FAMILIES.building&&(gameContent.selected.splice(b,
1),gameSurface.unselectElement(d.id))}}};userInput.removeSelectionRectangle=function(){gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1)};
userInput.doubleClickToSelect=function(){if(0<gameContent.selected.length&&rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)){var a=gameContent.gameElements[gameContent.selected[0]].s,c;for(c in gameContent.gameElements){var b=gameContent.gameElements[c].s;b.f==a.f&&(rank.isAlly(gameContent.players,gameContent.myArmy,b)&&b.t==a.t)&&(gameContent.selected.push(b.id),gameSurface.selectElement(b.id))}}};