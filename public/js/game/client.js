THREE.TrackballControls=function(B,A){var r=this;var s={NONE:-1,SELECTION:0,ROTATE_ZOOM:1,ACTION:2,TOUCH_ROTATE:3,TOUCH_ZOOM:4,TOUCH_PAN:5};this.object=B;this.domElement=(A!==undefined)?A:document;this.enabled=true;this.screen={width:0,height:0,offsetLeft:0,offsetTop:0};this.radius=(this.screen.width+this.screen.height)/4;this.rotateSpeed=0.5;this.panSpeed=0.8;this.MODES={normal:order.SPECIAL_ORDERS.normal,attack:order.SPECIAL_ORDERS.attack,patrol:order.SPECIAL_ORDERS.patrol};this.clickMode=this.MODES.normal;this.scroll=[0,0];this.MAP_SCROLL_SPEED=6;this.SCROLL_THRESHOLD=15;this.isKeyboardScrolling=false;this.zoomSpeed=1.2;this.ZOOM_MAX=30;this.ZOOM_MIN=230;this.WHEEL_ROTATION_SPEED=40;this.ANGLE_ROTATION_MIN=0.005;this.PAN_LIMITS=[-100,-100,gameContent.map.size.x*gameSurface.PIXEL_BY_NODE+100,gameContent.map.size.y*gameSurface.PIXEL_BY_NODE+100];this.noRotate=false;this.noZoom=false;this.noPan=false;this.staticMoving=true;this.dynamicDampingFactor=0.3;this.minDistance=0;this.maxDistance=Infinity;this.mousePosition={};this.target=new THREE.Vector3();var j=new THREE.Vector3();var t=s.NONE,l=s.NONE,a=new THREE.Vector3(),p=new THREE.Vector3(),i=new THREE.Vector3(),k=new THREE.Vector2(),w=new THREE.Vector2(),h=0,c=0,d=new THREE.Vector2(),v=new THREE.Vector2();_oldEye=null;_oldUp=null;_oldTarget=null;_oldRotateStart=null;this.KEYBOARD_SHORTCUTS=[81,87,69,82,65,83,68,70];this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();var z={type:"change"};this.handleResize=function(){this.screen.width=window.innerWidth;this.screen.height=window.innerHeight;this.screen.offsetLeft=0;this.screen.offsetTop=0;this.radius=(this.screen.width+this.screen.height)/4};this.handleEvent=function(C){if(typeof this[C.type]=="function"){this[C.type](C)}};this.getMouseOnScreen=function(D,C){return new THREE.Vector2((D-r.screen.offsetLeft)/r.radius*0.5,(C-r.screen.offsetTop)/r.radius*0.5)};this.getMouseProjectionOnBall=function(G,E){var D=new THREE.Vector3((G-r.screen.width*0.5-r.screen.offsetLeft)/r.radius,(r.screen.height*0.5+r.screen.offsetTop-E)/r.radius,0);var F=D.length();if(F>1){D.normalize()}else{D.z=Math.sqrt(1-F*F)}a.copy(r.object.position).sub(r.target);var C=r.object.up.clone().setLength(D.y);C.add(r.object.up.clone().cross(a).setLength(D.x));C.add(a.setLength(D.z));return C};this.rotateCamera=function(){var F=Math.acos(p.dot(i)/p.length()/i.length());if(F>r.ANGLE_ROTATION_MIN){var D=(new THREE.Vector3()).crossVectors(p,i).normalize(),E=new THREE.Quaternion();D.x=0;D.y=0;F*=r.rotateSpeed;E.setFromAxisAngle(D,-F);var C=a.z;a.applyQuaternion(E);a.multiplyScalar(C/a.z);r.object.up.applyQuaternion(E);if(r.staticMoving){p.copy(i)}else{E.setFromAxisAngle(D,F*(r.dynamicDampingFactor-1));p.applyQuaternion(E)}}};this.zoomCamera=function(){if(t===s.TOUCH_ZOOM){var C=h/c;h=c;if(a.z*C<r.ZOOM_MIN&&a.z*C>r.ZOOM_MAX){a.multiplyScalar(C)}}else{var C=1+(w.y-k.y)*r.zoomSpeed;if(C!==1&&C>0){if(a.z*C<r.ZOOM_MIN&&a.z*C>r.ZOOM_MAX){a.multiplyScalar(C)}if(r.staticMoving){k.copy(w)}else{k.y+=(w.y-k.y)*this.dynamicDampingFactor}}}};this.panCamera=function(){var C=v.clone().sub(d);if(C.lengthSq()){C.multiplyScalar(a.length()*r.panSpeed);var D=a.clone().cross(new THREE.Vector3(0,0,1)).setLength(r.scroll[0]);D.add(a.clone().multiply(new THREE.Vector3(1,1,0)).setLength(-r.scroll[1]));r.object.position.add(D);if(r.reachLimits()){r.object.position.sub(D)}else{r.target.add(D)}if(r.staticMoving){d=v}else{d.add(C.subVectors(v,d).multiplyScalar(r.dynamicDampingFactor))}}};this.update=function(){a.subVectors(r.object.position,r.target);_oldEye=a.clone();_oldUp=r.object.up.clone();_oldTarget=r.target.clone();_oldRotateStart=p.clone();if(!r.noRotate){r.rotateCamera()}if(!r.noZoom){r.zoomCamera()}if(r.scroll[0]!=0||r.scroll[1]!=0){d=new THREE.Vector2(r.screen.width/2,r.screen.height/2),v=new THREE.Vector2(r.screen.width/2+r.scroll[0],r.screen.height/2+r.scroll[1]);r.panCamera()}else{if(!r.noPan){r.panCamera()}}r.object.position.addVectors(r.target,a);if(r.reachLimits()){r.object.position.subVectors(r.target,a);a=_oldEye;r.target=_oldTarget;r.object.up=_oldUp;p=_oldRotateStart;r.object.position.addVectors(r.target,_oldEye)}r.object.lookAt(r.target);if(j.distanceToSquared(r.object.position)>0){r.dispatchEvent(z);j.copy(r.object.position)}};this.reset=function(){t=s.NONE;l=s.NONE;r.target.copy(r.target0);r.object.position.copy(r.position0);r.object.up.copy(r.up0);a.subVectors(r.object.position,r.target);r.object.lookAt(r.target);r.dispatchEvent(z);j.copy(r.object.position)};this.reachLimits=function(){if(r.target.x<r.PAN_LIMITS[0]||r.target.y<r.PAN_LIMITS[1]||r.target.x>r.PAN_LIMITS[2]||r.target.y>r.PAN_LIMITS[3]){return true}return false};function g(D){if(r.enabled===false){return}l=t;switch(D.keyCode){case 8:return true;case 13:userInput.pressEnterKey();return true;case 32:userInput.pressSpaceKey();return true;case 38:b(1,1,true);return false;break;case 40:b(1,-1,true);return false;break;case 39:b(0,-1,true);return false;break;case 37:b(0,1,true);return false;break;case 83:userInput.pressStopKey();return true;break;case 72:userInput.pressHoldKey();return true;break;case 80:userInput.enterPatrolMode();return true;break;case 65:userInput.enterAttackMode();return true;break;case 49:D.preventDefault();userInput.pressHotKey(0,D.ctrlKey);return true;break;case 50:D.preventDefault();userInput.pressHotKey(1,D.ctrlKey);return true;break;case 51:D.preventDefault();userInput.pressHotKey(2,D.ctrlKey);return true;break;case 52:D.preventDefault();userInput.pressHotKey(3,D.ctrlKey);return true;break;case 53:D.preventDefault();userInput.pressHotKey(4,D.ctrlKey);return true;break}if(!userInput.isChatWindowOpen){var C=r.KEYBOARD_SHORTCUTS.indexOf(D.keyCode);if(C>=0){userInput.pressToolbarShortcut(C);return false}}}function e(C){if(r.enabled===false){return}t=s.NONE;switch(C.keyCode){case 13:case 38:b(1,0,true);break;case 40:b(1,0,true);break;case 39:b(0,0,true);break;case 37:b(0,0,true);break}}function o(C){if(r.enabled===false){return}C.preventDefault();C.stopPropagation();if(t===s.NONE){t=C.button}if(t===s.ROTATE_ZOOM){if(C.keyCode==0&&!r.noRotate){p=i=r.getMouseProjectionOnBall(C.clientX,C.clientY)}else{if(!r.noZoom){k=w=r.getMouseOnScreen(C.clientX,C.clientY)}}}else{if(t===s.SELECTION){if(r.clickMode!=r.MODES.normal){userInput.doAction(C.clientX,C.clientY,C.shiftKey,r.clickMode);userInput.leaveSpecialClickMode()}else{userInput.doSelect(C.clientX,C.clientY,C.ctrlKey,C.shiftKey)}}else{if(t===s.ACTION){if(r.clickMode!=r.MODES.normal){userInput.leaveSpecialClickMode()}else{userInput.doAction(C.clientX,C.clientY,C.shiftKey,r.clickMode)}}}}document.addEventListener("mouseup",q,false)}function x(C){if(r.enabled===false){return}C.preventDefault();C.stopPropagation();if(t===s.ROTATE_ZOOM){if(!r.noRotate&&C.keyCode==0){i=r.getMouseProjectionOnBall(C.clientX,C.clientY)}else{if(!r.noZoom){w=r.getMouseOnScreen(C.clientX,C.clientY)}}}else{if(t===s.SELECTION){userInput.drawSelectionRectangle(C.clientX,C.clientY,C.ctrlKey)}else{if(C.clientX<r.SCROLL_THRESHOLD){b(0,1,false)}else{if(C.clientX>window.innerWidth-r.SCROLL_THRESHOLD){b(0,-1,false)}else{if(!r.isKeyboardScrolling&&r.scroll[0]!=0){b(0,0,false)}}}if(C.clientY<r.SCROLL_THRESHOLD){b(1,1,false)}else{if(C.clientY>window.innerHeight-r.SCROLL_THRESHOLD){b(1,-1,false)}else{if(!r.isKeyboardScrolling&&r.scroll[1]!=0){b(1,0,false)}}}userInput.onMouseMove(C.clientX,C.clientY)}}r.mousePosition.x=C.clientX;r.mousePosition.y=C.clientY}function q(C){if(r.enabled===false){return}C.preventDefault();C.stopPropagation();t=s.NONE;userInput.onMouseUp();document.removeEventListener("mouseup",q)}function n(C){if(r.enabled===false){return}C.preventDefault();C.stopPropagation();userInput.doDoubleClick(C.clientX,C.clientY)}function m(C){if(r.enabled===false){return}C.preventDefault();C.stopPropagation();var D=0;if(C.wheelDelta){D=C.wheelDelta/40}else{if(C.detail){D=-C.detail/3}}if(C.shiftKey){p=r.getMouseProjectionOnBall(C.clientX,C.clientY);i=r.getMouseProjectionOnBall(C.clientX+D*r.WHEEL_ROTATION_SPEED,C.clientY)}else{k.y+=D*0.01}}function u(E){if(r.enabled===false){return}switch(E.touches.length){case 1:t=s.TOUCH_ROTATE;p=i=r.getMouseProjectionOnBall(E.touches[0].pageX,E.touches[0].pageY);break;case 2:t=s.TOUCH_ZOOM;var D=E.touches[0].pageX-E.touches[1].pageX;var C=E.touches[0].pageY-E.touches[1].pageY;c=h=Math.sqrt(D*D+C*C);break;case 3:t=s.TOUCH_PAN;d=v=r.getMouseOnScreen(E.touches[0].pageX,E.touches[0].pageY);break;default:t=s.NONE}}function f(E){if(r.enabled===false){return}E.preventDefault();E.stopPropagation();switch(E.touches.length){case 1:i=r.getMouseProjectionOnBall(E.touches[0].pageX,E.touches[0].pageY);break;case 2:var D=E.touches[0].pageX-E.touches[1].pageX;var C=E.touches[0].pageY-E.touches[1].pageY;c=Math.sqrt(D*D+C*C);break;case 3:v=r.getMouseOnScreen(E.touches[0].pageX,E.touches[0].pageY);break;default:t=s.NONE}}function y(C){if(r.enabled===false){return}switch(C.touches.length){case 1:p=i=r.getMouseProjectionOnBall(C.touches[0].pageX,C.touches[0].pageY);break;case 2:h=c=0;break;case 3:d=v=r.getMouseOnScreen(C.touches[0].pageX,C.touches[0].pageY);break}t=s.NONE}function b(E,D,C){r.scroll[E]=D*r.MAP_SCROLL_SPEED;if(C){r.isKeyboardScrolling=(D==0?false:true)}}this.domElement.addEventListener("contextmenu",function(C){C.preventDefault()},false);this.domElement.addEventListener("mousedown",o,false);this.domElement.addEventListener("mousemove",x,false);this.domElement.addEventListener("dblclick",n,false);this.domElement.addEventListener("mousewheel",m,false);this.domElement.addEventListener("DOMMouseScroll",m,false);this.domElement.addEventListener("touchstart",u,false);this.domElement.addEventListener("touchend",y,false);this.domElement.addEventListener("touchmove",f,false);window.addEventListener("keydown",g,false);window.addEventListener("keyup",e,false);this.handleResize()};THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);gameSurface.setElementPosition=function(c,b,d){var a=this.convertGamePositionToScenePosition({x:b,y:d});c.position.x=a.x;c.position.y=a.y;c.position.z=a.z};gameSurface.convertGamePositionToScenePosition=function(a){return{x:a.x*this.PIXEL_BY_NODE,y:a.y*this.PIXEL_BY_NODE,z:0.5}};gameSurface.convertScenePositionToGamePosition=function(a){return{x:Math.min(gameContent.map.size.x-1,Math.max(0,parseInt(a.x/this.PIXEL_BY_NODE))),y:Math.min(gameContent.map.size.y-1,Math.max(0,parseInt(a.y/this.PIXEL_BY_NODE)))}};gameSurface.convertScenePositionToGamePositionNoBounds=function(a){return{x:Math.min(gameContent.map.size.x-1,parseInt(a.x/this.PIXEL_BY_NODE)),y:Math.min(gameContent.map.size.y-1,parseInt(a.y/this.PIXEL_BY_NODE))}};gameSurface.drawSelectionCircle=function(a,b){var c=new THREE.Mesh(new THREE.TorusGeometry(a,0.2,2,a*20),new THREE.LineBasicMaterial({color:b}));c.id="select";c.rotation.x=this.de2ra(90);return c};gameSurface.drawLifeBar=function(b){var a=tools.getElementData(b);var d=this.materials.billboardBar.clone();var c=new THREE.Sprite(d);c.position.y=a.height;c.scale.set(1,1,0);c.id="life";this.updateLifeBar(c,b,a);return c};gameSurface.addLifeBar=function(b){var c=this.drawLifeBar(b);var a=b.m;a.add(c)};gameSurface.updateLifeBar=function(c,b,a){var d=b.l/a.l;c.scale.x=a.lifeBarWidth*d;c.material.color.setHex(this.getLifeBarColor(d))};gameSurface.updateProgressBar=function(a,d,c){var e=null;for(var b in a.children){if(a.children[b].id=="prog"){e=a.children[b];break}}if(d.q.length>0&&d.qp>0){if(e==null){var f=this.materials.billboardBar.clone();var e=new THREE.Sprite(f);e.scale.set(1,0.6,0);e.position.y=c.height-0.5;e.id="prog";a.add(e)}e.scale.x=c.lifeBarWidth*d.qp/100;e.position.x=-c.lifeBarWidth/14+e.scale.x/14}else{if(d.qp>=99&&gameContent.players[gameContent.myArmy].pop.current==gameContent.players[gameContent.myArmy].pop.max){this.showMessage(this.MESSAGES.popLimitReached)}else{if(e!=null){a.remove(e)}}}};gameSurface.updateOrderPosition=function(){if(gameContent.selected.length>0){var b=utils.getElementFromId(gameContent.selected[0]);if(b==null){this.order.visible=false;return}if(b.a!=null&&(b.a.moveTo!=null||b.a.id!=null)||b.rp!=null){var a=null;if(b.rp!=null){a=b.rp}else{if(b.a.moveTo!=null){a=b.a.moveTo}else{var c=utils.getElementFromId(b.a.id);if(c!=null){a=c.p}else{this.order.visible=false;return}}}this.setElementPosition(this.order,a.x,a.y);if(this.order.scale.x>=gameSurface.ORDER_SIZE_MAX){gameSurface.orderFactor=-1}else{if(this.order.scale.x<=gameSurface.ORDER_SIZE_MIN){gameSurface.orderFactor=1}}this.order.scale.x+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor;this.order.scale.y+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor;this.order.visible=true}else{if(this.order.visible){this.order.visible=false}}}else{if(this.order.visible){this.order.visible=false}}};gameSurface.updateSelectionRectangle=function(d,f,c,e){var b=Math.abs(d-c);var a=Math.abs(f-e);if(b>0&&a>0){$("#selectionRectangle").css({top:Math.min(f,e),left:Math.min(d,c),width:b,height:a});$("#selectionRectangle").removeClass("hide")}else{$("#selectionRectangle").addClass("hide")}};gameSurface.de2ra=function(a){return a*(Math.PI/180)};gameSurface.selectElement=function(b){var e=utils.getElementFromId(b);if(e!=null){var c=e.m;var d=tools.getElementData(e);var a;if(rank.isEnemy(gameContent.players,gameContent.myArmy,e)){a=this.SELECTION_ENEMY_COLOR}else{if(rank.isAlly(gameContent.players,gameContent.myArmy,e)){a=this.SELECTION_ALLY_COLOR}else{a=this.SELECTION_NEUTRAL_COLOR}}c.add(this.drawSelectionCircle(d.shape.length/2*this.PIXEL_BY_NODE/2,a))}};gameSurface.unselectElement=function(a){try{var c=utils.getElementFromId(a).m;var b=c.children.length;while(b--){var f=c.children[b];if(f.id=="select"){c.remove(f)}}}catch(d){}};gameSurface.unselectAll=function(){for(var a in gameContent.selected){this.unselectElement(gameContent.selected[a])}};gameSurface.updateOrientation=function(c,b,a){if(b==0&&a<0){}else{if(b>0&&a<0){c.rotation.y=this.de2ra(45)}else{if(b>0&&a==0){c.rotation.y=this.de2ra(90)}else{if(b>0&&a>0){c.rotation.y=this.de2ra(135)}else{if(b==0&&a>0){c.rotation.y=this.de2ra(180)}else{if(b<0&&a>0){c.rotation.y=this.de2ra(225)}else{if(b<0&&a==0){c.rotation.y=this.de2ra(270)}else{if(b<0&&a<0){c.rotation.y=this.de2ra(315)}}}}}}}}};gameSurface.updateBuildingGeometry=function(){for(var d in this.building.children){this.building.children[d].visible=false}var a=gameContent.building.shape;for(var d in a){for(var c in a){var e;if(a[d][c]==userInput.CAN_BE_BUILT_HERE){e=this.canBuildHereMaterial}else{if(a[d][c]==userInput.CANNOT_BE_BUILT_HERE){e=this.cannotBuildHereMaterial}else{continue}}var b=d*this.BUILDING_STRUCTURE_SIZE+parseInt(c);this.building.children[b].material=e;this.building.children[b].visible=true}}this.setElementPosition(this.building,gameContent.building.p.x-parseInt(a.length/2),gameContent.building.p.y-parseInt(a.length/2));this.building.visible=true};gameSurface.removeBuildingGeometry=function(){for(var a in this.building.children){this.building.children[a].visible=false}this.building.visible=false};gameSurface.animateSelectionCircle=function(b){this.selectElement(b);var d=utils.getElementFromId(b).m;var f;for(var e in d.children){if(d.children[e].id=="select"){f=d.children[e];break}}var c=new TWEEN.Tween({alpha:1}).delay(300).to({alpha:0},300).onComplete(function(){f.visible=false}).start();var a=new TWEEN.Tween({alpha:0}).to({alpha:1},300).onComplete(function(){f.visible=true});var g=new TWEEN.Tween({alpha:0}).to({alpha:1},500).onComplete(function(){gameSurface.unselectElement(b)});c.chain(a);a.chain(g)};gameSurface.getLifeBarColor=function(a){if(a<0.3){return 16711680}else{if(a<0.6){return 14934804}else{return 65280}}};gameSurface.getLifeBarBackgroundColor=function(a){if(a<0.25){return"lowLife"}else{if(a<0.5){return"mediumLife"}else{if(a<0.75){return"highLife"}else{return"veryHighLife"}}}};gameSurface.MESSAGES={popLimitReached:{id:0,text:"You need more houses"},musicEnabled:{id:1,text:"Music enabled"},musicDisabled:{id:2,text:"Music disabled"}};gameSurface.showMessage=function(c,a){$("#messages").removeClass("hide");var b=new Date();$("#messages").append("<div>"+b.getHours()+":"+b.getMinutes()+":"+(b.getSeconds()<10?"0":"")+b.getSeconds()+'<span class="'+(a==null?"white":a)+'">'+c.text+"</span></div>").scrollTop(10000)};gameSurface.extrapol=function(c,b,a){c.ex=b;c.ey=a;c.et=this.MOVEMENT_EXTRAPOLATION_ITERATION;this.ex.push(c)};gameSurface.updateMoveExtrapolation=function(){var b=this.ex.length;while(b--){var a=this.ex[b];a.position.x+=a.ex*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION;a.position.y+=a.ey*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION;a.et-=1;var c=utils.getElementFromId(a.elementId);if(a.et<=0&&c!=null){this.setElementPosition(a,c.p.x,c.p.y);a.et=0;a.ex=0;a.ey=0;this.ex.splice(b,1)}}};var gameContent={};gameContent.gameId=null;gameContent.map=null;gameContent.players=null;gameContent.myArmy=null;gameContent.isRunning=false;gameContent.game=null;gameContent.gameElements={land:{},building:{},unit:{}};gameContent.grid=[];gameContent.selected=[];gameContent.building=null;gameContent.selectionRectangle=[];gameContent.init=function(d){for(var c=0;c<this.map.size.x;c++){this.grid[c]=[];for(var a=0;a<this.map.size.y;a++){this.grid[c][a]=0}}for(var c in d){for(var a in d[c]){var b=d[c][a];gameSurface.addElement(b);if(b.f==gameData.FAMILIES.building&&b.o==this.myArmy){gameSurface.centerCameraOnElement(utils.getElementFromId(b.id))}}}};gameContent.update=function(d){for(var c in d.added){var b=d.added[c];if(utils.getElementFromId(b.id)==null){gameSurface.addElement(b)}}for(var c in d.removed){var b=d.removed[c];if(utils.getElementFromId(b.id)!=null){gameSurface.removeElement(b)}}for(var c in d.modified){var b=d.modified[c];if(utils.getElementFromId(b.id)!=null){gameSurface.updateElement(b)}}gameSurface.manageElementsVisibility();for(var c in this.players){for(var a in this.players[c].ra){if(this.players[c].ra[a]!=d.players[c].ra[a]){this.rankHasChanged(d.players[c],d.players[a])}}}this.players=d.players;if(gameManager.isOfflineGame&&this.players[this.myArmy].s==gameData.PLAYER_STATUSES.victory||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.defeat||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.surrender){gameManager.showStats(this.players[this.myArmy].s,gameContent.game.stats);clearInterval(gameManager.offlineGameLoop)}for(var c in d.chat){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:d.chat[c].text},gameSurface.PLAYERS_COLORS[d.chat[c].o])}};gameContent.rankHasChanged=function(b,a){if(b.ra[a.o]==gameData.RANKS.enemy){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:b.n+" has declared the war to "+a.n+" !"})}else{if(b.ra[a.o]==gameData.RANKS.neutral&&a.ra[b.o]==gameData.RANKS.neutral){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:b.n+" and "+a.n+" have signed an alliance !"})}else{if(b.ra[a.o]==gameData.RANKS.neutral){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:b.n+" wants to conclude a pact with "+a.n+"..."})}}}};var gameManager={};gameManager.isOfflineGame=false;gameManager.offlineGameLoop=0;gameManager.musicEnabled=false;gameManager.getPlayerId=function(){var a=utils.readCookie("rts_player_id");if(a==null){var b=new Date().getTime()+Math.random();utils.createCookie("rts_player_id",b);a=b}return a};gameManager.getPlayerName=function(){var a=utils.readCookie("rts_player_name");if(a==null){return gameData.getRandomName()}else{return a}};gameManager.updatePlayerName=function(a){utils.createCookie("rts_player_name",a);this.playerName=a};gameManager.sendOrderToEngine=function(a,b){if(this.isOfflineGame){gameContent.game.orders.push([a,b])}else{socketManager.sendOrder(gameContent.gameId,a,b)}};gameManager.createGameObject=function(c,d,j,b,e,f,i,a,h,g){return{playerId:c,playerName:d,armyId:j,mapType:b,mapSize:e,initialResources:f,vegetation:i,objectives:a,nbPlayers:h,iaPlayers:g}};gameManager.startOfflineGame=function(b){this.isOfflineGame=true;gameContent.myArmy=b.armyId;gameContent.players=[];gameContent.players.push(new gameData.Player(0,0,b.armyId,false));gameContent.players[0].n=b.playerName;for(var c=0;c<b.iaPlayers.length;c++){var a=c+1;gameContent.players.push(new gameData.Player(a,a,b.iaPlayers[c],true));gameContent.players[a].n=gameData.getRandomName()}gameContent.map=new gameData.Map(gameData.MAP_TYPES[Object.keys(gameData.MAP_TYPES)[b.mapType]],gameData.MAP_SIZES[Object.keys(gameData.MAP_SIZES)[b.mapSize]],gameData.VEGETATION_TYPES[Object.keys(gameData.VEGETATION_TYPES)[b.vegetation]],gameData.INITIAL_RESOURCES[Object.keys(gameData.INITIAL_RESOURCES)[b.initialResources]],b.objectives);gameContent.game=gameCreation.createNewGame(gameContent.map,gameContent.players);this.waitingData=gameContent.game.gameElements;gameSurface.init();GUI.init()};gameManager.updateLoadingProgress=function(a){$(".bar","#loadingProgress").css("width",a+"%");if(this.isOfflineGame||gameContent.isRunning){if(a>=100){this.startGame()}}else{if(a>=100||Math.random()<0.2){socketManager.updateLoadingProgress(this.playerId,gameContent.gameId,a)}}};gameManager.startGame=function(){setTimeout(function(){$("#game").removeClass("hide");$("#loadingScreen").remove()},500);gameContent.init(this.waitingData);if(this.isOfflineGame&&this.offlineGameLoop==0){this.offlineGameLoop=setInterval(function(){gameContent.update(gameContent.game.update())},1000/gameLogic.OFFLINE_FREQUENCY)}};gameManager.updateJoinableGamesList=function(c){$("tbody","#lstGames").html("");if(c.games.length>0){$(".noResult","#joinGame").addClass("hide");$("table","#joinGame").removeClass("hide");for(var b in c.games){var a=c.games[b];$("tbody","#lstGames").append('<tr data-id="'+a.id+'"><td>'+a.creatorName+"</td><td>"+a.mapSize+"</td><td>"+a.initialResources+"</td><td>"+a.objectives+"</td><td>"+a.players+"</td></tr>")}}else{$(".noResult","#joinGame").removeClass("hide");$("table","#joinGame").addClass("hide")}$("tbody tr","#lstGames").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton);$(this).unbind("click");$(".modal").modal("hide");showLoadingScreen("Loading");var d=$(this).attr("data-id");var e=$(".checked","#armies").attr("data-army");socketManager.joinGame(gameManager.playerId,gameManager.playerName,d,e);removeWebsiteDom()})};gameManager.initOnlineGame=function(a){gameContent.gameId=a.gameId;gameContent.players=a.players;gameContent.myArmy=a.myArmy;gameContent.map=a.map;gameContent.isRunning=a.isRunning;this.waitingData=a.initElements;gameSurface.init();GUI.init()};gameManager.updateQueue=function(c){$("#playersLoading").removeClass("hide").html("");for(var b in c.players){var a=c.players[b];if(this.playerId!=a.pid){$("#playersLoading").append('<div data-id="'+a.pid+'"><div class="color '+gameSurface.PLAYERS_COLORS[b]+'">&nbsp;</div><div class="name">'+a.n+'</div><div class="progress"><div class="bar" style="width: 0%"></div></div></div>')}}};gameManager.playersReady=[];gameManager.updateLoadingQueue=function(a){$("#labelLoading").html("Loading");$(".bar",'div[data-id="'+a.playerId+'"]').css("width",a.loadingProgress+"%");if(a.loadingProgress>=100&&this.playersReady.indexOf(a.playerId)==-1){this.playersReady.push(a.playerId)}if(this.playersReady.length>=gameContent.players.length){this.startGame()}};gameManager.showStats=function(b,f){if(b==gameData.PLAYER_STATUSES.victory){$("#endGameMessage").addClass("victory");$("#endGameMessage").html("Victory !")}else{$("#endGameMessage").addClass("defeat");$("#endGameMessage").html("Defeat...")}$("#endGame").removeClass("hide");var c=[];for(var e in f){var j=f[e];var h=gameContent.players[e];var a=[];for(var e in h.tec){var g=h.tec[e];if(a.indexOf(g)==-1){a.push(g)}}var d=stats.getTotalScore(j,a.length);$("tbody","#endGame").append('<tr class="'+gameSurface.PLAYERS_COLORS[e]+'"><td>'+h.n+"</td><td>"+j.killed+"</td><td>"+j.lost+"</td><td>"+j.buildingsDestroyed+"</td><td>"+j.unitsCreated+"</td><td>"+j.resources+"</td><td>"+j.buildersCreated+"</td><td>"+j.buildingsCreated+"</td><td>"+a.length+"</td><td>"+d+"</td></tr>");c.push(j.pop)}var k={xaxis:{show:false},yaxis:{min:0,autoscaleMargin:1,position:"right",tickDecimals:0},colors:gameSurface.PLAYERS_COLORS};$("#popChart").css({height:"160px",width:window.innerWidth/2,left:window.innerWidth/4});$.plot($("#popChart"),c,k)};gameManager.askRejoin=function(a){$("#notifications").removeClass("hide").append('<div class="notification rejoin blackBackground">You were in a game. Do you want to rejoin it ?<div><button class="ok green">Yes</button><button class="no red">No</button></div></div>');$(".ok",".rejoin").click(function(){$(this).unbind("click");$(".modal").modal("hide");removeWebsiteDom();showLoadingScreen("Loading");socketManager.rejoinGame(gameManager.playerId,a.gameId);$(".rejoin").fadeOut()});$(".no",".rejoin").click(function(){$(".rejoin").fadeOut()})};var gameSurface={};var scene,camera,controls;THREE.ShaderLib.lambert.fragmentShader=THREE.ShaderLib.lambert.fragmentShader.replace(/^\s\s*/,"").replace(/\s\s*$/,"");THREE.ShaderLib.lambert.fragmentShader="uniform vec3 diffuse;\n"+THREE.ShaderLib.lambert.fragmentShader.substr(0,THREE.ShaderLib.lambert.fragmentShader.length-1);THREE.ShaderLib.lambert.fragmentShader+=["#ifdef USE_MAP","	gl_FragColor = texture2D( map, vUv );","#else","	gl_FragColor = vec4(diffuse, 1.0);","#endif","	vec3 basecolor = vec3(gl_FragColor[0], gl_FragColor[1], gl_FragColor[2]);","	float alpha = gl_FragColor[3];","	float vlf = vLightFront[0];","	if (vlf< 0.50) { gl_FragColor = vec4(mix( basecolor, vec3(0.0), 0.5), alpha); }","	if (vlf>=0.50) { gl_FragColor = vec4(mix( basecolor, vec3(0.0), 0.3), alpha); }","	if (vlf>=0.75) { gl_FragColor = vec4(mix( basecolor, vec3(1.0), 0.0), alpha); }","}"].join("\n");console.log(THREE.ShaderLib.lambert);gameSurface.MODELS_PATH="img/3D/";gameSurface.PIXEL_BY_NODE=10;gameSurface.NEAR=0.1;gameSurface.FAR=20000;gameSurface.ZOOM_STEP=15;gameSurface.ORDER_ANIMATION_SPEED=0.08;gameSurface.ORDER_ROTATION_SPEED=1/12;gameSurface.ORDER_SIZE_MAX=0.9;gameSurface.ORDER_SIZE_MIN=0.5;gameSurface.ORDER_OPACITY=0.3;gameSurface.FOG_DENSITY=0.0005;gameSurface.SELECTION_ENEMY_COLOR="#f00";gameSurface.SELECTION_ALLY_COLOR="#0f0";gameSurface.SELECTION_NEUTRAL_COLOR="#e3e314";gameSurface.CAMERA_INIT_ANGLE=0.7;gameSurface.CAN_BUILD_CUBE_COLOR=65280;gameSurface.CANNOT_BUILD_CUBE_COLOR=16711680;gameSurface.BUILD_CUBE_OPACITY=0.3;gameSurface.CENTER_CAMERA_Y_OFFSET=20*gameSurface.PIXEL_BY_NODE;gameSurface.BARS_HEIGHT=0.5;gameSurface.BARS_DEPTH=0.2;gameSurface.BUILDING_STRUCTURE_SIZE=5;gameSurface.BUILDING_INIT_Z=-1.5*gameSurface.PIXEL_BY_NODE;gameSurface.ARMIES_COLORS=["_red","_blu","_gre","_yel"];gameSurface.PLAYERS_COLORS=["red","blue","green","yellow"];gameSurface.PLAYERS_COLORS_RGB=[{r:255,g:0,b:0},{r:50,g:50,b:255},{r:25,g:255,b:0},{r:255,g:255,b:0}];gameSurface.MOVEMENT_EXTRAPOLATION_ITERATION=8;gameSurface.LAND_HEIGHT_SMOOTH_FACTOR=65;gameSurface.FOG_OF_WAR_HEIGHT=10;gameSurface.FOG_OF_WAR_UNCOVERED_HEIGHT=-20;gameSurface.DEEP_FOG_OF_WAR_HEIGHT=18;gameSurface.DEEP_FOG_OF_WAR_UNCOVERED_HEIGHT=-19;gameSurface.iteration=0;gameSurface.geometries=null;gameSurface.materials=null;gameSurface.isKeyboardScrolling=false;gameSurface.stuffLoaded=0;gameSurface.totalStuffToLoad=0;gameSurface.ex=[];gameSurface.orderFactor=-1;gameSurface.loader=null;gameSurface.projector=null;gameSurface.order=null;gameSurface.canBuildHereMaterial=null;gameSurface.cannotBuildHereMaterial=null;gameSurface.basicCubeGeometry=null;gameSurface.building=null;gameSurface.clock=null;gameSurface.elementsMemorizedInFog=[];gameSurface.fogOfWarMatrix=null;gameSurface.deepFogOfWarMatrix=null;gameSurface.fogOfWarGroundTexture;gameSurface.fogOfWarDataColor;gameSurface.mapTexture;gameSurface.mapDataColor;gameSurface.minimapCanvas;gameSurface.minimapContext;gameSurface.minimapData;gameSurface.planeSurface;gameSurface.transparentSurface;gameSurface.waterSurface;gameSurface.cameraMinimapPosition={x:0,y:0};gameSurface.cameraMinimapAngle=0;gameSurface.cameraVisionCorners=[0,0,0,0];var chibre=0;gameSurface.init=function(){this.clock=new THREE.Clock();$("#loadingLabel").html("Loading");scene=new THREE.Scene();camera=new THREE.PerspectiveCamera(25,window.innerWidth/window.innerHeight,this.NEAR,this.FAR);controls=new THREE.TrackballControls(camera);renderer=new THREE.WebGLRenderer();renderer.setSize(window.innerWidth,window.innerHeight);document.body.appendChild(renderer.domElement);this.projector=new THREE.Projector();this.geometries={};this.materials={};this.loader=new THREE.JSONLoader();this.totalStuffToLoad+=2;this.totalStuffToLoad+=2;var e=[];for(var b in gameContent.players){var a=2;var d=parseInt(gameContent.players[b].r);if(e.indexOf(d)==-1){e.push(d);a=3}this.totalStuffToLoad+=Object.keys(gameData.ELEMENTS[gameData.FAMILIES.unit][d]).length*a;this.totalStuffToLoad+=Object.keys(gameData.ELEMENTS[gameData.FAMILIES.building][d]).length*a}this.totalStuffToLoad+=(Object.keys(gameData.ELEMENTS[gameData.FAMILIES.land][0]).length-1)*3;this.createScene();this.init3DModels();this.minimapCanvas=$("#minimap")[0];this.minimapCanvas.width=gameContent.map.size.x;this.minimapCanvas.height=gameContent.map.size.y;this.minimapContext=this.minimapCanvas.getContext("2d");this.minimapData=this.minimapContext.getImageData(0,0,this.minimapCanvas.width,this.minimapCanvas.height);window.addEventListener("resize",this.onWindowResize,false);function c(){gameSurface.iteration=(gameSurface.iteration>1000?0:gameSurface.iteration+1);requestAnimationFrame(c);controls.update();gameSurface.updateMoveExtrapolation();TWEEN.update();var f=gameSurface.clock.getDelta();gameSurface.waterSurface.animate(f);renderer.render(scene,camera);if(gameSurface.iteration%(1/GUI.UPDATE_FREQUENCY)==0){gameSurface.updateOrderPosition();GUI.update();gameSurface.updateCameraViewBounds();gameSurface.updateMinimap()}}c()};gameSurface.createScene=function(){var d=["xpos","xneg","ypos","yneg","zpos","zneg"];var I=new THREE.CubeGeometry(5000,5000,5000);var q="alien";var Q=".jpg";var p=new THREE.SpotLight(16777215);p.position.set(200,-2,200);p.rotation.x=p.rotation.y=p.rotation.z=0;p.target.position.set(0,0,0);p.target.updateMatrixWorld();scene.add(p);var O=new THREE.AmbientLight(8421504);scene.add(O);var J=gameContent.map.size.x,n=gameContent.map.size.y,P=J*n;this.fogOfWarDataColor=new Uint8Array(P*3);var w=THREE.ImageUtils.loadTexture(this.MODELS_PATH+"grass2.png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()});w.wrapT=w.wrapS=THREE.RepeatWrapping;w.repeat.set(16,16);this.fogOfWarGroundTexture=new THREE.DataTexture(this.fogOfWarDataColor,J,n,THREE.RGBFormat);this.fogOfWarGroundTexture.needsUpdate=true;var D={fogMap:{type:"f",value:[]}};var h={tFog:{type:"t",value:this.fogOfWarGroundTexture},tGrass:{type:"t",value:w},textRepeat:{type:"f",value:16}};var f=new THREE.ShaderMaterial({transparent:true,uniforms:h,attributes:D,vertexShader:["// These have global scope","varying vec2 vUv;","void main() {","vUv = vec2(uv.x, (1.0-uv.y));","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}",].join("\n"),fragmentShader:["uniform sampler2D tFog;","uniform sampler2D tGrass;","varying vec2 vUv;","varying vec2 vUv2;","uniform float textRepeat;","void main() {","vec2 uv = vUv;","vec4 texel = texture2D( tFog, uv ) * texture2D( tGrass, uv * textRepeat );","gl_FragColor = vec4(texel.rgb, 1.0);  // adjust the alpha","}",].join("\n"),});var H=new THREE.PlaneGeometry(gameContent.map.size.x*this.PIXEL_BY_NODE,gameContent.map.size.y*this.PIXEL_BY_NODE);var b=new THREE.Mesh(H,f);b.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5;b.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;scene.add(b);this.planeSurface=b;var e=new THREE.Mesh(new THREE.PlaneGeometry(5000,5000),new THREE.MeshNormalMaterial({transparent:true,opacity:0}));e.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5;e.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;e.position.z=-1;scene.add(e);this.transparentSurface=e;var F=THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+"lava.png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()});var g=THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+"lava2.png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()});this.waterSurface=new WaterSurface(3000,3000,2,F,g);this.waterSurface.model.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5;this.waterSurface.model.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;this.waterSurface.model.position.z=-20;scene.add(this.waterSurface.model);this.fogOfWarMatrix=[];this.deepFogOfWarMatrix=[];for(var C=0;C<gameContent.map.size.x;C++){this.fogOfWarMatrix[C]=[];this.deepFogOfWarMatrix[C]=[];for(var B=0;B<gameContent.map.size.y;B++){this.fogOfWarMatrix[C][B]=0;this.deepFogOfWarMatrix[C][B]=0}}var s=gameContent.map.size.x*20;var u=70;var G=s/u;var o=s/4;var k=new THREE.PlaneGeometry(gameContent.map.size.x*this.PIXEL_BY_NODE*1.5,gameContent.map.size.y*this.PIXEL_BY_NODE*1.5,u,u);for(var M=0,K=k.faces.length;M<K;M++){var t=k.faces[M].centroid;if(Math.abs(t.x)<o-G&&Math.abs(t.y)<o-G){k.faces.splice(M,1);K--;M--}}var r=s/2-o;for(var M=0,K=k.vertices.length;M<K;M++){var m=k.vertices[M];if(Math.abs(m.x)<o-G&&Math.abs(m.y)<o-G){continue}var c;if(Math.abs(m.x)<o){c=Math.abs(m.y)-o}else{if(Math.abs(m.y)<o){c=Math.abs(m.x)-o}else{c=Math.sqrt(Math.pow(Math.abs(m.x)-o,2)+Math.pow(Math.abs(m.y)-o,2))}}if(c<G){continue}var N=c/r*10;var A;A=Math.exp(-Math.pow(-(N-2.5)*0.75,2))*0.7;if(N>2){A-=N/10}m.z=A*100+10-Math.random()*20}k.elementsNeedUpdate=true;k.verticesNeedUpdate=true;k.computeCentroids();k.computeFaceNormals();var v=THREE.ImageUtils.loadTexture(this.MODELS_PATH+"rock.png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()});v.wrapT=v.wrapS=THREE.RepeatWrapping;v.repeat.set(32,32);var E=new THREE.Mesh(k,new THREE.MeshLambertMaterial({map:v}));E.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5;E.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;E.position.z=-0.3;scene.add(E);this.order=new THREE.Mesh(new THREE.TorusGeometry(3,0.9,2,18),new THREE.LineBasicMaterial({color:"#0f0"}));this.order.visible=false;scene.add(this.order);this.canBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CAN_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:false});this.cannotBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CANNOT_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:false});this.basicCubeGeometry=new THREE.CubeGeometry(this.PIXEL_BY_NODE,this.PIXEL_BY_NODE,this.PIXEL_BY_NODE);this.building=new THREE.Object3D();for(var M=0;M<this.BUILDING_STRUCTURE_SIZE;M++){for(var L=0;L<this.BUILDING_STRUCTURE_SIZE;L++){var a=new THREE.Mesh(this.basicCubeGeometry,this.canBuildHereMaterial);a.position.x=M*this.PIXEL_BY_NODE;a.position.y=L*this.PIXEL_BY_NODE;a.visible=false;this.building.add(a)}}this.building.visible=false;scene.add(this.building)};gameSurface.init3DModels=function(){for(var c in gameContent.players){for(var a in gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[c].r]){var b=gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[c].r][a];if(b.g!=null&&this.geometries[b.g]==null){this.geometries[b.g]={};this.loadObject(b.g,gameData.FAMILIES.building,b.r)}}for(var a in gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[c].r]){var b=gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[c].r][a];if(b.g!=null&&this.geometries[b.g]==null){this.geometries[b.g]={};this.loadObject(b.g,gameData.FAMILIES.unit,b.r)}}}for(var c in gameData.ELEMENTS[gameData.FAMILIES.land][0]){var b=gameData.ELEMENTS[gameData.FAMILIES.land][0][c];if(b.g!=null&&this.geometries[b.g]==null){this.geometries[b.g]={};this.loadObject(b.g,gameData.FAMILIES.land,0)}}gameSurface.materials.billboardBar=new THREE.SpriteMaterial({color:16777215,useScreenCoordinates:false,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+"fog2.png")})};gameSurface.loadObject=function(c,d,b){this.loader.load(this.MODELS_PATH+c+".js",this.geometryLoaded(c));if(d!=gameData.FAMILIES.land){for(var e=0;e<gameContent.players.length;e++){if(gameContent.players[e].r==b){var a=this.ARMIES_COLORS[e];gameSurface.materials[c+a]=new THREE.MeshLambertMaterial({lights:true,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+c+a+".png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()})});gameSurface.materials["HIDDEN"+c+a]=new THREE.MeshLambertMaterial({lights:true,color:5592405,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+c,""+a+".png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()})})}}}else{gameSurface.materials[c]=new THREE.MeshLambertMaterial({lights:true,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+c+".png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()})});gameSurface.materials["HIDDEN"+c]=new THREE.MeshLambertMaterial({lights:true,color:5592405,map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+c+".png",new THREE.UVMapping(),function(){gameSurface.updateLoadingCounter()})})}};gameSurface.geometryLoaded=function(a){return function(c,b){gameSurface.geometries[a]=c;gameSurface.updateLoadingCounter()}};gameSurface.updateLoadingCounter=function(){this.stuffLoaded++;gameManager.updateLoadingProgress(parseInt(100*this.stuffLoaded/this.totalStuffToLoad));console.log(this.stuffLoaded+" "+this.totalStuffToLoad)};gameSurface.onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);GUI.initMinimapSize();controls.handleResize()};gameSurface.addElement=function(e){var b=tools.getElementData(e);var h=b.g;if(e.f==gameData.FAMILIES.land){e.material=this.materials[h];e.hiddenMaterial=this.materials["HIDDEN"+h]}else{e.material=this.materials[h+this.ARMIES_COLORS[e.o]];if(e.f==gameData.FAMILIES.building){e.hiddenMaterial=this.materials["HIDDEN"+h+this.ARMIES_COLORS[e.o]]}}var c=new THREE.Mesh(this.geometries[h],e.material);c.elementId=e.id;this.setElementPosition(c,e.p.x,e.p.y);c.rotation.x=this.de2ra(90);if(h=="tree"){c.scale.y=1.5;c.rotation.x=this.de2ra(90);c.rotation.y=this.de2ra(Math.random()*360)}else{if(h=="tomato_mothertree"){c.scale.x=3;c.scale.y=3;c.scale.z=3;c.rotation.x=this.de2ra(90)}else{if(h=="goldmine"){c.scale.x=1.5;c.scale.y=1.5;c.scale.z=1.5;c.rotation.x=this.de2ra(90);c.rotation.y=this.de2ra(Math.random()*360)}else{if(h=="house"){c.scale.x=3;c.scale.y=3;c.scale.z=3;c.rotation.x=this.de2ra(90)}else{if(h=="casern"){c.scale.x=2;c.scale.y=2;c.scale.z=2;c.rotation.x=this.de2ra(90)}else{if(h=="tomato_builder"){c.scale.x=2;c.scale.y=2;c.scale.z=2;c.rotation.x=this.de2ra(90)}else{if(h=="swordsman"){c.scale.x=2;c.scale.y=2;c.scale.z=2;c.rotation.x=this.de2ra(90)}else{if(h=="bowman"){c.scale.x=2;c.scale.y=2;c.scale.z=2;c.rotation.x=this.de2ra(90)}else{if(h=="knight"){c.scale.x=2;c.scale.y=2;c.scale.z=2;c.rotation.x=this.de2ra(90)}else{if(h=="tower"){c.scale.x=2;c.scale.z=2;c.scale.y=2;c.rotation.x=this.de2ra(90)}}}}}}}}}}if(gameManager.isOfflineGame){gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id]=e.toJSON()}else{gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id]=e}gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id].m=c;if(e.f!=gameData.FAMILIES.land){this.addLifeBar(utils.getElementFromId(e.id))}if(rank.isAlly(gameContent.players,gameContent.myArmy,e)){this.showElement(utils.getElementFromId(e.id))}if(e.f==gameData.FAMILIES.building){if(e.cp<100){c.position.z+=this.BUILDING_INIT_Z}}var k=b.shape;for(var f in k){var l=k[f];for(var d in l){var a=l[d];if(a>0){var g=tools.getPartPosition(e,f,d);gameContent.grid[g.x][g.y]=e.id}}}};gameSurface.updateElement=function(e){var m=utils.getElementFromId(e.id);var c=m.m;if(m.f==gameData.FAMILIES.unit){var n=e.p.x-m.p.x;var l=e.p.y-m.p.y;if(n!=0||l!=0){this.updateOrientation(c,n,l);this.extrapol(c,n,l)}}if(e.f==gameData.FAMILIES.building){this.setElementPosition(c,e.p.x,e.p.y)}var b=tools.getElementData(e);if(e.f==gameData.FAMILIES.building&&rank.isAlly(gameContent.players,gameContent.myArmy,e)){if(e.cp<100){c.position.z=(100-e.cp)/100*this.BUILDING_INIT_Z}else{this.updateProgressBar(c,e,b)}}if(e.f!=gameData.FAMILIES.land){for(var f in c.children){if(c.children[f].id=="life"){this.updateLifeBar(c.children[f],e,b);c.children[f].rotation.y=-c.rotation.y+this.de2ra(90);break}}if(e.o==gameContent.myArmy&&m.l>e.l){}}var g=b.shape;for(var f in g){for(var d in g[f]){if(g[f][d]>0){var k=tools.getPartPosition(m,f,d);gameContent.grid[k.x][k.y]=0}}}for(var f in g){for(var d in g[f]){if(g[f][d]>0){var k=tools.getPartPosition(e,f,d);gameContent.grid[k.x][k.y]=e.id}}}var a=m.visible;var h=m.modelVisible;if(gameManager.isOfflineGame){gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id]=e.toJSON()}else{gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id]=e}gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id].m=c;gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id].visible=a;gameContent.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id].modelVisible=h};gameSurface.removeElement=function(d){d=utils.getElementFromId(d.id);if(gameContent.selected.indexOf(d.id)>=0){gameContent.selected.splice(gameContent.selected.indexOf(d.id),1)}var g=this.shouldMemorizeInFog(d);if(!g){gameSurface.hideElement(d)}else{if(d.visible){gameSurface.hideElementModel(d)}}var b=tools.getElementData(d);var h=b.shape;for(var e in h){var k=h[e];for(var c in k){var a=k[c];if(a>0){var f=tools.getPartPosition(d,e,c);gameContent.grid[f.x][f.y]=0}}}delete gameContent.gameElements[Object.keys(gameData.FAMILIES)[d.f]][d.id]};gameSurface.getAbsolutePositionFromPixel=function(b,c){var a=this.getFirstIntersectObject(b,c);if(a!=null){return this.convertScenePositionToGamePosition(a.point)}else{return{x:0,y:0}}};gameSurface.getAbsolutePositionFromPixelNoBounds=function(b,c){var a=this.getFirstIntersectObject(b,c,[this.transparentSurface]);if(a!=null){return this.convertScenePositionToGamePositionNoBounds(a.point)}else{return{x:0,y:0}}};gameSurface.getFirstIntersectObject=function(a,f,c){if(c==undefined){c=scene.children}var b=new THREE.Vector3((a/window.innerWidth)*2-1,-(f/window.innerHeight)*2+1,0.5);this.projector.unprojectVector(b,camera);var d=new THREE.Raycaster(camera.position,b.sub(camera.position).normalize());var e=d.intersectObjects(c);if(e.length>0){return e[0]}return null};gameSurface.updateCameraViewBounds=function(){this.cameraVisionCorners=[this.getAbsolutePositionFromPixelNoBounds(0,0),this.getAbsolutePositionFromPixelNoBounds(window.innerWidth,0),this.getAbsolutePositionFromPixelNoBounds(window.innerWidth,window.innerHeight),this.getAbsolutePositionFromPixelNoBounds(0,window.innerHeight),]};gameSurface.centerCameraOnElement=function(b){controls.reset();var a=this.convertGamePositionToScenePosition(b.p);camera.position.x=a.x;camera.position.y=a.y-this.CENTER_CAMERA_Y_OFFSET;camera.position.z=controls.ZOOM_MIN;controls.target.x=b.m.position.x;controls.target.y=b.m.position.y;controls.target.z=b.m.position.z};gameSurface.centerCameraOnPosition=function(a){controls.reset();camera.position.x=a.x;camera.position.y=a.y-this.CENTER_CAMERA_Y_OFFSET;camera.position.z=controls.ZOOM_MIN;controls.target.x=a.x;controls.target.y=a.y;controls.target.z=0};gameSurface.showElement=function(a){if(a.visible){return}a.visible=true;if(this.shouldMemorizeInFog(a)&&(index=gameSurface.elementsMemorizedInFog.indexOf(utils.getElementFromId(a.id)))>-1){this.elementsMemorizedInFog.splice(index,1);utils.getElementFromId(a.id).m.material=a.material}else{this.showElementModel(a)}};gameSurface.hideElement=function(a){if(!a.visible){return}a.visible=false;if(this.shouldMemorizeInFog(a)){this.elementsMemorizedInFog.push(utils.getElementFromId(a.id));utils.getElementFromId(a.id).m.material=a.hiddenMaterial}else{this.hideElementModel(a)}};gameSurface.showElementModel=function(b){if(b.modelVisible){return}b.modelVisible=true;var a=utils.getElementFromId(b.id).m;scene.add(a)};gameSurface.hideElementModel=function(b,a){if(!b.modelVisible){return}b.modelVisible=false;if(a==undefined){a=utils.getElementFromId(b.id).m}scene.remove(a)};gameSurface.manageElementsVisibility=function(){var c=gameContent.map.size.x;var l=gameContent.map.size.y;var m=[];var s=[];for(var d in gameContent.gameElements){for(var r in gameContent.gameElements[d]){var a=gameContent.gameElements[d][r];if(a.f!=gameData.FAMILIES.land&&rank.isAlly(gameContent.players,gameContent.myArmy,a)){var f=a.p.x;var e=a.p.y;var h=tools.getElementData(a);var v=h.vision;if(a.f==gameData.FAMILIES.building&&a.cp<100){v=2}var u=v*v;var k,i,q,z,g;for(var i=-v;i<=v;i++){q=i*i;for(var k=-v;k<=v;k++){if((g=k*k+q)<=u){var t=Math.sqrt(g);if(t>=v*0.6){z=(v-t)/(v*0.4)}else{z=1}if(m[f+k]==undefined){m[f+k]=[]}if(!m[f+k][e+i]||z>m[f+k][e+i]){m[f+k][e+i]=z}}}}}else{s.push(a)}}}while(s.length>0){var a=s.pop();if(m[a.p.x]!=undefined&&m[a.p.x][a.p.y]){this.showElement(a)}else{this.hideElement(a)}}for(index in this.elementsMemorizedInFog){var a=this.elementsMemorizedInFog[index];if(m[a.p.x]!=undefined&&m[a.p.x][a.p.y]>0){if(utils.getElementFromId(a.id)==null){var w=this.elementsMemorizedInFog[index].m;this.hideElementModel(a,w)}else{console.log("show it");this.showElement(a)}this.elementsMemorizedInFog.splice(index,1)}}var b;var j=false;var p=0,o=1,n=2;for(var i=0;i<l;i++){for(var k=0;k<c;k++,p+=3,o+=3,n+=3){b=(m[k]===undefined)?0:(m[k][i]==undefined)?0:m[k][i];if(b!=this.fogOfWarMatrix[k][i]){this.fogOfWarMatrix[k][i]=b;if(b>this.deepFogOfWarMatrix[k][i]){this.deepFogOfWarMatrix[k][i]=b}else{if(this.deepFogOfWarMatrix[k][i]!=0&&b==0){b=0.1}}j=true;this.fogOfWarDataColor[p]=this.fogOfWarDataColor[o]=this.fogOfWarDataColor[n]=Math.round(b*255)}}}if(j){this.fogOfWarGroundTexture.needsUpdate=true}};gameSurface.shouldMemorizeInFog=function(a){return(a.f==gameData.FAMILIES.land||a.f==gameData.FAMILIES.building)};gameSurface.updateMinimap=function(){var d=0,j,p,t,u,v;for(var f=gameContent.map.size.y-1,q=0;f>=q;f--){for(var h=0,s=gameContent.map.size.x;h<s;h++,d+=4){if(this.deepFogOfWarMatrix[h][f]==0){j=p=t=0}else{if(this.fogOfWarMatrix[h][f]==0){this.minimapData.data[d+3]=128;continue}else{var k=gameContent.grid[h][f];if(k>0){var c=utils.getElementFromId(k);var e=tools.getElementData(c);if(c.modelVisible&&c.f!=gameData.FAMILIES.land||e.minimapColor!=null){if(c.f==gameData.FAMILIES.land){var n=e.minimapColor;j=n.r;p=n.g;t=n.b}else{if(rank.isAlly(gameContent.players,gameContent.myArmy,c)){j=p=t=255}else{var n=gameSurface.PLAYERS_COLORS_RGB[c.o];j=n.r;p=n.g;t=n.b}}if(this.fogOfWarMatrix[h][f]==0){j/=3;p/=3;t/=3}}}else{var w=Math.max(0.1,this.fogOfWarMatrix[h][f]);j=w*20;p=w*40;t=w*20}}}this.minimapData.data[d+0]=j;this.minimapData.data[d+1]=p;this.minimapData.data[d+2]=t;this.minimapData.data[d+3]=255}}this.minimapContext.putImageData(this.minimapData,0,0);var m=this.minimapContext;var l=gameSurface.cameraVisionCorners;m.lineWidth=1;m.strokeStyle="white";m.beginPath();m.moveTo(l[3].x,gameContent.map.size.y-l[3].y);for(var o=0;o<4;o++){m.lineTo(l[o].x,gameContent.map.size.y-l[o].y)}m.stroke()};var GUI={};GUI.toolbar=[];GUI.IMAGES_PATH="img/GUI/";GUI.MOUSE_ICONS={standard:'url("'+GUI.IMAGES_PATH+'cursor.png"), auto',select:'url("'+GUI.IMAGES_PATH+'cursor_hover.png"), auto',attack:'url("'+GUI.IMAGES_PATH+'cursor_attack.png"), auto',cross:'url("'+GUI.IMAGES_PATH+'cursor_cross.png"), auto',crossHover:'url("'+GUI.IMAGES_PATH+'cursor_cross_hover.png"), auto',arrowTop:'url("'+GUI.IMAGES_PATH+'cursor_v.png"), auto',arrowTopRight:'url("'+GUI.IMAGES_PATH+'cursor_sw.png"), auto',arrowTopLeft:'url("'+GUI.IMAGES_PATH+'cursor_se.png"), auto',arrowBottom:'url("'+GUI.IMAGES_PATH+'cursor_v.png"), auto',arrowBottomRight:'url("'+GUI.IMAGES_PATH+'cursor_se.png"), auto',arrowBottomLeft:'url("'+GUI.IMAGES_PATH+'cursor_sw.png"), auto',arrowRight:'url("'+GUI.IMAGES_PATH+'cursor_h.png"), auto',arrowLeft:'url("'+GUI.IMAGES_PATH+'cursor_h.png"), auto'};GUI.UPDATE_FREQUENCY=0.2;GUI.GUI_ELEMENTS={none:0,bottomBar:1,minimap:2};GUI.showBuildings=false;GUI.minimapSize=0;GUI.init=function(){this.initMinimapSize();this.initResourcesBar();this.initCommonButtonsEvents();this.initSpecialButtons();this.initInfobarEvents();$("#gui").tooltip({selector:".enableTooltip"});$.extend($.fn.tooltip.defaults,{animation:false,html:true})};GUI.update=function(){this.updatePopulation();this.updateResources();this.updateToolbar();this.updateInfoBar()};GUI.initResourcesBar=function(){for(var a in gameData.RESOURCES){var b=gameData.RESOURCES[a];$("#topBar").append('<div id="resource'+b.id+'"><div class="sprite"></div><span>0</span></div>')}};GUI.initCommonButtonsEvents=function(){$("#attackButton").click(function(){userInput.enterAttackMode()});$("#stopButton").click(function(){userInput.pressStopKey()});$("#holdButton").click(function(){userInput.pressHoldKey()});$("#patrolButton").click(function(){userInput.enterPatrolMode()})};GUI.initSpecialButtons=function(){$("#specialButtons").on("click","button",function(){if(!$(this).hasClass("disabled")){var a=$(this).attr("data-id");userInput.clickSpecialButton(a)}});$("#queueBuilding").on("click","button",function(){var a=$(this).attr("data-id");userInput.cancelQueue(a)})};GUI.initInfobarEvents=function(){$("#listSelected").on("click","button",function(b){var a=parseInt($(this).attr("data-id"));if(b.ctrlKey&&gameContent.selected.indexOf(a)>-1){gameContent.selected.splice(gameContent.selected.indexOf(a),1);gameSurface.unselectElement(a)}else{if(gameContent.selected.length==1){gameSurface.centerCameraOnElement(utils.getElementFromId(a))}else{gameSurface.unselectAll();gameContent.selected=[a];gameSurface.selectElement(a)}}})};GUI.initMinimapSize=function(){var a=document.getElementById("minimap");this.minimapSize=0.12*window.innerWidth};GUI.updatePopulation=function(){var a=gameContent.players[gameContent.myArmy];$("span","#population").html(a.pop.current+" / "+a.pop.max)};GUI.updateResources=function(){var b=gameContent.players[gameContent.myArmy];for(var a in gameData.RESOURCES){var c=gameData.RESOURCES[a];$("span","#resource"+c.id).html(b.re[c.id])}};GUI.updateInfoBar=function(){if(gameContent.selected.length>0){$.each($("button","#listSelected"),function(){if(gameContent.selected.indexOf(parseInt($(this).attr("data-id")))==-1){$(this).remove()}});for(var e in gameContent.selected){var d=utils.getElementFromId(gameContent.selected[e]);var c=tools.getElementData(d);var g=$('button[data-id="'+d.id+'"]',"#listSelected");if(g.length==0){$("#listSelected").append('<button data-id="'+d.id+'" class="'+gameSurface.getLifeBarBackgroundColor(d.l/c.l)+'"><div class="'+c.g+' sprite"></div></button>')}else{g.attr("class",gameSurface.getLifeBarBackgroundColor(d.l/c.l))}}var d=utils.getElementFromId(gameContent.selected[0]);var c=tools.getElementData(d);$("#nameElement").html(c.name);if(d.f==gameData.FAMILIES.land){$("#lifeElement").html("");$(".landOnly").removeClass("hideI");$(".unitOnly").addClass("hideI");$("#defenseStat").addClass("hideI");$("#popStat").addClass("hideI");$("#queueBuilding").addClass("hideI");if(d.t==gameData.RESOURCES.wood.id){$("span","#resourcesStatWood").html(d.ra);$("#resourcesStatWood").removeClass("hideI");$("#resourcesStatWater").addClass("hideI")}else{if(d.t==gameData.RESOURCES.water.id){$("span","#resourcesStatWater").html(d.ra);$("#resourcesStatWood").addClass("hideI");$("#resourcesStatWater").removeClass("hideI")}else{$("#resourcesStatWood").addClass("hideI");$("#resourcesStatWater").addClass("hideI")}}}else{$(".landOnly").addClass("hideI");$("#lifeElement").html(d.l+"/"+c.l).attr("class",gameSurface.getLifeBarBackgroundColor(d.l/c.l)+" stat");$("span","#popStat").html(c.pop).removeClass("hideI");$("span","#defenseStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.defense)).removeClass("hideI");if(c.attack!=null){$(".unitOnly").removeClass("hideI");$("span","#fragsStat").html(d.fr);$("span","#attackStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.attack));$("span","#attackSpeedStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.attackSpeed));$("span","#rangeStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.range))}else{$(".unitOnly").addClass("hideI")}if(d.f==gameData.FAMILIES.building&&rank.isAlly(gameContent.players,gameContent.myArmy,d)&&d.q.length>0){$("button","#queueBuilding").addClass("hideI");for(var e=0;e<d.q.length;e++){var a=d.q[e];var f=null;if(a>=0){var b=gameData.ELEMENTS[gameData.FAMILIES.unit][d.r];f=b[Object.keys(b)[a]]}else{f=tools.getElementDataFrom(gameData.FAMILIES.research,d.r,a)}if(e==0){$("#queueProgress").html(d.qp+"%")}$(".sprite:eq("+e+")","#queueBuilding").attr("class",f.g+" sprite");$("button:eq("+e+")","#queueBuilding").removeClass("hideI")}$("#queueBuilding").removeClass("hideI")}else{$("button","#queueBuilding").addClass("hideI");$("#queueBuilding").addClass("hideI")}}$("#infoSelected").removeClass("hideI")}else{if($("#listSelected").html()!=""){$("#listSelected").html("")}$("#infoSelected").addClass("hideI")}};GUI.updateToolbar=function(){if(gameContent.selected.length>0&&rank.isAlly(gameContent.players,gameContent.myArmy,utils.getElementFromId(gameContent.selected[0]))){var c=utils.getElementFromId(gameContent.selected[0]);if(c.f==gameData.FAMILIES.building){$("#commonButtons").addClass("hideI");if(c.cp<100){this.toolbar=[gameData.BUTTONS.cancel]}else{this.toolbar=production.getWhatCanBeBought(gameContent.players,c.o,tools.getElementDataFrom(gameData.FAMILIES.building,c.r,c.t).buttons)}}else{if(c.f==gameData.FAMILIES.unit){if(this.showBuildings){$("#commonButtons").addClass("hideI");this.toolbar=this.getBuildingButtons(c)}else{$("#commonButtons").removeClass("hideI");this.toolbar=tools.getElementDataFrom(gameData.FAMILIES.unit,c.r,c.t).buttons}}}$("#specialButtons").removeClass("hideI")}else{this.toolbar=[];$("#commonButtons").addClass("hideI");$("#specialButtons").addClass("hideI")}$("#specialButtons button").addClass("hide");for(var b in this.toolbar){var a=this.toolbar[b];this.createToolbarButton(a)}};GUI.isGUIClicked=function(a,b){if(b>window.innerHeight-120&&a<window.innerWidth-this.minimapSize){return this.GUI_ELEMENTS.bottomBar}else{if(a>window.innerWidth-this.minimapSize&&b>window.innerHeight-this.minimapSize){return this.GUI_ELEMENTS.minimap}else{return this.GUI_ELEMENTS.none}}};GUI.clickOnMinimap=function(b,c){var a=this.convertToMinimapPosition(b,c);gameSurface.centerCameraOnPosition(a)};GUI.convertToMinimapPosition=function(a,b){return{x:parseInt(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE*(this.minimapSize-window.innerWidth+a)/this.minimapSize),y:parseInt(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE*(window.innerHeight-b)/this.minimapSize)}};GUI.fromRealToMinimapPosition=function(a,c){var b={x:parseInt(a/(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE)*this.minimapSize),y:parseInt(c/(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE)*this.minimapSize)};if(b.x<0){b.x=0}else{if(b.x>this.minimapSize-1){b.x=this.minimapSize-1}}if(b.y<0){b.y=0}else{if(b.y>this.minimapSize-1){b.y=this.minimapSize-1}}return b};GUI.getBuildingButtons=function(a){return production.getWhatCanBeBought(gameContent.players,a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r])};GUI.updateMouse=function(a){document.body.style.cursor=a};GUI.createToolbarButton=function(b){if($("#toolbar"+b.id).html()!=null){$("#toolbar"+b.id).removeClass("hide")}else{var d;if(b.needs!=null&&b.needs.length>0){d="<p>"+b.name+"</p>"}else{d=b.name}for(var a in b.needs){var c=b.needs[a];if(c.t>=0){d+='<p class="price"><span class="'+gameData.RESOURCES[Object.keys(gameData.RESOURCES)[c.t]].image+' sprite">&nbsp;</span>'+c.value+"</p>"}else{d+="<p>"+c.t+"</p>"}}var e='<button id="toolbar'+b.id+'" data-id="'+b.id+'" class="enableTooltip" data-toggle="tooltip" title=\''+d+"'><div class=\""+b.g+' sprite"></div></button>';$("#specialButtons").append(e)}if(!b.isEnabled){$("#toolbar"+b.id).addClass("disabled")}else{$("#toolbar"+b.id).removeClass("disabled")}};GUI.selectButton=function(a){this.unselectButtons();$("#toolbar"+a.buttonId).addClass("selected")};GUI.unselectButtons=function(){$("button","#toolbar").removeClass("selected")};socketManager.socket=null;socketManager.connect=function(){this.socket=io.connect();this.socket.on("data",function(a){socketManager.onDataSocket(a)});this.socket.on("gameData",function(a){socketManager.onGameDataSocket(a)})};socketManager.onDataSocket=function(a){switch(a.type){case gameData.TO_CLIENT_SOCKET.login:this.sendSocketToServer(gameData.TO_SERVER_SOCKET.login,gameManager.playerId);break;case gameData.TO_CLIENT_SOCKET.listJoinableGames:gameManager.updateJoinableGamesList(a);break;case gameData.TO_CLIENT_SOCKET.gameStart:gameManager.initOnlineGame(a);break;case gameData.TO_CLIENT_SOCKET.rejoin:gameManager.askRejoin(a);break;case gameData.TO_CLIENT_SOCKET.updateLoadingProgress:gameManager.updateLoadingQueue(a);break;case gameData.TO_CLIENT_SOCKET.updateQueue:gameManager.updateQueue(a);break;case gameData.TO_CLIENT_SOCKET.gameStats:gameManager.showStats(a.playerStatus,a.stats);break}};socketManager.onGameDataSocket=function(a){gameContent.update(a)};socketManager.createNewGame=function(a){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.createNewGame,a)};socketManager.enterSalon=function(){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.enterSalon,null)};socketManager.leaveSalon=function(){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.leaveSalon,null)};socketManager.joinGame=function(a,c,b,e){var d={playerId:a,playerName:c,gameId:b,armyId:e};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.joinGame,d)};socketManager.updateLoadingProgress=function(a,b,d){var c={playerId:a,gameId:b,loadingProgress:d};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.updateLoadingProgress,c)};socketManager.sendOrder=function(b,a,d){var c={gameId:b,type:a,params:d};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.sendOrder,c)};socketManager.sendSocketToServer=function(a,b){this.socket.emit(a,b)};socketManager.rejoinGame=function(a,b){var c={playerId:a,gameId:b};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.rejoinGame,c)};var soundManager={};soundManager.MUSIC_FILES_PATH="music/";soundManager.MUSICS_LIST=["0","1"];soundManager.SOUNDS_LIST={mainButton:"main_button",button:"button",hammer:"hammer",saw:"saw"};soundManager.SOUND_VOLUME=0.5;soundManager.audioFilesFormat=null;soundManager.musicTag=null;soundManager.soundTag=null;soundManager.init=function(){try{this.musicTag=$("audio","#musicTags")[0];this.soundTag=$("audio","#musicTags")[1];if(this.musicTag.canPlayType("audio/ogg")!=""){this.audioFilesFormat=".ogg"}else{if(this.musicTag.canPlayType("audio/mp3")!=""){this.audioFilesFormat=".mp3"}}this.musicTag.addEventListener("ended",function(){soundManager.musicTag.src=null;soundManager.playMusic()});this.soundTag.volume=this.SOUND_VOLUME}catch(a){}};soundManager.playMusic=function(){if(gameManager.musicEnabled&&this.audioFilesFormat!=null){if(this.musicTag.src==null||this.musicTag.src==""){this.musicTag.src=this.MUSIC_FILES_PATH+this.getRandomMusic()+this.audioFilesFormat}this.musicTag.play()}};soundManager.stopMusic=function(){if(this.audioFilesFormat!=null){this.musicTag.pause();this.soundTag.pause()}};soundManager.playSound=function(a){if(gameManager.musicEnabled&&this.audioFilesFormat!=null){this.soundTag.src=this.MUSIC_FILES_PATH+a+this.audioFilesFormat;this.soundTag.play()}};soundManager.getRandomMusic=function(){return this.MUSICS_LIST[parseInt(Math.random()*this.MUSICS_LIST.length)]};var userInput={};userInput.CAN_BE_BUILT_HERE=10;userInput.CANNOT_BE_BUILT_HERE=1;userInput.DOUBLE_CLICK_RADIUS_SIZE=15;userInput.isChatWindowOpen=false;userInput.hotKeysContent=[[],[],[],[],[]];userInput.doSelect=function(c,h,e,d){var b=GUI.isGUIClicked(c,h);if(b==GUI.GUI_ELEMENTS.bottomBar){return}else{if(b==GUI.GUI_ELEMENTS.minimap){GUI.clickOnMinimap(c,h);return}}if(gameContent.building!=null){this.tryBuildHere(d);return false}else{this.leaveConstructionMode();if(!e){gameSurface.unselectAll();gameContent.selected=[]}gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1);gameContent.selectionRectangle[0]=c;gameContent.selectionRectangle[1]=h;var a=gameSurface.getFirstIntersectObject(c,h);if(a!=null){if(a.object.elementId!=null){if(e&&gameContent.selected.indexOf(a.object.elementId)>-1){gameContent.selected.splice(gameContent.selected.indexOf(a.object.elementId),1);gameSurface.unselectElement(a.object.elementId)}else{gameContent.selected.push(a.object.elementId);gameSurface.selectElement(a.object.elementId)}}}if(gameContent.selected.length>1){for(var g in gameContent.selected){var f=""+gameContent.selected[g];if(parseInt(f.charAt(1))==gameData.FAMILIES.land){gameSurface.unselectElement(gameContent.selected[g]);gameContent.selected.splice(g,1);break}}}return true}};userInput.doAction=function(b,h,c,f){var a=GUI.isGUIClicked(b,h);if(a==GUI.GUI_ELEMENTS.bottomBar){return}if(gameContent.building!=null){this.leaveConstructionMode()}else{if(gameContent.selected.length>0){var e=utils.getElementFromId(gameContent.selected[0]);if(rank.isAlly(gameContent.players,gameContent.myArmy,e)&&(e.f==gameData.FAMILIES.unit||e.f==gameData.FAMILIES.building)){var g=false;var a=GUI.isGUIClicked(b,h);if(a==GUI.GUI_ELEMENTS.minimap){var d=GUI.convertToMinimapPosition(b,h);b=d.x;h=d.y;g=true}this.dispatchUnitAction(b,h,c,f,g)}}}};userInput.doDoubleClick=function(a,f){if(gameContent.selected.length>0){var e=utils.getElementFromId(gameContent.selected[0]);if(rank.isAlly(gameContent.players,gameContent.myArmy,e)){var b=tools.getTilesAround(gameContent.grid,e.p,this.DOUBLE_CLICK_RADIUS_SIZE,true);for(var d in b){if(b[d]>0){var c=utils.getElementFromId(b[d]);if(gameContent.selected.indexOf(c.id)==-1&&c.f==e.f&&rank.isAlly(gameContent.players,gameContent.myArmy,c)&&c.t==e.t){gameContent.selected.push(c.id);gameSurface.selectElement(c.id)}}}}}};userInput.pressToolbarShortcut=function(a){};userInput.pressEnterKey=function(){if(this.isChatWindowOpen){$("#chat").addClass("hide");var a=$("input","#chat").val();if(a!=""){if(a=="olivier !"||a=="/soundon"){gameManager.musicEnabled=true;soundManager.playMusic();gameSurface.showMessage(gameSurface.MESSAGES.musicEnabled)}else{if(a=="paranormalement"||a=="/soundoff"){gameManager.musicEnabled=false;soundManager.stopMusic();gameSurface.showMessage(gameSurface.MESSAGES.musicDisabled)}else{if(a=="/surrender"){gameManager.sendOrderToEngine(order.TYPES.surrender,[gameContent.myArmy])}else{gameManager.sendOrderToEngine(order.TYPES.chat,[gameContent.myArmy,$("input","#chat").val()])}}}}$("input","#chat").val("")}else{$("#chat").removeClass("hide");$("#chat").css("top",(window.innerHeight-$("#chat").height())/2);$("#chat").css("left",(window.innerWidth-$("#chat").width())/2);$("input","#chat")[0].focus()}this.isChatWindowOpen=!this.isChatWindowOpen};userInput.pressSpaceKey=function(){if(gameContent.selected.length>0){gameSurface.centerCameraOnElement(utils.getElementFromId(gameContent.selected[0]))}};userInput.onMouseMove=function(a,b){this.updateConstructionMode(a,b);this.updateMouseIcon(a,b)};userInput.onMouseUp=function(){this.removeSelectionRectangle()};userInput.clickSpecialButton=function(f){soundManager.playSound(soundManager.SOUNDS_LIST.button);if(f==gameData.BUTTONS.build.id){GUI.showBuildings=true}else{if(f==gameData.BUTTONS.back.id){GUI.showBuildings=false}else{if(f==gameData.BUTTONS.cancel.id){gameManager.sendOrderToEngine(order.TYPES.cancelConstruction,[utils.getElementFromId(gameContent.selected[0]).id])}else{if(GUI.showBuildings){var d=gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[gameContent.myArmy].r];var c=d[Object.keys(d)[(""+f)[2]]];this.enterConstructionMode(c)}else{if(utils.getElementFromId(gameContent.selected[0]).f==gameData.FAMILIES.building){var e=(""+f)[0];var b;if(e==gameData.FAMILIES.unit){var a=gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[gameContent.myArmy].r];b=a[Object.keys(a)[(""+f)[2]]]}else{var g=gameData.ELEMENTS[gameData.FAMILIES.research][gameContent.players[gameContent.myArmy].r];b=g[(""+f).substring(2)]}gameManager.sendOrderToEngine(order.TYPES.buy,[gameContent.selected,b])}}}}}};userInput.enterConstructionMode=function(a){gameContent.building=a;GUI.selectButton(a);this.updateConstructionMode(controls.mousePosition.x,controls.mousePosition.y)};userInput.updateConstructionMode=function(a,d){if(gameContent.building!=null){gameContent.building.p=gameSurface.getAbsolutePositionFromPixel(a,d);gameContent.building.canBeBuiltHere=true;for(var c in gameContent.building.shape){for(var b in gameContent.building.shape[c]){gameContent.building.shape[c][b]=this.CAN_BE_BUILT_HERE}}utils.canBeBuiltHere(gameContent.building);gameSurface.updateBuildingGeometry()}};userInput.leaveConstructionMode=function(){gameContent.building=null;gameSurface.removeBuildingGeometry();GUI.unselectButtons();GUI.showBuildings=false};userInput.updateMouseIcon=function(c,b){var d=gameSurface.getFirstIntersectObject(c,b);var a=-controls.scroll[0];var g=controls.scroll[1];if(d!=null&&d.object.elementId!=null){var f=utils.getElementFromId(d.object.elementId);if(controls.clickMode!=controls.MODES.normal){GUI.updateMouse(GUI.MOUSE_ICONS.crossHover);return}else{if(f!=null&&f.f!=gameData.FAMILIES.land&&rank.isEnemy(gameContent.players,gameContent.myArmy,f)){GUI.updateMouse(GUI.MOUSE_ICONS.attack)}else{GUI.updateMouse(GUI.MOUSE_ICONS.select)}}}else{if(controls.clickMode!=controls.MODES.normal){GUI.updateMouse(GUI.MOUSE_ICONS.cross)}else{if(!controls.isKeyboardScrolling){if(a>0&&g>0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopRight)}else{if(a>0&&g==0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowRight)}else{if(a>0&&g<0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomRight)}else{if(a<0&&g>0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopLeft)}else{if(a<0&&g==0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowLeft)}else{if(a<0&&g<0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomLeft)}else{if(a==0&&g>0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowTop)}else{if(a==0&&g<0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottom)}else{GUI.updateMouse(GUI.MOUSE_ICONS.standard)}}}}}}}}}}}};userInput.tryBuildHere=function(a){if(gameContent.building.canBeBuiltHere){soundManager.playSound(soundManager.SOUNDS_LIST.hammer);gameManager.sendOrderToEngine(order.TYPES.buildThatHere,[gameContent.selected,gameContent.building,gameContent.building.p.x,gameContent.building.p.y,a]);if(!a){this.leaveConstructionMode()}}else{}};userInput.dispatchUnitAction=function(b,g,c,e,f){var a=null;if(f){a={x:parseInt(b/gameSurface.PIXEL_BY_NODE),y:parseInt(g/gameSurface.PIXEL_BY_NODE)}}else{var d=gameSurface.getFirstIntersectObject(b,g);if(d!=null){if(d.object.elementId!=null){a=utils.getElementFromId(d.object.elementId).p;gameSurface.animateSelectionCircle(d.object.elementId)}else{a={x:parseInt(d.point.x/gameSurface.PIXEL_BY_NODE),y:parseInt(d.point.y/gameSurface.PIXEL_BY_NODE)}}}}if(a!=null&&a.x>=0&&a.y>=0&&a.x<gameContent.map.size.x&&a.y<gameContent.map.size.y){gameManager.sendOrderToEngine(order.TYPES.action,[gameContent.selected,a.x,a.y,c,e])}};userInput.drawSelectionRectangle=function(o,n,m){if(gameContent.selectionRectangle.length>0){if(!m){gameSurface.unselectAll();gameContent.selected=[]}var b=false;gameSurface.updateSelectionRectangle(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1],o,n);var f=gameSurface.getFirstIntersectObject(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1]).point;var e=gameSurface.getFirstIntersectObject(o,n).point;var c=gameSurface.convertScenePositionToGamePosition(f);var a=gameSurface.convertScenePositionToGamePosition(e);var p=[c.x,c.y,a.x,a.y];for(var k=Math.min(p[0],p[2]);k<=Math.max(p[0],p[2]);k++){for(var g=Math.min(p[1],p[3]);g<=Math.max(p[1],p[3]);g++){if(gameContent.grid[k][g]>0){var h=utils.getElementFromId(gameContent.grid[k][g]);if(rank.isAlly(gameContent.players,gameContent.myArmy,h)){if(!m||gameContent.selected.indexOf(h.id)==-1){gameContent.selected.push(h.id);gameSurface.selectElement(h.id);b=true}}}}}for(var k in gameContent.selected){var d=""+gameContent.selected[k];if(d.charAt(1)==gameData.FAMILIES.unit){var l=gameContent.selected.length;while(l--){var h=utils.getElementFromId(gameContent.selected[l]);if(h.f==gameData.FAMILIES.building){gameContent.selected.splice(l,1);gameSurface.unselectElement(h.id)}}break}}if(b){var l=gameContent.selected.length;while(l--){var h=utils.getElementFromId(gameContent.selected[l]);if(h.f==gameData.FAMILIES.land){gameContent.selected.splice(l,1);gameSurface.unselectElement(h.id)}}}}};userInput.removeSelectionRectangle=function(){gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1)};userInput.pressStopKey=function(){if(gameContent.selected.length>0){gameManager.sendOrderToEngine(order.TYPES.stop,[gameContent.selected])}};userInput.pressHoldKey=function(){if(gameContent.selected.length>0){gameManager.sendOrderToEngine(order.TYPES.hold,[gameContent.selected])}};userInput.enterPatrolMode=function(){if(gameContent.selected.length>0){GUI.unselectButtons();$("#patrolButton").addClass("selected");controls.clickMode=controls.MODES.patrol}};userInput.enterAttackMode=function(){if(gameContent.selected.length>0){GUI.unselectButtons();$("#attackButton").addClass("selected");controls.clickMode=controls.MODES.attack}};userInput.leaveSpecialClickMode=function(){GUI.unselectButtons();GUI.updateMouse(GUI.MOUSE_ICONS.standard);controls.clickMode=controls.MODES.normal};userInput.pressHotKey=function(b,a){if(a){this.hotKeysContent[b]=[];for(var c in gameContent.selected){this.hotKeysContent[b].push(gameContent.selected[c])}}else{var d=this.hotKeysContent[b].length;if(d==0){return}while(d--){if(utils.getElementFromId(this.hotKeysContent[b][d])==null){this.hotKeysContent[b].splice(d,1)}}if(gameContent.selected.length==this.hotKeysContent[b].length&&this.hotKeysContent[b].indexOf(gameContent.selected[0])>-1){gameSurface.centerCameraOnElement(utils.getElementFromId(gameContent.selected[0]))}gameSurface.unselectAll();gameContent.selected=[];for(var c in this.hotKeysContent[b]){gameContent.selected.push(this.hotKeysContent[b][c]);gameSurface.selectElement(this.hotKeysContent[b][c])}}};userInput.cancelQueue=function(a){gameManager.sendOrderToEngine(order.TYPES.cancelQueue,[gameContent.selected[0],a])};var utils={};utils.readCookie=function(b){var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length)}if(f.indexOf(e)==0){return f.substring(e.length,f.length)}}return null};utils.createCookie=function(a,b){document.cookie=a+"="+b+"; path=/"};utils.canBeBuiltHere=function(d){var e=tools.getPartPosition(d,0,0);var c={x:e.x+d.shape[0].length-1,y:e.y+d.shape.length-1};for(var b=e.x;b<=c.x;b++){for(var a=e.y;a<=c.y;a++){if(gameContent.grid[b]!=null&&gameContent.grid[b][a]>0||gameSurface.fogOfWarMatrix[b]!=null&&!gameSurface.fogOfWarMatrix[b][a]){d.canBeBuiltHere=false;d.shape[b-e.x][a-e.y]=userInput.CANNOT_BE_BUILT_HERE}}}};utils.getElementFromId=function(a){return gameContent.gameElements[Object.keys(gameData.FAMILIES)[(""+a)[1]]][a]};utils.copyValuesToObject=function(b,c){if(b==null||typeof(b)!="object"){return b}for(var a in b){console.log(a);if(c[a]==undefined){c[a]={}}c[a]=utils.copyValuesToObject(b[a],c[a])}return c};