var gameSurface={},scene,camera;gameSurface.IMG_PATH="js/game/data/g/";gameSurface.MODELS_PATH="js/game/data/g/3D/";gameSurface.PIXEL_BY_NODE=10;gameSurface.NEAR=1;gameSurface.FAR=2E3;gameSurface.ZOOM_MAX=30;gameSurface.ZOOM_MIN=150;gameSurface.ZOOM_STEP=15;gameSurface.ZOOM_ROTATION_STEP=0.1;gameSurface.ORDER_ANIMATION_SPEED=0.015;gameSurface.ORDER_ROTATION_SPEED=1/12;gameSurface.ORDER_SIZE_MAX=0.9;gameSurface.ORDER_SIZE_MIN=0.5;gameSurface.ORDER_OPACITY=0.3;gameSurface.FOG_DENSITY=5E-4;
gameSurface.SELECTION_ENEMY_COLOR="#f00";gameSurface.SELECTION_ALLY_COLOR="#0f0";gameSurface.SELECTION_NEUTRAL_COLOR="#e3e314";gameSurface.CAMERA_INIT_ANGLE=0.7;gameSurface.CAN_BUILD_CUBE_COLOR=65280;gameSurface.CANNOT_BUILD_CUBE_COLOR=16711680;gameSurface.BUILD_CUBE_OPACITY=0.5;gameSurface.MAP_SCROLL_SPEED=10;gameSurface.MAP_SCROLL_X_MIN=0;gameSurface.MAP_SCROLL_Y_MIN=0;gameSurface.CENTER_CAMERA_Y_OFFSET=10*gameSurface.PIXEL_BY_NODE;gameSurface.BARS_HEIGHT=0.5;gameSurface.BARS_DEPTH=0.2;
gameSurface.BUILDING_STRUCTURE_SIZE=5;gameSurface.BUILDING_INIT_Z=-2*gameSurface.PIXEL_BY_NODE;gameSurface.ARMIES_COLORS=["_red","_blu","_gre","_yel"];gameSurface.PLAYERS_COLORS=["red","blue","green","yellow"];gameSurface.MOVEMENT_EXTRAPOLATION_ITERATION=6;gameSurface.TERRAIN_HEIGHT_SMOOTH_FACTOR=65;gameSurface.iteration=0;gameSurface.geometries=null;gameSurface.materials=null;gameSurface.scroll=[0,0];gameSurface.isKeyboardScrolling=!1;gameSurface.stuffToBeLoaded=0;gameSurface.ex=[];
gameSurface.orderFactor=-1;gameSurface.loader=null;gameSurface.projector=null;gameSurface.order=null;gameSurface.canBuildHereMaterial=null;gameSurface.cannotBuildHereMaterial=null;gameSurface.basicCubeGeometry=null;gameSurface.building=null;
gameSurface.init=function(){function a(){gameSurface.iteration=1E3<gameSurface.iteration?0:gameSurface.iteration+1;requestAnimationFrame(a);gameSurface.updateMoveExtrapolation();gameSurface.updateGameWindow();gameSurface.updateOrderPosition();TWEEN.update();0==gameSurface.iteration%5&&GUI.update();renderer.render(scene,camera)}$("#loadingLabel").html("Loading");scene=new THREE.Scene;camera=new THREE.PerspectiveCamera(60,window.innerWidth/window.innerHeight,this.NEAR,this.FAR);camera.position.x=0;
camera.position.y=0;camera.position.z=this.ZOOM_MIN;camera.rotation.x=this.CAMERA_INIT_ANGLE;scene.fog=new THREE.Fog(16777215,this.FOG_DENSITY,600);renderer=new THREE.WebGLRenderer;renderer.setSize(window.innerWidth-5,window.innerHeight-5);document.body.appendChild(renderer.domElement);this.projector=new THREE.Projector;this.geometries={};this.materials={};this.loader=new THREE.JSONLoader;gameSurface.stuffToBeLoaded+=2;for(var b in gameData.ELEMENTS)for(var c in gameData.ELEMENTS[b])for(var d in gameData.ELEMENTS[b][c])gameSurface.stuffToBeLoaded+=
2,b!=gameData.FAMILIES.terrain&&(gameSurface.stuffToBeLoaded+=gameContent.players.length-1);this.createScene();this.init3DModels();window.addEventListener("resize",this.onWindowResize,!1);a()};
gameSurface.createScene=function(){var a=new THREE.PointLight(16777215);a.position.x=0;a.position.y=0;a.position.z=150;scene.add(a);var b=[],c=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(this.MODELS_PATH+"skybox.jpg",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})});c.side=THREE.BackSide;for(a=0;6>a;a++)b.push(c);c=new THREE.MeshFaceMaterial(b);a=new THREE.CubeGeometry(2E3,2E3,2E3);a=new THREE.Mesh(a,c);a.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-
5;a.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;scene.add(a);a=new THREE.PlaneGeometry(2200,2200,64,64);c=THREE.ImageUtils.loadTexture(this.MODELS_PATH+"grass.png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()});c.wrapT=c.wrapS=THREE.RepeatWrapping;c=new THREE.MeshBasicMaterial({map:c});a=new THREE.Mesh(a,c);a.position.x=gameContent.map.size.x*this.PIXEL_BY_NODE/2-5;a.position.y=gameContent.map.size.y*this.PIXEL_BY_NODE/2;a.overdraw=!0;scene.add(a);this.order=new THREE.Mesh(new THREE.TorusGeometry(5,
2,2,6),new THREE.LineBasicMaterial({color:"#0f0",opacity:this.ORDER_OPACITY,transparent:!0}));this.order.visible=!1;scene.add(this.order);this.canBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CAN_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:!0});this.cannotBuildHereMaterial=new THREE.LineBasicMaterial({color:this.CANNOT_BUILD_CUBE_COLOR,opacity:this.BUILD_CUBE_OPACITY,transparent:!0});this.basicCubeGeometry=new THREE.CubeGeometry(this.PIXEL_BY_NODE,this.PIXEL_BY_NODE,this.PIXEL_BY_NODE);
this.building=new THREE.Object3D;for(a=0;a<this.BUILDING_STRUCTURE_SIZE;a++)for(c=0;c<this.BUILDING_STRUCTURE_SIZE;c++)b=new THREE.Mesh(this.basicCubeGeometry,this.canBuildHereMaterial),b.position.x=a*this.PIXEL_BY_NODE,b.position.y=c*this.PIXEL_BY_NODE,b.visible=!1,this.building.add(b);this.building.visible=!1;scene.add(this.building)};
gameSurface.init3DModels=function(){for(var a in gameData.ELEMENTS)for(var b in gameData.ELEMENTS[a])for(var c in gameData.ELEMENTS[a][b]){var d=gameData.ELEMENTS[a][b][c];null==this.geometries[d.g]&&(this.geometries[d.g]={},this.loadObject(d.g,a))}};
gameSurface.loadObject=function(a,b){this.loader.load(this.MODELS_PATH+a,this.geometryLoaded(a));if(b!=gameData.FAMILIES.terrain)for(var c=0;c<gameContent.players.length;c++){var d=this.ARMIES_COLORS[c];gameSurface.materials[a+d]=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+a.replace(".js","")+d+".png",new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})})}else gameSurface.materials[a]=new THREE.MeshBasicMaterial({map:THREE.ImageUtils.loadTexture(gameSurface.MODELS_PATH+
a.replace(".js",".png"),new THREE.UVMapping,function(){gameSurface.updateLoadingCounter()})})};gameSurface.geometryLoaded=function(a){return function(b){gameSurface.geometries[a]=b;gameSurface.updateLoadingCounter()}};gameSurface.updateLoadingCounter=function(){this.stuffToBeLoaded--;0==this.stuffToBeLoaded&&gameManager.startGame()};
gameSurface.updateGameWindow=function(){camera.position.x+this.scroll[0]>=this.MAP_SCROLL_X_MIN&&camera.position.x+this.scroll[0]<=gameContent.map.size.x*this.PIXEL_BY_NODE?camera.position.x+=this.scroll[0]:this.scroll[0]=0;camera.position.y+this.scroll[1]>=this.MAP_SCROLL_Y_MIN&&camera.position.y+this.scroll[1]<=gameContent.map.size.y*this.PIXEL_BY_NODE?camera.position.y+=this.scroll[1]:this.scroll[1]=0};
gameSurface.updateScrolling=function(a,b,c){this.scroll[a]=b*this.MAP_SCROLL_SPEED;c&&(this.isKeyboardScrolling=0==b?!1:!0)};gameSurface.updateZoom=function(a){var b=camera.position.z-a*this.ZOOM_STEP;b<=this.ZOOM_MIN&&b>=this.ZOOM_MAX&&(camera.position.z=b,camera.rotation.x+=0>a?-this.ZOOM_ROTATION_STEP:this.ZOOM_ROTATION_STEP)};
gameSurface.onWindowResize=function(){camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth-5,window.innerHeight-5)};gameSurface.addElement=function(a){this.createObject(gameData.ELEMENTS[a.f][a.r][a.t].g,a)};
gameSurface.createObject=function(a,b){var c=new THREE.Mesh(this.geometries[a],b.f==gameData.FAMILIES.terrain?this.materials[a]:this.materials[a+this.ARMIES_COLORS[b.o]]);c.elementId=b.id;this.setElementPosition(c,b.p.x,b.p.y);"tree.js"==a?(c.rotation.x=this.de2ra(90),c.rotation.y=this.de2ra(360*Math.random()),c.scale.y=1.3):"castle.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=3,c.scale.y=3,c.scale.z=3):"goldmine.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=1.5,c.scale.y=1.5,c.scale.z=1.5,c.rotation.y=
this.de2ra(360*Math.random())):"house.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=3,c.scale.y=3,c.scale.z=3):"casern.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.y=2,c.scale.z=2):"peon.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.y=2,c.scale.z=2):"swordsman.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.y=2,c.scale.z=2):"bowman.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.y=2,c.scale.z=2):"knight.js"==a?(c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.y=
2,c.scale.z=2):"tower.js"==a&&(c.rotation.x=this.de2ra(90),c.scale.x=2,c.scale.z=2,c.scale.y=2);b.f==gameData.FAMILIES.building&&100>b.cp&&(c.position.z+=this.BUILDING_INIT_Z);b.f!=gameData.FAMILIES.terrain&&GUI.addElementOnMinimap(b);scene.add(c);gameContent.gameElements[b.id]={d:c,s:b}};
gameSurface.updateElement=function(a){var b=gameContent.gameElements[a.id].d,c=gameContent.gameElements[a.id].s;if(a.f==gameData.FAMILIES.unit){var d=a.p.x-c.p.x,e=a.p.y-c.p.y;if(0!=d||0!=e)this.updateOrientation(b,d,e),this.extrapol(b,d,e)}(gameManager.isOfflineGame||a.f==gameData.FAMILIES.building)&&this.setElementPosition(b,a.p.x,a.p.y);d=gameData.ELEMENTS[a.f][a.r][a.t];if(a.f==gameData.FAMILIES.building&&rank.isAlly(gameContent.players,gameContent.myArmy,a))if(100>a.cp)b.position.z-=(100-a.cp)/
20*this.PIXEL_BY_NODE;else if(0<a.q.length){var e=null,f;for(f in b.children)if("prog"==b.children[f].id){e=b.children[f];break}null==e?(e=new THREE.Mesh(new THREE.CubeGeometry(this.BARS_DEPTH,this.BARS_HEIGHT,1),new THREE.MeshBasicMaterial({color:16777215})),e.id="prog",e.position.x=d.shape.length/3*this.PIXEL_BY_NODE/2,e.position.y=d.height+1,e.rotation.y=this.de2ra(90),b.add(e)):(e.scale.z=a.qp/100*d.shape.length/3*this.PIXEL_BY_NODE,e.position.x=d.shape.length/3*this.PIXEL_BY_NODE/2*(1-a.qp/100),
99<=a.qp&&gameContent.players[gameContent.myArmy].pop.current==gameContent.players[gameContent.myArmy].pop.max&&this.showMessage(this.MESSAGES.popLimitReached))}else for(f in b.children)"prog"==b.children[f].id&&b.remove(b.children[f]);if(a.f!=gameData.FAMILIES.terrain){for(f in b.children)if("life"==b.children[f].id){this.updateLifeBar(b.children[f],a,d);b.children[f].rotation.y=-b.rotation.y+this.de2ra(90);break}GUI.updateElementOnMinimap(a);a.o==gameContent.myArmy&&c.l>a.l&&GUI.addAlertMinimap(a)}gameContent.gameElements[a.id]=
{d:b,s:a}};gameSurface.removeElement=function(a){scene.remove(gameContent.gameElements[a.id].d);0<=gameContent.selected.indexOf(a.id)&&gameContent.selected.splice(gameContent.selected.indexOf(a.id),1);a.f!=gameData.FAMILIES.terrain&&GUI.removeElementFromMinimap(a);delete gameContent.gameElements[a.id]};gameSurface.getAbsolutePositionFromPixel=function(a,b){var c=this.getFirstIntersectObject(a,b);return null!=c?this.convertScenePositionToGamePosition(c.point):{x:0,y:0}};
gameSurface.getFirstIntersectObject=function(a,b){var c=new THREE.Vector3(2*(a/window.innerWidth)-1,2*-(b/window.innerHeight)+1,0.5);this.projector.unprojectVector(c,camera);c=(new THREE.Raycaster(camera.position,c.sub(camera.position).normalize())).intersectObjects(scene.children);return 0<c.length?c[0]:null};gameSurface.centerCameraOnElement=function(a){a=this.convertGamePositionToScenePosition(a.p);camera.position.x=a.x;camera.position.y=a.y-this.CENTER_CAMERA_Y_OFFSET};gameSurface.setElementPosition=function(a,b,c){b=this.convertGamePositionToScenePosition({x:b,y:c});a.position.x=b.x;a.position.y=b.y;a.position.z=0.5};gameSurface.convertGamePositionToScenePosition=function(a){return{x:a.x*this.PIXEL_BY_NODE,y:a.y*this.PIXEL_BY_NODE,z:0}};gameSurface.convertScenePositionToGamePosition=function(a){return{x:Math.min(gameContent.map.size.x-2,Math.max(0,parseInt(a.x/this.PIXEL_BY_NODE))),y:Math.min(gameContent.map.size.y-2,Math.max(0,parseInt(a.y/this.PIXEL_BY_NODE)))}};
gameSurface.drawSelectionCircle=function(a,b){for(var c=new THREE.MeshBasicMaterial({color:b}),d=new THREE.Geometry,e=0;100>=e;e++){var f=3.6*e*Math.PI/180;d.vertices.push(new THREE.Vector3(Math.cos(f)*a,0,Math.sin(f)*a))}c=new THREE.Line(d,c);c.id="select";return c};
gameSurface.drawLifeBar=function(a,b){var c=new THREE.Mesh(new THREE.CubeGeometry(this.BARS_DEPTH,this.BARS_HEIGHT,1),new THREE.MeshBasicMaterial({color:16777215}));c.id="life";c.position.x=0;c.position.y=b.height;c.rotation.y=this.de2ra(90);this.updateLifeBar(c,a,b);return c};gameSurface.updateLifeBar=function(a,b,c){var d=b.l/c.l;a.scale.z=c.shape.length/3*this.PIXEL_BY_NODE*b.l/c.l;a.material.color.setHex(this.getLifeBarColor(d))};
gameSurface.updateOrderPosition=function(){if(0<gameContent.selected.length&&(null!=gameContent.gameElements[gameContent.selected[0]].s.mt&&null!=gameContent.gameElements[gameContent.selected[0]].s.mt.x||null!=gameContent.gameElements[gameContent.selected[0]].s.rp||null!=gameContent.gameElements[gameContent.selected[0]].s.a)){var a;a=null!=gameContent.gameElements[gameContent.selected[0]].s.a?gameContent.gameElements[gameContent.selected[0]].s.a.p:null!=gameContent.gameElements[gameContent.selected[0]].s.rp?
gameContent.gameElements[gameContent.selected[0]].s.rp:gameContent.gameElements[gameContent.selected[0]].s.mt;this.setElementPosition(this.order,a.x,a.y);this.order.rotation.z+=gameSurface.ORDER_ROTATION_SPEED;this.order.scale.x>=gameSurface.ORDER_SIZE_MAX?gameSurface.orderFactor=-1:this.order.scale.x<=gameSurface.ORDER_SIZE_MIN&&(gameSurface.orderFactor=1);this.order.scale.x+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor;this.order.scale.y+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor;
this.order.visible=!0}else this.order.visible&&(this.order.visible=!1)};gameSurface.updateSelectionRectangle=function(a,b,c,d){var e=Math.abs(a-c),f=Math.abs(b-d);0<e&&0<f?($("#selectionRectangle").css("top",Math.min(b,d)).css("left",Math.min(a,c)),$("#selectionRectangle").css("width",e).css("height",f),$("#selectionRectangle").removeClass("hide")):$("#selectionRectangle").addClass("hide")};gameSurface.de2ra=function(a){return a*(Math.PI/180)};
gameSurface.selectElement=function(a){var b=gameContent.gameElements[a].s,c=gameData.ELEMENTS[b.f][b.r][b.t],d;d=rank.isEnemy(gameContent.players,gameContent.myArmy,b)?this.SELECTION_ENEMY_COLOR:rank.isAlly(gameContent.players,gameContent.myArmy,b)?this.SELECTION_ALLY_COLOR:this.SELECTION_NEUTRAL_COLOR;a=gameContent.gameElements[a].d;a.add(this.drawSelectionCircle(c.shape.length/2*this.PIXEL_BY_NODE/2,d));b.f!=gameData.FAMILIES.terrain&&(b=this.drawLifeBar(b,c),b.rotation.y=-a.rotation.y+this.de2ra(90),
a.add(b))};gameSurface.unselectElement=function(a){try{for(var b=gameContent.gameElements[a].d,c=b.children.length;c--;){var d=b.children[c];("select"==d.id||"life"==d.id)&&b.remove(d)}}catch(e){}};gameSurface.unselectAll=function(){for(var a in gameContent.selected)this.unselectElement(gameContent.selected[a])};
gameSurface.updateOrientation=function(a,b,c){0==b&&0>c||(0<b&&0>c?a.rotation.y=this.de2ra(45):0<b&&0==c?a.rotation.y=this.de2ra(90):0<b&&0<c?a.rotation.y=this.de2ra(135):0==b&&0<c?a.rotation.y=this.de2ra(180):0>b&&0<c?a.rotation.y=this.de2ra(225):0>b&&0==c?a.rotation.y=this.de2ra(270):0>b&&0>c&&(a.rotation.y=this.de2ra(315)))};
gameSurface.updateBuildingGeometry=function(){for(var a in this.building.children)this.building.children[a].visible=!1;var b=gameContent.building.shape;for(a in b)for(var c in b){var d;if(b[a][c]==userInput.CAN_BE_BUILT_HERE)d=this.canBuildHereMaterial;else if(b[a][c]==userInput.CANNOT_BE_BUILT_HERE)d=this.cannotBuildHereMaterial;else continue;var e=a*this.BUILDING_STRUCTURE_SIZE+parseInt(c);this.building.children[e].material=d;this.building.children[e].visible=!0}this.setElementPosition(this.building,
gameContent.building.p.x-parseInt(b.length/2),gameContent.building.p.y-parseInt(b.length/2));this.building.visible=!0};gameSurface.removeBuildingGeometry=function(){for(var a in this.building.children)this.building.children[a].visible=!1;this.building.visible=!1};
gameSurface.animateSelectionCircle=function(a){this.selectElement(a);var b=gameContent.gameElements[a].d,c,d;for(d in b.children)if("select"==b.children[d].id){c=b.children[d];break}b=(new TWEEN.Tween({alpha:1})).delay(300).to({alpha:0},300).onComplete(function(){c.visible=!1}).start();d=(new TWEEN.Tween({alpha:0})).to({alpha:1},300).onComplete(function(){c.visible=!0});var e=(new TWEEN.Tween({alpha:0})).to({alpha:1},500).onComplete(function(){gameSurface.unselectElement(a)});b.chain(d);d.chain(e)};
gameSurface.getLifeBarColor=function(a){return 0.3>a?16711680:0.6>a?14934804:65280};gameSurface.MESSAGES={popLimitReached:{id:0,text:"You need more houses"}};
gameSurface.showMessage=function(a,b){if(0==$("#message"+a.id).length){$("#messages").append('<div><div id="message'+a.id+'" class="fadeOut easeTransition">'+a.text+"</div></div>");null==b?$("#message"+a.id).addClass("white"):$("#message"+a.id).addClass(b);var c=(new TWEEN.Tween({alpha:0})).to({alpha:1},100).onComplete(function(){$("#message"+a.id).removeClass("fadeOut")}).start(),d=(new TWEEN.Tween({alpha:0})).to({alpha:1},9E3).onComplete(function(){$("#message"+a.id).addClass("fadeOut")}),e=(new TWEEN.Tween({alpha:0})).to({alpha:1},
500).onComplete(function(){$("#message"+a.id).parent("div").remove()});c.chain(d);d.chain(e)}};gameSurface.extrapol=function(a,b,c){a.ex=b;a.ey=c;a.et=this.MOVEMENT_EXTRAPOLATION_ITERATION;this.ex.push(a)};
gameSurface.updateMoveExtrapolation=function(){for(var a=this.ex.length;a--;){var b=this.ex[a];b.position.x+=b.ex*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION;b.position.y+=b.ey*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION;b.et-=1;if(0>=b.et&&null!=gameContent.gameElements[b.elementId]){var c=gameContent.gameElements[b.elementId].s;this.setElementPosition(b,c.p.x,c.p.y);b.et=0;b.ex=0;b.ey=0;this.ex.splice(a,1)}}};var GUI={toolbar:[],MINIMAP_SIZE:140,BUTTONS_SIZE:80,TOOLBAR_BUTTONS:{build:{buttonId:1E3,image:"build.png",isEnabled:!0,name:"Build"},cancel:{buttonId:1001,image:"cancel.png",isEnabled:!0,name:"Cancel"}},MOUSE_ICONS:{standard:'url("js/game/data/g/cursor.png"), auto',select:'url("js/game/data/g/cursor_hover.png"), auto',attack:'url("js/game/data/g/cursor_attack.png"), auto',arrowTop:"n-resize",arrowTopRight:"ne-resize",arrowTopLeft:"nw-resize",arrowBottom:"s-resize",arrowBottomRight:"se-resize",arrowBottomLeft:"sw-resize",
arrowRight:"e-resize",arrowLeft:"w-resize"},showBuildings:!1,init:function(){this.createResourcesBar();this.initInfobar();this.initMinimap();this.initDiplomacy()},update:function(){this.updatePopulation();this.updateResources();this.updateToolbar();this.updateInfo();this.updateMinimap()},updateToolbar:function(){if(0<gameContent.selected.length&&rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)){var a=gameContent.gameElements[gameContent.selected[0]].s;
a.f==gameData.FAMILIES.building?this.toolbar=100>a.cp?[GUI.TOOLBAR_BUTTONS.cancel]:production.getWhatCanBeBought(gameContent.players,a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r][a.t].buttons):a.f==gameData.FAMILIES.unit&&(this.toolbar=this.showBuildings?this.getBuildingButtons(a):gameData.ELEMENTS[gameData.FAMILIES.unit][a.r][a.t].buttons)}else this.toolbar=[];$("#toolbar .toolbarButton").addClass("hide");for(var b in this.toolbar)this.createToolbarButton(this.toolbar[b])},getBuildingButtons:function(a){return production.getWhatCanBeBought(gameContent.players,
a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r])},updateMouse:function(a){document.body.style.cursor=a},createResourcesBar:function(){for(var a in gameData.RESOURCES)this.createResourceElement(gameData.RESOURCES[a])},createResourceElement:function(a){a='<div id="resource'+a.id+'"><div class="spriteBefore sprite-'+a.name+'">0</div></div>';$("#resources").append(a)},updateResources:function(){var a=gameContent.players[gameContent.myArmy],b;for(b in gameData.RESOURCES){var c=gameData.RESOURCES[b];
$("div","#resource"+c.id).html(a.re[c.id])}},createToolbarButton:function(a){if(null!=$("#toolbar"+a.buttonId).html())$("#toolbar"+a.buttonId).removeClass("hide");else{var b='<div id="toolbar'+a.buttonId+'" class="toolbarButton sprite sprite-boxNormal" title="'+a.name+'"><div class="sprite sprite-'+a.image.replace(".png","")+'"></div></div>';$("#toolbar").append(b);for(var c in a.needs){var b=a.needs[c],d;for(d in gameData.RESOURCES)if(gameData.RESOURCES[d].id==b.t){var e=(this.toolbar.length-1)*
GUI.BUTTONS_SIZE-$("#toolbar"+a.buttonId).position().top+20*c+10;$("#toolbar"+a.buttonId).append('<div class="price" style="bottom: '+e+'px"><div class="spriteBefore sprite-'+gameData.RESOURCES[d].image.replace(".png","")+'15" />'+b.value+"</div></div>");break}}}a.isEnabled?$("#toolbar"+a.buttonId).removeClass("disabled"):$("#toolbar"+a.buttonId).addClass("disabled")},updatePopulation:function(){var a=gameContent.players[gameContent.myArmy];$("div","#population").html(a.pop.current+" / "+a.pop.max)},
selectButton:function(a){this.unselectButtons();$("#toolbar"+a.buttonId).addClass("sprite-boxSelect")},unselectButtons:function(){$(".toolbarButton").removeClass("sprite-boxSelect")},initInfobar:function(){$("#info").css("left",(window.innerWidth-$("#info").width())/2)},updateInfo:function(){if(0<gameContent.selected.length){var a=gameContent.gameElements[gameContent.selected[0]].s,b=gameData.ELEMENTS[a.f][a.r][a.t];$("#name").html(b.name);$("#portrait").attr("class","sprite sprite-"+b.image.replace(".png",
""));null!=b.attack?$("#frags").html("FRAGS : "+a.fr):$("#frags").html("");$("#stats").html("");if(a.f==gameData.FAMILIES.terrain){$("#life").html("&infin; / &infin;");for(var c in gameData.RESOURCES)if(gameData.RESOURCES[c].id==b.resourceType){this.addStatLine(gameData.RESOURCES[c].image.replace(".png","")+"15",a.ra,"Amount of resources left");break}}else if($("#life").html(a.l+"/"+b.l),a.f==gameData.FAMILIES.building&&null==b.attack)for(c in GUI.addStatLine("defense",b.defense,"Defense"),GUI.addStatLine("pop20",
b.pop,"Max Population Bonus"),a.q)b=gameData.ELEMENTS[gameData.FAMILIES.unit][a.r][a.q[c]],0==c?GUI.addQueue(b.image,parseInt(a.qp)+"%",b.name):GUI.addQueue(b.image,"",b.name);else GUI.addStatLine("attack",b.attack,"Attack"),GUI.addStatLine("defense",b.defense,"Defense"),GUI.addStatLine("attackSpeed",b.attackSpeed,"Attack Speed"),GUI.addStatLine("range",b.range,"Range");$("#info").removeClass("hide")}else $("#info").hasClass("hide")||$("#info").addClass("hide")},addStatLine:function(a,b,c){$("#stats").append('<div class="stat" title="'+
c+'"><div class="spriteBefore sprite-'+a+'">'+b+"</div></div>")},addQueue:function(a,b,c){$("#stats").append('<div class="queue" title="'+c+'"><div id="queueProgress">'+b+'</div><div class="sprite sprite-'+a.replace(".png","")+'15"></div></div>')},initMinimap:function(){$("#minimap").mousedown(function(a){var b=(GUI.MINIMAP_SIZE-window.innerWidth+a.clientX)/GUI.MINIMAP_SIZE*gameContent.map.size.x*gameSurface.PIXEL_BY_NODE,c=(window.innerHeight-a.clientY)/GUI.MINIMAP_SIZE*gameContent.map.size.y*gameSurface.PIXEL_BY_NODE;
if(1==a.which)camera.position.x=b,camera.position.y=c;else if(3==a.which&&0<gameContent.selected.length&&rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)&&(gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.unit||gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.building))b=parseInt(b/gameSurface.PIXEL_BY_NODE),c=parseInt(c/gameSurface.PIXEL_BY_NODE),userInput.sendOrder(b,c)})},updateMinimap:function(){$("#minimapLocation").css("left",
-8+this.MINIMAP_SIZE*camera.position.x/(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE));$("#minimapLocation").css("top",-8+this.MINIMAP_SIZE*(1-camera.position.y/(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE)))},addElementOnMinimap:function(a){var b;b=a.f==gameData.FAMILIES.building?"minimapPointBuilding":"minimapPointUnit";$("#minimap").append('<span id="minimap'+a.id+'" class="'+b+" "+gameSurface.PLAYERS_COLORS[a.o]+'">&nbsp;</span>');$("#minimap"+a.id).css("left",this.MINIMAP_SIZE*a.p.x/
gameContent.map.size.x);$("#minimap"+a.id).css("top",this.MINIMAP_SIZE*(1-a.p.y/gameContent.map.size.y))},addAlertMinimap:function(a){$("#minimap"+a.id).html("!")},updateElementOnMinimap:function(a){$("#minimap"+a.id).html("&nbsp;").css("left",this.MINIMAP_SIZE*a.p.x/gameContent.map.size.x);$("#minimap"+a.id).css("top",this.MINIMAP_SIZE*(1-a.p.y/gameContent.map.size.y))},removeElementFromMinimap:function(a){$("#minimap"+a.id).remove()},initDiplomacy:function(){for(var a in gameContent.players)if(a!=
gameContent.myArmy){var b=gameContent.players[a];$("#diplomacy").append('<div id="diplomacy'+a+'"><div class="smallButton '+gameSurface.PLAYERS_COLORS[a]+'">'+b.n+'</div><div class="smallButton customRadio white" data-name="diplomacy'+a+'" data-value="'+gameData.RANKS.neutral+'">Neutral</div><div class="smallButton customRadio white" data-name="diplomacy'+a+'" data-value="'+gameData.RANKS.enemy+'">Enemy</div></div>');this.updateDiplomacyButtons(b)}$(".customRadio","#diplomacy").click(function(){$('.customRadio[data-name="'+
$(this).attr("data-name")+'"]').removeClass("checked");$(this).addClass("checked");gameManager.sendOrderToEngine(order.TYPES.diplomacy,[gameContent.myArmy,$(this).attr("data-name").replace("diplomacy",""),$(this).attr("data-value")])})},updateDiplomacyButtons:function(a){$(".customRadio","#diplomacy"+a.o).removeClass("checked");gameContent.players[gameContent.myArmy].ra[a.o]==gameData.RANKS.neutral?$(".customRadio","#diplomacy"+a.o).first().addClass("checked"):$(".customRadio","#diplomacy"+a.o).last().addClass("checked")}};var gameManager={isOfflineGame:!1,offlineLoop:null,offlineNbPlayers:2,musicEnabled:!1};try{gameManager.socket=io.connect("http://warnode.com"),gameManager.socket.on("askPID",function(){gameManager.playerId=gameManager.getPlayerId();gameManager.playerName=gameManager.getPlayerName();gameManager.socket.emit("PID",gameManager.playerId)})}catch(e$$15){}
gameManager.socket.on("askRejoin",function(a){$("#rejoin").append('<div class="bigButton" data-id="'+a.id+'">'+a.name+"</div>");$("#rejoin").css("top",(window.innerHeight-$("#rejoin").height())/2);$("#rejoin").css("left",(window.innerWidth-$("#rejoin").width())/2);$(".bigButton","#rejoin").click(function(){gameManager.connectToServer(null);gameManager.socket.emit("rejoinResponse",a.id);hideWelcomeScreen();$("#loadingTitle").removeClass("hide").addClass("moveToLeft");$("#rejoin").addClass("hide")})});
gameManager.initGame=function(a){if(null==gameContent.game)if(gameManager.playerId=gameManager.getPlayerId(),gameManager.playerName=gameManager.getPlayerName(),this.isOfflineGame)this.initOfflineGame(a);else try{this.connectToServer(a)}catch(b){}};gameManager.startGame=function(){$("#gui").removeClass("hide");$("#introScreen").remove();gameContent.init(this.waitingData);this.isOfflineGame&&(this.offlineLoop=setInterval(function(){gameContent.update(gameContent.game.update())},125))};
gameManager.initOfflineGame=function(a){gameContent.myArmy=0;gameContent.players=[];gameContent.players.push(new gameData.Player(0,0,a.army));gameContent.players[0].n=this.playerName;for(var b=1;b<this.offlineNbPlayers;b++)gameContent.players.push(new gameData.Player(0,b,0)),gameContent.players[b].n="AI";gameContent.map=new gameData.Map(gameData.MAP_TYPES[a.mapType],gameData.MAP_SIZES[a.mapSize],gameData.VEGETATION_TYPES[a.vegetation],gameData.INITIAL_RESOURCES[a.initialResources]);gameContent.game=
gameCreation.createNewGame(gameContent.map,gameContent.players);this.waitingData=gameContent.game.gameElements;gameSurface.init();GUI.init();input.initInputs()};
gameManager.connectToServer=function(a){null!=a&&this.socket.emit("enter",{player:{playerId:this.playerId,army:a.army,name:this.playerName},game:a});this.socket.on("updateGamePlayers",function(a){gameManager.updatePlayersInGame(a)});this.socket.on("gameStart",function(a){gameContent.players=a.players;gameContent.myArmy=a.myArmy;gameContent.map=a.map;gameManager.waitingData=a.initElements;gameSurface.init();GUI.init();input.initInputs()});this.socket.on("gameData",function(a){gameContent.update(a)});
this.socket.on("gameStats",function(a){gameManager.showStats(a)})};gameManager.disconnect=function(){this.socket.emit("goOffline",null)};gameManager.createPlayerId=function(){var a=(new Date).getTime()+Math.random();utils.createCookie("rts_player_id",a);return a};gameManager.getPlayerId=function(){var a=utils.readCookie("rts_player_id");null==a&&(a=this.createPlayerId());return a};
gameManager.getPlayerName=function(){var a=utils.readCookie("rts_player_name");return null==a?"Lord Bobby "+parseInt(1+8*Math.random()):a};gameManager.updatePlayerName=function(a){utils.createCookie("rts_player_name",a);this.playerName=a};gameManager.sendOrderToEngine=function(a,b){this.isOfflineGame?order.dispatchReceivedOrder(gameContent.game,a,b):gameManager.socket.emit("order",[a,b])};
gameManager.endGame=function(a){a==gameData.PLAYER_STATUSES.victory?($("#endGameMessage").addClass("victory"),$("#endGameMessage").html("Victory !")):($("#endGameMessage").addClass("defeat"),$("#endGameMessage").html("Defeat..."));$("#endGame").fadeIn().removeClass("hide");$("#endGameMessage").addClass("moveToLeft");this.isOfflineGame?(clearInterval(this.offlineLoop),this.showStats(gameContent.game.stats)):this.disconnect()};
gameManager.showStats=function(a){$("table","#endGameStats").css("width",window.innerWidth-60);for(var b in a){var c=a[b],d=gameContent.players[b].n;$("#tableBody").append('<tr class="'+gameSurface.PLAYERS_COLORS[b]+'"><td>'+d+"</td><td>"+c.killed+"</td><td>"+c.lost+"</td><td>"+c.buildingsDestroyed+"</td><td>"+c.unitsCreated+"</td><td>"+c.resources+"</td><td>"+c.buildersCreated+"</td><td>"+c.buildingsCreated+"</td></tr>")}};
gameManager.updatePlayersInGame=function(a){a=a.playersMax-a.players.length;$("#loadingLabel").html("Waiting for "+a+" player"+(1<a?"s":""))};var gameContent={map:null,players:null,myArmy:null,game:null,gameElements:{},selected:[],building:null,selectionRectangle:[],init:function(a){for(var b in a){var c=a[b];gameSurface.addElement(c);c.f==gameData.FAMILIES.building&&c.o==this.myArmy&&gameSurface.centerCameraOnElement(c)}},update:function(a){for(var b in a.added){var c=a.added[b];null==this.gameElements[c.id]&&gameSurface.addElement(c)}for(b in a.removed)if(c=a.removed[b],null!=this.gameElements[c.id]){var d=this.selected.indexOf(c.id);
0<=d&&this.selected.splice(d,1);gameSurface.removeElement(c)}for(b in a.modified)c=a.modified[b],null!=this.gameElements[c.id]&&gameSurface.updateElement(c);for(b in this.players)for(var e in this.players[b].ra)this.players[b].ra[e]!=a.players[b].ra[e]&&this.rankHasChanged(a.players[b],a.players[e]);this.players=a.players;(this.players[this.myArmy].s==gameData.PLAYER_STATUSES.victory||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.defeat)&&gameManager.endGame(this.players[this.myArmy].s);for(b in a.chat)gameSurface.showMessage({id:parseInt(1E3*
Math.random()),text:a.chat[b].text},gameSurface.PLAYERS_COLORS[a.chat[b].o])},rankHasChanged:function(a,b){a.ra[b.o]==gameData.RANKS.enemy?gameSurface.showMessage({id:parseInt(1E3*Math.random()),text:a.n+" has declared the war to "+b.n+" !"}):a.ra[b.o]==gameData.RANKS.neutral&&b.ra[a.o]==gameData.RANKS.neutral?gameSurface.showMessage({id:parseInt(1E3*Math.random()),text:a.n+" and "+b.n+" have signed an alliance !"}):a.ra[b.o]==gameData.RANKS.neutral&&gameSurface.showMessage({id:parseInt(1E3*Math.random()),
text:a.n+" wants to conclude a pact with "+b.n+"..."})}};var utils={readCookie:function(a){a+="=";for(var b=document.cookie.split(";"),c=0;c<b.length;c++){for(var d=b[c];" "==d.charAt(0);)d=d.substring(1,d.length);if(0==d.indexOf(a))return d.substring(a.length,d.length)}return null},createCookie:function(a,b){document.cookie=a+"="+b+"; path=/"},canBeBuiltHere:function(a){var b=tools.getPartPosition(a,0,0),c=b.x+a.shape[0].length-1,d=b.y+a.shape.length-1,e;for(e in gameContent.gameElements){var f=gameContent.gameElements[e].s,g=gameData.ELEMENTS[f.f][f.r][f.t].shape,
f=tools.getPartPosition(f,0,0),k=f.x+g[0].length-1,g=f.y+g.length-1;if(0>=b.x||0>=b.y||c>=gameContent.map.size.x-1||d>=gameContent.map.size.y-1||f.x>=b.x&&f.x<=c&&(f.y>=b.y&&f.y<=d||g>=b.y&&g<=d)||k>=b.x&&k<=c&&(f.y>=b.y&&f.y<=d||g>=b.y&&g<=d)){a.canBeBuiltHere=!1;for(var h=f.x;h<=k;h++)for(var j=f.y;j<=g;j++)h>=b.x&&(h<=c&&j>=b.y&&j<=d)&&(a.shape[h-b.x][j-b.y]=userInput.CANNOT_BE_BUILT_HERE)}}}};var inputDispatcher={TOOLBAR_KEYBOARD_SHORTCUTS:[81,87,69,82,65,83,68,70],onLeftClick:function(a){if(1==a.which){var b=a.x;a=a.y;if(0<GUI.toolbar.length&&b<GUI.BUTTONS_SIZE+10&&10<b&&a<window.innerHeight-10&&a>window.innerHeight-10-GUI.BUTTONS_SIZE*GUI.toolbar.length)return userInput.clickOnToolbar(GUI.toolbar[parseInt(GUI.toolbar.length-(window.innerHeight-a-10)/GUI.BUTTONS_SIZE)]),!1;if(null!=gameContent.building)return userInput.tryBuildHere(),!1;userInput.clickToSelect(b,a);return!0}},onDoubleClick:function(a){1==
a.which&&userInput.doubleClickToSelect(a.x,a.y);return!1},onRightClick:function(a){if(a.x>window.innerWidth-GUI.MINIMAP_SIZE&&a.y>window.innerHeight-GUI.MINIMAP_SIZE)return!1;null!=gameContent.building?userInput.leaveConstructionMode():0<gameContent.selected.length&&(rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)&&(gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.unit||gameContent.gameElements[gameContent.selected[0]].s.f==
gameData.FAMILIES.building))&&userInput.dispatchUnitAction(a.x,a.y);return!1},onMouseMove:function(a){userInput.updateConstructionMode(a.x,a.y)},onMouseUp:function(){userInput.removeSelectionRectangle()},onMouseWheel:function(a){0<Math.abs(a.wheelDelta)&&userInput.changeZoom(a.wheelDelta/Math.abs(a.wheelDelta));return!1},onKeyDown:function(a){a=window.event?a.which:a.keyCode;switch(a){case 13:return userInput.onEnterKey(),!0;case 38:return gameSurface.updateScrolling(1,1,!0),!0;case 40:return gameSurface.updateScrolling(1,
-1,!0),!0;case 39:return gameSurface.updateScrolling(0,1,!0),!0;case 37:return gameSurface.updateScrolling(0,-1,!0),!0}if(!userInput.isChatWindowOpen)for(var b in inputDispatcher.TOOLBAR_KEYBOARD_SHORTCUTS)if(inputDispatcher.TOOLBAR_KEYBOARD_SHORTCUTS[b]==a)return userInput.pressToolbarShortcut(b),!1;return!0},onKeyUp:function(a){switch(window.event?a.which:a.keyCode){case 38:return gameSurface.updateScrolling(1,0,!0),!1;case 40:return gameSurface.updateScrolling(1,0,!0),!1;case 39:return gameSurface.updateScrolling(0,
0,!0),!1;case 37:return gameSurface.updateScrolling(0,0,!0),!1}},onTouchDrag:function(a){camera.position.x+=a.dx;camera.position.y+=a.dy}};var input={initInputs:function(){this.isTouchDevice()?this.initTouch():(this.initMouse(),this.initKeyboard())},isTouchDevice:function(){return"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch},mousePosition:{x:0,y:0},initMouse:function(){document.onmousedown=function(a){return inputDispatcher.onLeftClick(a)};document.oncontextmenu=function(a){return inputDispatcher.onRightClick(a)};document.onmousemove=function(a){userInput.checkIfMapScrolling(a.x,a.y);userInput.updateMouseIcon(a.x,
a.y);userInput.selectGroup(a.x,a.y);if(3<Math.abs(a.x-input.mousePosition.x)+Math.abs(a.y-input.mousePosition.y))inputDispatcher.onMouseMove(a);input.mousePosition.x=a.x;input.mousePosition.y=a.y;return!1};document.onmousewheel=function(a){return inputDispatcher.onMouseWheel(a)};document.ondblclick=function(a){return inputDispatcher.onDoubleClick(a)};document.onmouseup=function(a){return inputDispatcher.onMouseUp(a)}},initKeyboard:function(){document.onkeydown=function(a){return inputDispatcher.onKeyDown(a)};
document.onkeyup=function(a){return inputDispatcher.onKeyUp(a)}},DOUBLE_TAP_INTERVAL:150,DRAG_FACTOR:1/35,isSelectionRectangle:!1,initTouch:function(){var a={tap_always:!1,hold_timeout:250};input.mousePosition.x=window.innerWidth/2;input.mousePosition.y=window.innerHeight/2;$(document).hammer(a).on("tap",function(a){inputDispatcher.onLeftClick({x:a.gesture.center.pageX,y:a.gesture.center.pageY,which:1})});$(document).hammer(a).on("hold",function(a){inputDispatcher.onRightClick({x:a.gesture.center.pageX,
y:a.gesture.center.pageY,which:1});input.isSelectionRectangle=!0});$(document).hammer(a).on("drag",function(a){a.gesture.preventDefault();null!=gameContent.building?(a={x:a.gesture.center.pageX,y:a.gesture.center.pageY},inputDispatcher.onMouseMove(a)):input.isSelectionRectangle?(a={x:a.gesture.center.pageX,y:a.gesture.center.pageY},0==gameContent.selectionRectangle.length&&(gameContent.selectionRectangle[0]=a.x,gameContent.selectionRectangle[1]=a.y),userInput.selectGroup(a.x,a.y),inputDispatcher.onMouseMove(a)):
(a={dx:-a.gesture.deltaX*input.DRAG_FACTOR,dy:a.gesture.deltaY*input.DRAG_FACTOR},inputDispatcher.onTouchDrag(a))});$(document).hammer(a).on("pinch",function(a){a.gesture.preventDefault();inputDispatcher.onMouseWheel({wheelDelta:5*(a.gesture.scale-1)})});$(document).hammer(a).on("doubletap",function(a){inputDispatcher.onDoubleClick({x:a.gesture.center.pageX,y:a.gesture.center.pageY,which:1})});$(document).hammer(a).on("release",function(a){inputDispatcher.onMouseUp(a);input.isSelectionRectangle=!1})}};var userInput={CAN_BE_BUILT_HERE:10,CANNOT_BE_BUILT_HERE:1,isChatWindowOpen:!1,clickOnToolbar:function(a){a.isEnabled&&(a.buttonId==GUI.TOOLBAR_BUTTONS.build.buttonId?GUI.showBuildings=!0:GUI.showBuildings&&a.isEnabled?this.enterConstructionMode(a):a.buttonId==GUI.TOOLBAR_BUTTONS.cancel.buttonId?gameManager.sendOrderToEngine(order.TYPES.cancelConstruction,[gameContent.gameElements[gameContent.selected[0]].s.id]):gameContent.gameElements[gameContent.selected[0]].s.f==gameData.FAMILIES.building&&gameManager.sendOrderToEngine(order.TYPES.buy,
[gameContent.selected,a]))},enterConstructionMode:function(a){gameContent.building=a;GUI.selectButton(a);this.updateConstructionMode(input.mousePosition.x,input.mousePosition.y)},updateConstructionMode:function(a,b){if(null!=gameContent.building){gameContent.building.p=gameSurface.getAbsolutePositionFromPixel(a,b);gameContent.building.canBeBuiltHere=!0;for(var c in gameContent.building.shape)for(var d in gameContent.building.shape[c])gameContent.building.shape[c][d]=this.CAN_BE_BUILT_HERE;utils.canBeBuiltHere(gameContent.building);
gameSurface.updateBuildingGeometry()}},leaveConstructionMode:function(){gameContent.building=null;gameSurface.removeBuildingGeometry();GUI.unselectButtons();GUI.showBuildings=!1},changeZoom:function(a){gameSurface.updateZoom(a)},pressToolbarShortcut:function(a){a<GUI.toolbar.length&&this.clickOnToolbar(GUI.toolbar[a])},updateMouseIcon:function(a,b){var c=gameSurface.getFirstIntersectObject(a,b),d=gameSurface.scroll[0],e=gameSurface.scroll[1];null!=c&&null!=c.object.elementId?(c=gameContent.gameElements[c.object.elementId].s,
null!=c&&c.f!=gameData.FAMILIES.terrain&&rank.isEnemy(gameContent.players,gameContent.myArmy,c)?GUI.updateMouse(GUI.MOUSE_ICONS.attack):GUI.updateMouse(GUI.MOUSE_ICONS.select)):gameSurface.isKeyboardScrolling||(0<d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopRight):0<d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowRight):0<d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomRight):0>d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopLeft):0>d&&0==e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowLeft):0>d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomLeft):
0==d&&0<e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowTop):0==d&&0>e?GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottom):GUI.updateMouse(GUI.MOUSE_ICONS.standard))},SCROLL_THRESHOLD:10,checkIfMapScrolling:function(a,b){a<this.SCROLL_THRESHOLD?gameSurface.updateScrolling(0,-1,!1):a>window.innerWidth-this.SCROLL_THRESHOLD?gameSurface.updateScrolling(0,1,!1):!gameSurface.isKeyboardScrolling&&0!=gameSurface.scroll[0]&&gameSurface.updateScrolling(0,0,!1);b<this.SCROLL_THRESHOLD?gameSurface.updateScrolling(1,1,!1):b>
window.innerHeight-this.SCROLL_THRESHOLD?gameSurface.updateScrolling(1,-1,!1):!gameSurface.isKeyboardScrolling&&0!=gameSurface.scroll[1]&&gameSurface.updateScrolling(1,0,!1)},tryBuildHere:function(){gameContent.building.canBeBuiltHere&&(gameManager.sendOrderToEngine(order.TYPES.buildThatHere,[gameContent.selected,gameContent.building,gameContent.building.p.x,gameContent.building.p.y]),this.leaveConstructionMode())},dispatchUnitAction:function(a,b){var c,d=gameSurface.getFirstIntersectObject(a,b);
null!=d&&(null!=d.object.elementId?(c=gameContent.gameElements[d.object.elementId].s.p,gameSurface.animateSelectionCircle(d.object.elementId)):c={x:parseInt(d.point.x/gameSurface.PIXEL_BY_NODE),y:parseInt(d.point.y/gameSurface.PIXEL_BY_NODE)},this.sendOrder(c.x,c.y))},sendOrder:function(a,b){0<=a&&(0<=b&&a<gameContent.map.size.x&&b<gameContent.map.size.y)&&gameManager.sendOrderToEngine(order.TYPES.action,[gameContent.selected,a,b])},onEnterKey:function(){this.isChatWindowOpen?($("#chat").addClass("hide"),
""!=$("input","#chat").val()&&gameManager.sendOrderToEngine(order.TYPES.chat,[gameContent.myArmy,$("input","#chat").val()]),$("input","#chat").val("")):($("#chat").removeClass("hide"),$("#chat").css("top",(window.innerHeight-$("#chat").height())/2),$("#chat").css("left",(window.innerWidth-$("#chat").width())/2),$("input","#chat")[0].focus());this.isChatWindowOpen=!this.isChatWindowOpen}};userInput.clickToSelect=function(a,b){if(!(a>window.innerWidth-GUI.MINIMAP_SIZE&&b>window.innerHeight-GUI.MINIMAP_SIZE)){this.leaveConstructionMode();gameSurface.unselectAll();gameContent.selected=[];gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1);gameContent.selectionRectangle[0]=a;gameContent.selectionRectangle[1]=b;var c=gameSurface.getFirstIntersectObject(a,b);null!=c&&null!=c.object.elementId&&(gameContent.selected.push(c.object.elementId),gameSurface.selectElement(c.object.elementId))}};
userInput.selectGroup=function(a,b){if(0<gameContent.selectionRectangle.length){gameSurface.unselectAll();gameContent.selected=[];var c=!1;gameSurface.updateSelectionRectangle(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1],a,b);var d=gameSurface.getFirstIntersectObject(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1]).point,e=gameSurface.getFirstIntersectObject(a,b).point,d=gameSurface.convertScenePositionToGamePosition(d),e=gameSurface.convertScenePositionToGamePosition(e),
d=[d.x,d.y,e.x,e.y],f;for(f in gameContent.gameElements)if(e=gameContent.gameElements[f].s,rank.isAlly(gameContent.players,gameContent.myArmy,e)&&e.f!=gameData.FAMILIES.terrain&&(0>d[0]-d[2]&&e.p.x<=d[2]&&e.p.x>=d[0]||e.p.x>=d[2]&&e.p.x<=d[0])&&(0>d[1]-d[3]&&e.p.y<=d[3]&&e.p.y>=d[1]||e.p.y>=d[3]&&e.p.y<=d[1]))gameContent.selected.push(e.id),gameSurface.selectElement(e.id),e.f==gameData.FAMILIES.unit&&(c=!0);if(c)for(c=gameContent.selected.length;c--;)e=gameContent.gameElements[gameContent.selected[c]].s,
e.f==gameData.FAMILIES.building&&(gameContent.selected.splice(c,1),gameSurface.unselectElement(e.id))}};userInput.removeSelectionRectangle=function(){gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1)};
userInput.doubleClickToSelect=function(){if(0<gameContent.selected.length&&rank.isAlly(gameContent.players,gameContent.myArmy,gameContent.gameElements[gameContent.selected[0]].s)){var a=gameContent.gameElements[gameContent.selected[0]].s,b;for(b in gameContent.gameElements){var c=gameContent.gameElements[b].s;c.f==a.f&&(rank.isAlly(gameContent.players,gameContent.myArmy,c)&&c.t==a.t)&&(gameContent.selected.push(c.id),gameSurface.selectElement(c.id))}}};