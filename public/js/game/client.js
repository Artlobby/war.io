var socketManager={};socketManager.socket=null;socketManager.connect=function(){this.socket=io.connect();this.socket.on("data",function(a){socketManager.onDataSocket(a)});this.socket.on("gameData",function(a){socketManager.onGameDataSocket(a)})};socketManager.onDataSocket=function(a){switch(a.type){case gameData.TO_CLIENT_SOCKET.login:this.sendSocketToServer(gameData.TO_SERVER_SOCKET.login,gameManager.playerId);break;case gameData.TO_CLIENT_SOCKET.listJoinableGames:gameManager.updateJoinableGamesList(a);break;case gameData.TO_CLIENT_SOCKET.gameStart:gameManager.initOnlineGame(a);break;case gameData.TO_CLIENT_SOCKET.rejoin:gameManager.askRejoin(a);break;case gameData.TO_CLIENT_SOCKET.updateLoadingProgress:gameManager.updateLoadingQueue(a);break;case gameData.TO_CLIENT_SOCKET.updateQueue:gameManager.updateQueue(a);break;case gameData.TO_CLIENT_SOCKET.gameStats:gameManager.showStats(a.playerStatus,a.stats);break}};socketManager.onGameDataSocket=function(a){gameContent.update(a)};socketManager.createNewGame=function(a){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.createNewGame,a)};socketManager.enterSalon=function(){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.enterSalon,null)};socketManager.leaveSalon=function(){this.sendSocketToServer(gameData.TO_SERVER_SOCKET.leaveSalon,null)};socketManager.joinGame=function(a,c,b,e){var d={playerId:a,playerName:c,gameId:b,armyId:e};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.joinGame,d)};socketManager.updateLoadingProgress=function(a,b,d){var c={playerId:a,gameId:b,loadingProgress:d};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.updateLoadingProgress,c)};socketManager.sendOrder=function(b,a,d){var c={gameId:b,type:a,params:d};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.sendOrder,c)};socketManager.sendSocketToServer=function(a,b){this.socket.emit(a,b)};socketManager.rejoinGame=function(a,b){var c={playerId:a,gameId:b};this.sendSocketToServer(gameData.TO_SERVER_SOCKET.rejoinGame,c)};var utils={};utils.readCookie=function(b){var e=b+"=";var a=document.cookie.split(";");for(var d=0;d<a.length;d++){var f=a[d];while(f.charAt(0)==" "){f=f.substring(1,f.length)}if(f.indexOf(e)==0){return f.substring(e.length,f.length)}}return null};utils.createCookie=function(a,b){document.cookie=a+"="+b+"; path=/"};utils.canBeBuiltHere=function(d){var e=tools.getPartPosition(d,0,0);var c={x:e.x+d.shape[0].length-1,y:e.y+d.shape.length-1};for(var b=e.x;b<=c.x;b++){for(var a=e.y;a<=c.y;a++){if(gameContent.grid[b]!=null&&gameContent.grid[b][a]>0||gameSurface.fogOfWarMatrix[b]!=null&&!gameSurface.fogOfWarMatrix[b][a]){d.canBeBuiltHere=false;d.shape[b-e.x][a-e.y]=userInput.CANNOT_BE_BUILT_HERE}}}};utils.getElementFromId=function(a){return gameContent.gameElements[Object.keys(gameData.FAMILIES)[(""+a)[1]]][a]};utils.copyValuesToObject=function(b,c){if(b==null||typeof(b)!="object"){return b}for(var a in b){console.log(a);if(c[a]==undefined){c[a]={}}c[a]=utils.copyValuesToObject(b[a],c[a])}return c};var gameContent={};gameContent.gameId=null;gameContent.map=null;gameContent.players=null;gameContent.myArmy=null;gameContent.isRunning=false;gameContent.game=null;gameContent.gameElements={land:{},building:{},unit:{}};gameContent.grid=[];gameContent.selected=[];gameContent.building=null;gameContent.selectionRectangle=[];gameContent.init=function(d){for(var c=0;c<this.map.size.x;c++){this.grid[c]=[];for(var a=0;a<this.map.size.y;a++){this.grid[c][a]=0}}for(var c in d){for(var a in d[c]){var b=d[c][a];gameSurface.addElement(b);if(b.f==gameData.FAMILIES.building&&b.o==this.myArmy){gameSurface.centerCameraOnElement(utils.getElementFromId(b.id))}}}};gameContent.update=function(d){for(var c in d.added){var b=d.added[c];if(utils.getElementFromId(b.id)==null){gameSurface.addElement(b)}}for(var c in d.removed){var b=d.removed[c];if(utils.getElementFromId(b.id)!=null){gameSurface.removeElement(b)}}for(var c in d.modified){var b=d.modified[c];if(utils.getElementFromId(b.id)!=null){gameSurface.updateElement(b)}}gameSurface.manageElementsVisibility();for(var c in this.players){for(var a in this.players[c].ra){if(this.players[c].ra[a]!=d.players[c].ra[a]){this.rankHasChanged(d.players[c],d.players[a])}}}this.players=d.players;if(gameManager.isOfflineGame&&this.players[this.myArmy].s==gameData.PLAYER_STATUSES.victory||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.defeat||this.players[this.myArmy].s==gameData.PLAYER_STATUSES.surrender){gameManager.showStats(this.players[this.myArmy].s,gameContent.game.stats);clearInterval(gameManager.offlineGameLoop)}for(var c in d.chat){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:d.chat[c].text},gameSurface.PLAYERS_COLORS[d.chat[c].o])}};gameContent.rankHasChanged=function(b,a){if(b.ra[a.o]==gameData.RANKS.enemy){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:b.n+" has declared the war to "+a.n+" !"})}else{if(b.ra[a.o]==gameData.RANKS.neutral&&a.ra[b.o]==gameData.RANKS.neutral){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:b.n+" and "+a.n+" have signed an alliance !"})}else{if(b.ra[a.o]==gameData.RANKS.neutral){gameSurface.showMessage({id:parseInt(Math.random()*1000),text:b.n+" wants to conclude a pact with "+a.n+"..."})}}}};var camera,scene,engine,canvas;var gameSurface={};gameSurface.building=null;gameSurface.PIXEL_BY_NODE=10;gameSurface.init=function(){$("#loadingScreen").addClass("hide");$("#game").removeClass("hide");canvas=document.getElementById("renderCanvas");var a=document.getElementById("fps");engine=new BABYLON.Engine(canvas,true);scene=new BABYLON.Scene(engine);camera=new BABYLON.ArcRotateCamera("Camera",0,0,10,BABYLON.Vector3.Zero(),scene);var f=new BABYLON.PointLight("Omni",new BABYLON.Vector3(20,100,2),scene);camera.setPosition(new BABYLON.Vector3(20,40,20));camera.attachControl(document.getElementById("gui"));var i=BABYLON.Mesh.CreateBox("skyBox",1000,scene);var e=new BABYLON.StandardMaterial("skyBox",scene);e.backFaceCulling=false;e.reflectionTexture=new BABYLON.CubeTexture("assets/skybox/skybox",scene);e.reflectionTexture.coordinatesMode=BABYLON.Texture.SKYBOX_MODE;e.diffuseColor=new BABYLON.Color3(0,0,0);e.specularColor=new BABYLON.Color3(0,0,0);i.material=e;var g=BABYLON.Mesh.CreateGroundFromHeightMap("ground","assets/heightMap.png",100,100,100,0,12,scene,true);var k=new WORLDMONGER.GroundMaterial("ground",scene,f);g.material=k;g.position.y=-2;var j=BABYLON.Mesh.CreateGround("extraGround",1000,1000,1,scene,false);var h=new BABYLON.StandardMaterial("extraGround",scene);h.diffuseTexture=new BABYLON.Texture("shaders/Ground/sand.jpg",scene);h.diffuseTexture.uScale=60;h.diffuseTexture.vScale=60;j.position.y=-2.05;j.material=h;var d=BABYLON.Mesh.CreateGround("water",1000,1000,1,scene,false);var c=new WORLDMONGER.WaterMaterial("water",scene,f);c.refractionTexture.renderList.push(g);c.refractionTexture.renderList.push(j);c.reflectionTexture.renderList.push(g);c.reflectionTexture.renderList.push(i);d.isPickable=false;d.material=c;var b=function(){if(g.isReady&&g.subMeshes.length==1){g.subdivide(20)}controls.updateCamera();a.innerHTML=BABYLON.Tools.GetFps().toFixed()+" fps";scene.render();i.rotation.y+=0.0001*scene.getAnimationRatio()};engine.runRenderLoop(b);window.addEventListener("resize",function(){engine.resize()});controls.init()};gameSurface.getFirstIntersectObject=function(a,c){var b=scene.pick(a,c);if(!b.hit){return}return b.pickedMesh};gameSurface.setElementPosition=function(c,b,d){var a=this.convertGamePositionToScenePosition({x:b,y:d});c.position.x=a.x;c.position.y=a.y;c.position.z=a.z};gameSurface.convertGamePositionToScenePosition=function(a){return{x:a.x*this.PIXEL_BY_NODE,y:a.y*this.PIXEL_BY_NODE,z:0.5}};gameSurface.convertScenePositionToGamePosition=function(a){return{x:Math.min(gameContent.map.size.x-1,Math.max(0,parseInt(a.x/this.PIXEL_BY_NODE))),y:Math.min(gameContent.map.size.y-1,Math.max(0,parseInt(a.y/this.PIXEL_BY_NODE)))}};gameSurface.convertScenePositionToGamePositionNoBounds=function(a){return{x:Math.min(gameContent.map.size.x-1,parseInt(a.x/this.PIXEL_BY_NODE)),y:Math.min(gameContent.map.size.y-1,parseInt(a.y/this.PIXEL_BY_NODE))}};gameSurface.drawSelectionCircle=function(a,b){var c=new THREE.Mesh(new THREE.TorusGeometry(a,0.2,2,a*20),new THREE.LineBasicMaterial({color:b}));c.id="select";c.rotation.x=this.de2ra(90);return c};gameSurface.drawLifeBar=function(b){var a=tools.getElementData(b);var d=this.materials.billboardBar.clone();var c=new THREE.Sprite(d);c.position.y=a.height;c.scale.set(1,1,0);c.id="life";this.updateLifeBar(c,b,a);return c};gameSurface.addLifeBar=function(b){var c=this.drawLifeBar(b);var a=b.m;a.add(c)};gameSurface.updateLifeBar=function(c,b,a){var d=b.l/a.l;c.scale.x=a.lifeBarWidth*d;c.material.color.setHex(this.getLifeBarColor(d))};gameSurface.updateProgressBar=function(a,d,c){var e=null;for(var b in a.children){if(a.children[b].id=="prog"){e=a.children[b];break}}if(d.q.length>0&&d.qp>0){if(e==null){var f=this.materials.billboardBar.clone();var e=new THREE.Sprite(f);e.scale.set(1,0.6,0);e.position.y=c.height-0.5;e.id="prog";a.add(e)}e.scale.x=c.lifeBarWidth*d.qp/100;e.position.x=-c.lifeBarWidth/14+e.scale.x/14}else{if(d.qp>=99&&gameContent.players[gameContent.myArmy].pop.current==gameContent.players[gameContent.myArmy].pop.max){this.showMessage(this.MESSAGES.popLimitReached)}else{if(e!=null){a.remove(e)}}}};gameSurface.updateOrderPosition=function(){if(gameContent.selected.length>0){var b=utils.getElementFromId(gameContent.selected[0]);if(b==null){this.order.visible=false;return}if(b.a!=null&&(b.a.moveTo!=null||b.a.id!=null)||b.rp!=null){var a=null;if(b.rp!=null){a=b.rp}else{if(b.a.moveTo!=null){a=b.a.moveTo}else{var c=utils.getElementFromId(b.a.id);if(c!=null){a=c.p}else{this.order.visible=false;return}}}this.setElementPosition(this.order,a.x,a.y);if(this.order.scale.x>=gameSurface.ORDER_SIZE_MAX){gameSurface.orderFactor=-1}else{if(this.order.scale.x<=gameSurface.ORDER_SIZE_MIN){gameSurface.orderFactor=1}}this.order.scale.x+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor;this.order.scale.y+=this.ORDER_ANIMATION_SPEED*gameSurface.orderFactor;this.order.visible=true}else{if(this.order.visible){this.order.visible=false}}}else{if(this.order.visible){this.order.visible=false}}};gameSurface.updateSelectionRectangle=function(d,f,c,e){var b=Math.abs(d-c);var a=Math.abs(f-e);if(b>0&&a>0){$("#selectionRectangle").css({top:Math.min(f,e),left:Math.min(d,c),width:b,height:a});$("#selectionRectangle").removeClass("hide")}else{$("#selectionRectangle").addClass("hide")}};gameSurface.de2ra=function(a){return a*(Math.PI/180)};gameSurface.selectElement=function(b){var e=utils.getElementFromId(b);if(e!=null){var c=e.m;var d=tools.getElementData(e);var a;if(rank.isEnemy(gameContent.players,gameContent.myArmy,e)){a=this.SELECTION_ENEMY_COLOR}else{if(rank.isAlly(gameContent.players,gameContent.myArmy,e)){a=this.SELECTION_ALLY_COLOR}else{a=this.SELECTION_NEUTRAL_COLOR}}c.add(this.drawSelectionCircle(d.shape.length/2*this.PIXEL_BY_NODE/2,a))}};gameSurface.unselectElement=function(a){try{var c=utils.getElementFromId(a).m;var b=c.children.length;while(b--){var f=c.children[b];if(f.id=="select"){c.remove(f)}}}catch(d){}};gameSurface.unselectAll=function(){for(var a in gameContent.selected){this.unselectElement(gameContent.selected[a])}};gameSurface.updateOrientation=function(c,b,a){if(b==0&&a<0){}else{if(b>0&&a<0){c.rotation.y=this.de2ra(45)}else{if(b>0&&a==0){c.rotation.y=this.de2ra(90)}else{if(b>0&&a>0){c.rotation.y=this.de2ra(135)}else{if(b==0&&a>0){c.rotation.y=this.de2ra(180)}else{if(b<0&&a>0){c.rotation.y=this.de2ra(225)}else{if(b<0&&a==0){c.rotation.y=this.de2ra(270)}else{if(b<0&&a<0){c.rotation.y=this.de2ra(315)}}}}}}}}};gameSurface.updateBuildingGeometry=function(){for(var d in this.building.children){this.building.children[d].visible=false}var a=gameContent.building.shape;for(var d in a){for(var c in a){var e;if(a[d][c]==userInput.CAN_BE_BUILT_HERE){e=this.canBuildHereMaterial}else{if(a[d][c]==userInput.CANNOT_BE_BUILT_HERE){e=this.cannotBuildHereMaterial}else{continue}}var b=d*this.BUILDING_STRUCTURE_SIZE+parseInt(c);this.building.children[b].material=e;this.building.children[b].visible=true}}this.setElementPosition(this.building,gameContent.building.p.x-parseInt(a.length/2),gameContent.building.p.y-parseInt(a.length/2));this.building.visible=true};gameSurface.removeBuildingGeometry=function(){};gameSurface.animateSelectionCircle=function(b){this.selectElement(b);var d=utils.getElementFromId(b).m;var f;for(var e in d.children){if(d.children[e].id=="select"){f=d.children[e];break}}var c=new TWEEN.Tween({alpha:1}).delay(300).to({alpha:0},300).onComplete(function(){f.visible=false}).start();var a=new TWEEN.Tween({alpha:0}).to({alpha:1},300).onComplete(function(){f.visible=true});var g=new TWEEN.Tween({alpha:0}).to({alpha:1},500).onComplete(function(){gameSurface.unselectElement(b)});c.chain(a);a.chain(g)};gameSurface.getLifeBarColor=function(a){if(a<0.3){return 16711680}else{if(a<0.6){return 14934804}else{return 65280}}};gameSurface.getLifeBarBackgroundColor=function(a){if(a<0.25){return"lowLife"}else{if(a<0.5){return"mediumLife"}else{if(a<0.75){return"highLife"}else{return"veryHighLife"}}}};gameSurface.MESSAGES={popLimitReached:{id:0,text:"You need more houses"},musicEnabled:{id:1,text:"Music enabled"},musicDisabled:{id:2,text:"Music disabled"}};gameSurface.showMessage=function(c,a){$("#messages").removeClass("hide");var b=new Date();$("#messages").append("<div>"+b.getHours()+":"+b.getMinutes()+":"+(b.getSeconds()<10?"0":"")+b.getSeconds()+'<span class="'+(a==null?"white":a)+'">'+c.text+"</span></div>").scrollTop(10000)};gameSurface.extrapol=function(c,b,a){c.ex=b;c.ey=a;c.et=this.MOVEMENT_EXTRAPOLATION_ITERATION;this.ex.push(c)};gameSurface.updateMoveExtrapolation=function(){var b=this.ex.length;while(b--){var a=this.ex[b];a.position.x+=a.ex*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION;a.position.y+=a.ey*this.PIXEL_BY_NODE/this.MOVEMENT_EXTRAPOLATION_ITERATION;a.et-=1;var c=utils.getElementFromId(a.elementId);if(a.et<=0&&c!=null){this.setElementPosition(a,c.p.x,c.p.y);a.et=0;a.ex=0;a.ey=0;this.ex.splice(b,1)}}};var GUI={};GUI.toolbar=[];GUI.IMAGES_PATH="img/GUI/";GUI.MOUSE_ICONS={standard:'url("'+GUI.IMAGES_PATH+'cursor.png"), auto',select:'url("'+GUI.IMAGES_PATH+'cursor_hover.png"), auto',attack:'url("'+GUI.IMAGES_PATH+'cursor_attack.png"), auto',cross:'url("'+GUI.IMAGES_PATH+'cursor_cross.png"), auto',crossHover:'url("'+GUI.IMAGES_PATH+'cursor_cross_hover.png"), auto',arrowTop:'url("'+GUI.IMAGES_PATH+'cursor_v.png"), auto',arrowTopRight:'url("'+GUI.IMAGES_PATH+'cursor_sw.png"), auto',arrowTopLeft:'url("'+GUI.IMAGES_PATH+'cursor_se.png"), auto',arrowBottom:'url("'+GUI.IMAGES_PATH+'cursor_v.png"), auto',arrowBottomRight:'url("'+GUI.IMAGES_PATH+'cursor_se.png"), auto',arrowBottomLeft:'url("'+GUI.IMAGES_PATH+'cursor_sw.png"), auto',arrowRight:'url("'+GUI.IMAGES_PATH+'cursor_h.png"), auto',arrowLeft:'url("'+GUI.IMAGES_PATH+'cursor_h.png"), auto'};GUI.UPDATE_FREQUENCY=0.2;GUI.GUI_ELEMENTS={none:0,bottomBar:1,minimap:2};GUI.showBuildings=false;GUI.minimapSize=0;GUI.init=function(){this.initMinimapSize();this.initResourcesBar();this.initCommonButtonsEvents();this.initSpecialButtons();this.initInfobarEvents();$("#gui").tooltip({selector:".enableTooltip"});$.extend($.fn.tooltip.defaults,{animation:false,html:true})};GUI.update=function(){this.updatePopulation();this.updateResources();this.updateToolbar();this.updateInfoBar()};GUI.initResourcesBar=function(){for(var a in gameData.RESOURCES){var b=gameData.RESOURCES[a];$("#topBar").append('<div id="resource'+b.id+'"><div class="sprite"></div><span>0</span></div>')}};GUI.initCommonButtonsEvents=function(){$("#attackButton").click(function(){userInput.enterAttackMode()});$("#stopButton").click(function(){userInput.pressStopKey()});$("#holdButton").click(function(){userInput.pressHoldKey()});$("#patrolButton").click(function(){userInput.enterPatrolMode()})};GUI.initSpecialButtons=function(){$("#specialButtons").on("click","button",function(){if(!$(this).hasClass("disabled")){var a=$(this).attr("data-id");userInput.clickSpecialButton(a)}});$("#queueBuilding").on("click","button",function(){var a=$(this).attr("data-id");userInput.cancelQueue(a)})};GUI.initInfobarEvents=function(){$("#listSelected").on("click","button",function(b){var a=parseInt($(this).attr("data-id"));if(b.ctrlKey&&gameContent.selected.indexOf(a)>-1){gameContent.selected.splice(gameContent.selected.indexOf(a),1);gameSurface.unselectElement(a)}else{if(gameContent.selected.length==1){gameSurface.centerCameraOnElement(utils.getElementFromId(a))}else{gameSurface.unselectAll();gameContent.selected=[a];gameSurface.selectElement(a)}}})};GUI.initMinimapSize=function(){var a=document.getElementById("minimap");this.minimapSize=0.12*window.innerWidth};GUI.updatePopulation=function(){var a=gameContent.players[gameContent.myArmy];$("span","#population").html(a.pop.current+" / "+a.pop.max)};GUI.updateResources=function(){var b=gameContent.players[gameContent.myArmy];for(var a in gameData.RESOURCES){var c=gameData.RESOURCES[a];$("span","#resource"+c.id).html(b.re[c.id])}};GUI.updateInfoBar=function(){if(gameContent.selected.length>0){$.each($("button","#listSelected"),function(){if(gameContent.selected.indexOf(parseInt($(this).attr("data-id")))==-1){$(this).remove()}});for(var e in gameContent.selected){var d=utils.getElementFromId(gameContent.selected[e]);var c=tools.getElementData(d);var g=$('button[data-id="'+d.id+'"]',"#listSelected");if(g.length==0){$("#listSelected").append('<button data-id="'+d.id+'" class="'+gameSurface.getLifeBarBackgroundColor(d.l/c.l)+'"><div class="'+c.g+' sprite"></div></button>')}else{g.attr("class",gameSurface.getLifeBarBackgroundColor(d.l/c.l))}}var d=utils.getElementFromId(gameContent.selected[0]);var c=tools.getElementData(d);$("#nameElement").html(c.name);if(d.f==gameData.FAMILIES.land){$("#lifeElement").html("");$(".landOnly").removeClass("hideI");$(".unitOnly").addClass("hideI");$("#defenseStat").addClass("hideI");$("#popStat").addClass("hideI");$("#queueBuilding").addClass("hideI");if(d.t==gameData.RESOURCES.wood.id){$("span","#resourcesStatWood").html(d.ra);$("#resourcesStatWood").removeClass("hideI");$("#resourcesStatWater").addClass("hideI")}else{if(d.t==gameData.RESOURCES.water.id){$("span","#resourcesStatWater").html(d.ra);$("#resourcesStatWood").addClass("hideI");$("#resourcesStatWater").removeClass("hideI")}else{$("#resourcesStatWood").addClass("hideI");$("#resourcesStatWater").addClass("hideI")}}}else{$(".landOnly").addClass("hideI");$("#lifeElement").html(d.l+"/"+c.l).attr("class",gameSurface.getLifeBarBackgroundColor(d.l/c.l)+" stat");$("span","#popStat").html(c.pop).removeClass("hideI");$("span","#defenseStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.defense)).removeClass("hideI");if(c.attack!=null){$(".unitOnly").removeClass("hideI");$("span","#fragsStat").html(d.fr);$("span","#attackStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.attack));$("span","#attackSpeedStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.attackSpeed));$("span","#rangeStat").html(accessors.getStat(gameContent.players,d.o,c,fightLogic.STATS_BUFF.range))}else{$(".unitOnly").addClass("hideI")}if(d.f==gameData.FAMILIES.building&&rank.isAlly(gameContent.players,gameContent.myArmy,d)&&d.q.length>0){$("button","#queueBuilding").addClass("hideI");for(var e=0;e<d.q.length;e++){var a=d.q[e];var f=null;if(a>=0){var b=gameData.ELEMENTS[gameData.FAMILIES.unit][d.r];f=b[Object.keys(b)[a]]}else{f=tools.getElementDataFrom(gameData.FAMILIES.research,d.r,a)}if(e==0){$("#queueProgress").html(d.qp+"%")}$(".sprite:eq("+e+")","#queueBuilding").attr("class",f.g+" sprite");$("button:eq("+e+")","#queueBuilding").removeClass("hideI")}$("#queueBuilding").removeClass("hideI")}else{$("button","#queueBuilding").addClass("hideI");$("#queueBuilding").addClass("hideI")}}$("#infoSelected").removeClass("hideI")}else{if($("#listSelected").html()!=""){$("#listSelected").html("")}$("#infoSelected").addClass("hideI")}};GUI.updateToolbar=function(){if(gameContent.selected.length>0&&rank.isAlly(gameContent.players,gameContent.myArmy,utils.getElementFromId(gameContent.selected[0]))){var c=utils.getElementFromId(gameContent.selected[0]);if(c.f==gameData.FAMILIES.building){$("#commonButtons").addClass("hideI");if(c.cp<100){this.toolbar=[gameData.BUTTONS.cancel]}else{this.toolbar=production.getWhatCanBeBought(gameContent.players,c.o,tools.getElementDataFrom(gameData.FAMILIES.building,c.r,c.t).buttons)}}else{if(c.f==gameData.FAMILIES.unit){if(this.showBuildings){$("#commonButtons").addClass("hideI");this.toolbar=this.getBuildingButtons(c)}else{$("#commonButtons").removeClass("hideI");this.toolbar=tools.getElementDataFrom(gameData.FAMILIES.unit,c.r,c.t).buttons}}}$("#specialButtons").removeClass("hideI")}else{this.toolbar=[];$("#commonButtons").addClass("hideI");$("#specialButtons").addClass("hideI")}$("#specialButtons button").addClass("hide");for(var b in this.toolbar){var a=this.toolbar[b];this.createToolbarButton(a)}};GUI.isGUIClicked=function(a,b){if(b>window.innerHeight-120&&a<window.innerWidth-this.minimapSize){return this.GUI_ELEMENTS.bottomBar}else{if(a>window.innerWidth-this.minimapSize&&b>window.innerHeight-this.minimapSize){return this.GUI_ELEMENTS.minimap}else{return this.GUI_ELEMENTS.none}}};GUI.clickOnMinimap=function(b,c){var a=this.convertToMinimapPosition(b,c);gameSurface.centerCameraOnPosition(a)};GUI.convertToMinimapPosition=function(a,b){return{x:parseInt(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE*(this.minimapSize-window.innerWidth+a)/this.minimapSize),y:parseInt(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE*(window.innerHeight-b)/this.minimapSize)}};GUI.fromRealToMinimapPosition=function(a,c){var b={x:parseInt(a/(gameContent.map.size.x*gameSurface.PIXEL_BY_NODE)*this.minimapSize),y:parseInt(c/(gameContent.map.size.y*gameSurface.PIXEL_BY_NODE)*this.minimapSize)};if(b.x<0){b.x=0}else{if(b.x>this.minimapSize-1){b.x=this.minimapSize-1}}if(b.y<0){b.y=0}else{if(b.y>this.minimapSize-1){b.y=this.minimapSize-1}}return b};GUI.getBuildingButtons=function(a){return production.getWhatCanBeBought(gameContent.players,a.o,gameData.ELEMENTS[gameData.FAMILIES.building][a.r])};GUI.updateMouse=function(a){document.body.style.cursor=a};GUI.createToolbarButton=function(b){if($("#toolbar"+b.id).html()!=null){$("#toolbar"+b.id).removeClass("hide")}else{var d;if(b.needs!=null&&b.needs.length>0){d="<p>"+b.name+"</p>"}else{d=b.name}for(var a in b.needs){var c=b.needs[a];if(c.t>=0){d+='<p class="price"><span class="'+gameData.RESOURCES[Object.keys(gameData.RESOURCES)[c.t]].image+' sprite">&nbsp;</span>'+c.value+"</p>"}else{d+="<p>"+c.t+"</p>"}}var e='<button id="toolbar'+b.id+'" data-id="'+b.id+'" class="enableTooltip" data-toggle="tooltip" title=\''+d+"'><div class=\""+b.g+' sprite"></div></button>';$("#specialButtons").append(e)}if(!b.isEnabled){$("#toolbar"+b.id).addClass("disabled")}else{$("#toolbar"+b.id).removeClass("disabled")}};GUI.selectButton=function(a){this.unselectButtons();$("#toolbar"+a.buttonId).addClass("selected")};GUI.unselectButtons=function(){$("button","#toolbar").removeClass("selected")};var gameManager={};gameManager.isOfflineGame=false;gameManager.offlineGameLoop=0;gameManager.musicEnabled=false;gameManager.getPlayerId=function(){var a=utils.readCookie("rts_player_id");if(a==null){var b=new Date().getTime()+Math.random();utils.createCookie("rts_player_id",b);a=b}return a};gameManager.getPlayerName=function(){var a=utils.readCookie("rts_player_name");if(a==null){return gameData.getRandomName()}else{return a}};gameManager.updatePlayerName=function(a){utils.createCookie("rts_player_name",a);this.playerName=a};gameManager.sendOrderToEngine=function(a,b){if(this.isOfflineGame){gameContent.game.orders.push([a,b])}else{socketManager.sendOrder(gameContent.gameId,a,b)}};gameManager.createGameObject=function(c,d,j,b,e,f,i,a,h,g){return{playerId:c,playerName:d,armyId:j,mapType:b,mapSize:e,initialResources:f,vegetation:i,objectives:a,nbPlayers:h,iaPlayers:g}};gameManager.startOfflineGame=function(b){this.isOfflineGame=true;gameContent.myArmy=b.armyId;gameContent.players=[];gameContent.players.push(new gameData.Player(0,0,b.armyId,false));gameContent.players[0].n=b.playerName;for(var c=0;c<b.iaPlayers.length;c++){var a=c+1;gameContent.players.push(new gameData.Player(a,a,b.iaPlayers[c],true));gameContent.players[a].n=gameData.getRandomName()}gameContent.map=new gameData.Map(gameData.MAP_TYPES[Object.keys(gameData.MAP_TYPES)[b.mapType]],gameData.MAP_SIZES[Object.keys(gameData.MAP_SIZES)[b.mapSize]],gameData.VEGETATION_TYPES[Object.keys(gameData.VEGETATION_TYPES)[b.vegetation]],gameData.INITIAL_RESOURCES[Object.keys(gameData.INITIAL_RESOURCES)[b.initialResources]],b.objectives);gameContent.game=gameCreation.createNewGame(gameContent.map,gameContent.players);this.waitingData=gameContent.game.gameElements;$("#loadingLabel").html("Loading");gameSurface.init();GUI.init()};gameManager.updateLoadingProgress=function(a){$(".bar","#loadingProgress").css("width",a+"%");if(this.isOfflineGame||gameContent.isRunning){if(a>=100){this.startGame()}}else{if(a>=100||Math.random()<0.2){socketManager.updateLoadingProgress(this.playerId,gameContent.gameId,a)}}};gameManager.startGame=function(){setTimeout(function(){$("#game").removeClass("hide");$("#loadingScreen").remove()},500);gameContent.init(this.waitingData);if(this.isOfflineGame&&this.offlineGameLoop==0){this.offlineGameLoop=setInterval(function(){gameContent.update(gameContent.game.update())},1000/gameLogic.OFFLINE_FREQUENCY)}};gameManager.updateJoinableGamesList=function(c){$("tbody","#lstGames").html("");if(c.games.length>0){$(".noResult","#joinGame").addClass("hide");$("table","#joinGame").removeClass("hide");for(var b in c.games){var a=c.games[b];$("tbody","#lstGames").append('<tr data-id="'+a.id+'"><td>'+a.creatorName+"</td><td>"+a.mapSize+"</td><td>"+a.initialResources+"</td><td>"+a.objectives+"</td><td>"+a.players+"</td></tr>")}}else{$(".noResult","#joinGame").removeClass("hide");$("table","#joinGame").addClass("hide")}$("tbody tr","#lstGames").click(function(){soundManager.playSound(soundManager.SOUNDS_LIST.mainButton);$(this).unbind("click");$(".modal").modal("hide");showLoadingScreen("Loading");var d=$(this).attr("data-id");var e=$(".checked","#armies").attr("data-army");socketManager.joinGame(gameManager.playerId,gameManager.playerName,d,e);removeWebsiteDom()})};gameManager.initOnlineGame=function(a){gameContent.gameId=a.gameId;gameContent.players=a.players;gameContent.myArmy=a.myArmy;gameContent.map=a.map;gameContent.isRunning=a.isRunning;this.waitingData=a.initElements;$("#loadingLabel").html("Loading");gameSurface.init();GUI.init()};gameManager.updateQueue=function(c){$("#playersLoading").removeClass("hide").html("");for(var b in c.players){var a=c.players[b];if(this.playerId!=a.pid){$("#playersLoading").append('<div data-id="'+a.pid+'"><div class="color '+gameSurface.PLAYERS_COLORS[b]+'">&nbsp;</div><div class="name">'+a.n+'</div><div class="progress"><div class="bar" style="width: 0%"></div></div></div>')}}};gameManager.playersReady=[];gameManager.updateLoadingQueue=function(a){$("#labelLoading").html("Loading");$(".bar",'div[data-id="'+a.playerId+'"]').css("width",a.loadingProgress+"%");if(a.loadingProgress>=100&&this.playersReady.indexOf(a.playerId)==-1){this.playersReady.push(a.playerId)}if(this.playersReady.length>=gameContent.players.length){this.startGame()}};gameManager.showStats=function(b,f){if(b==gameData.PLAYER_STATUSES.victory){$("#endGameMessage").addClass("victory");$("#endGameMessage").html("Victory !")}else{$("#endGameMessage").addClass("defeat");$("#endGameMessage").html("Defeat...")}$("#endGame").removeClass("hide");var c=[];for(var e in f){var j=f[e];var h=gameContent.players[e];var a=[];for(var e in h.tec){var g=h.tec[e];if(a.indexOf(g)==-1){a.push(g)}}var d=stats.getTotalScore(j,a.length);$("tbody","#endGame").append('<tr class="'+gameSurface.PLAYERS_COLORS[e]+'"><td>'+h.n+"</td><td>"+j.killed+"</td><td>"+j.lost+"</td><td>"+j.buildingsDestroyed+"</td><td>"+j.unitsCreated+"</td><td>"+j.resources+"</td><td>"+j.buildersCreated+"</td><td>"+j.buildingsCreated+"</td><td>"+a.length+"</td><td>"+d+"</td></tr>");c.push(j.pop)}var k={xaxis:{show:false},yaxis:{min:0,autoscaleMargin:1,position:"right",tickDecimals:0},colors:gameSurface.PLAYERS_COLORS};$("#popChart").css({height:"160px",width:window.innerWidth/2,left:window.innerWidth/4});$.plot($("#popChart"),c,k)};gameManager.askRejoin=function(a){$("#notifications").removeClass("hide").append('<div class="notification rejoin blackBackground">You were in a game. Do you want to rejoin it ?<div><button class="ok green">Yes</button><button class="no red">No</button></div></div>');$(".ok",".rejoin").click(function(){$(this).unbind("click");$(".modal").modal("hide");removeWebsiteDom();showLoadingScreen("Loading");socketManager.rejoinGame(gameManager.playerId,a.gameId);$(".rejoin").fadeOut()});$(".no",".rejoin").click(function(){$(".rejoin").fadeOut()})};var soundManager={};soundManager.MUSIC_FILES_PATH="music/";soundManager.MUSICS_LIST=["0","1"];soundManager.SOUNDS_LIST={mainButton:"main_button",button:"button",hammer:"hammer",saw:"saw"};soundManager.SOUND_VOLUME=0.5;soundManager.audioFilesFormat=null;soundManager.musicTag=null;soundManager.soundTag=null;soundManager.init=function(){try{this.musicTag=$("audio","#musicTags")[0];this.soundTag=$("audio","#musicTags")[1];if(this.musicTag.canPlayType("audio/ogg")!=""){this.audioFilesFormat=".ogg"}else{if(this.musicTag.canPlayType("audio/mp3")!=""){this.audioFilesFormat=".mp3"}}this.musicTag.addEventListener("ended",function(){soundManager.musicTag.src=null;soundManager.playMusic()});this.soundTag.volume=this.SOUND_VOLUME}catch(a){}};soundManager.playMusic=function(){if(gameManager.musicEnabled&&this.audioFilesFormat!=null){if(this.musicTag.src==null||this.musicTag.src==""){this.musicTag.src=this.MUSIC_FILES_PATH+this.getRandomMusic()+this.audioFilesFormat}this.musicTag.play()}};soundManager.stopMusic=function(){if(this.audioFilesFormat!=null){this.musicTag.pause();this.soundTag.pause()}};soundManager.playSound=function(a){if(gameManager.musicEnabled&&this.audioFilesFormat!=null){this.soundTag.src=this.MUSIC_FILES_PATH+a+this.audioFilesFormat;this.soundTag.play()}};soundManager.getRandomMusic=function(){return this.MUSICS_LIST[parseInt(Math.random()*this.MUSICS_LIST.length)]};var controls={};controls.SCROLL_THRESHOLD=15;controls.STATE={NONE:-1,SELECTION:0,ACTION:2};controls.MODES={normal:order.SPECIAL_ORDERS.normal,attack:order.SPECIAL_ORDERS.attack,patrol:order.SPECIAL_ORDERS.patrol};controls.MAP_SCROLL_SPEED=2;controls.SCROLL_THRESHOLD=15;controls.clickMode=controls.MODES.normal;controls.mousePosition={};controls._state=controls.STATE.NONE;controls.scroll=[0,0];controls.isKeyboardScrolling=false;controls.cameraMovesLimits=null;controls.init=function(){window.addEventListener("contextmenu",function(a){a.preventDefault()},false);window.addEventListener("keydown",controls.keydown,false);window.addEventListener("keyup",controls.keyup,false);window.addEventListener("mousedown",controls.mousedown,false);window.addEventListener("mousemove",controls.mousemove,false);window.addEventListener("dblclick",controls.doubleClick,false);this.cameraMovesLimits=[-100,-100,gameContent.map.size.x*gameSurface.PIXEL_BY_NODE+100,gameContent.map.size.y*gameSurface.PIXEL_BY_NODE+100]};controls.updateCamera=function(){if(camera.beta<0.1){camera.beta=0.1}else{if(camera.beta>(Math.PI/2)*0.92){camera.beta=(Math.PI/2)*0.92}}if(camera.radius>70){camera.radius=70}if(camera.radius<5){camera.radius=5}if(this.scroll[0]!=0||this.scroll[1]!=0){var a={x:-this.scroll[0]*Math.cos(camera.alpha+Math.PI/2)-this.scroll[1]*Math.cos(camera.alpha),z:-this.scroll[0]*Math.sin(camera.alpha+Math.PI/2)-this.scroll[1]*Math.sin(camera.alpha)};if(camera.target.x+a.x>this.cameraMovesLimits[0]&&camera.target.x+a.x<this.cameraMovesLimits[2]&&camera.target.z+a.z>this.cameraMovesLimits[1]&&camera.target.z+a.z<this.cameraMovesLimits[3]){camera.target=new BABYLON.Vector3(camera.target.x+a.x,0,camera.target.z+a.z)}}};controls.keydown=function(a){switch(a.keyCode){case 8:return true;case 13:userInput.pressEnterKey();return true;case 32:userInput.pressSpaceKey();return true;case 38:controls.updateScrolling(1,1,true);return false;break;case 40:controls.updateScrolling(1,-1,true);return false;break;case 39:controls.updateScrolling(0,-1,true);return false;break;case 37:controls.updateScrolling(0,1,true);return false;break;case 83:userInput.pressStopKey();return true;break;case 72:userInput.pressHoldKey();return true;break;case 80:userInput.enterPatrolMode();return true;break;case 65:userInput.enterAttackMode();return true;break;case 49:a.preventDefault();userInput.pressHotKey(0,a.ctrlKey);return true;break;case 50:a.preventDefault();userInput.pressHotKey(1,a.ctrlKey);return true;break;case 51:a.preventDefault();userInput.pressHotKey(2,a.ctrlKey);return true;break;case 52:a.preventDefault();userInput.pressHotKey(3,a.ctrlKey);return true;break;case 53:a.preventDefault();userInput.pressHotKey(4,a.ctrlKey);return true;break}};controls.keyup=function(a){switch(a.keyCode){case 38:controls.updateScrolling(1,0,true);break;case 40:controls.updateScrolling(1,0,true);break;case 39:controls.updateScrolling(0,0,true);break;case 37:controls.updateScrolling(0,0,true);break}};controls.updateScrolling=function(c,b,a){this.scroll[c]=b*this.MAP_SCROLL_SPEED;if(a){this.isKeyboardScrolling=(b==0?false:true)}};controls.mousedown=function(a){if(a.button==1){return}a.preventDefault();a.stopPropagation();if(a.button==0){if(controls.clickMode!=controls.MODES.normal){userInput.doAction(a.clientX,a.clientY,a.shiftKey,controls.clickMode);userInput.leaveSpecialClickMode()}else{controls._state=controls.STATE.SELECTION;userInput.doSelect(a.clientX,a.clientY,a.ctrlKey,a.shiftKey)}}else{if(a.button==2){if(controls.clickMode!=controls.MODES.normal){userInput.leaveSpecialClickMode()}else{userInput.doAction(a.clientX,a.clientY,a.shiftKey,controls.clickMode)}}}document.addEventListener("mouseup",mouseup,false)};controls.mousemove=function(a){a.preventDefault();a.stopPropagation();console.log;if(controls._state===controls.STATE.SELECTION){userInput.drawSelectionRectangle(a.clientX,a.clientY,a.ctrlKey)}else{if(a.clientX<controls.SCROLL_THRESHOLD){controls.updateScrolling(0,1,false)}else{if(a.clientX>window.innerWidth-controls.SCROLL_THRESHOLD){controls.updateScrolling(0,-1,false)}else{if(!controls.isKeyboardScrolling&&controls.scroll[0]!=0){controls.updateScrolling(0,0,false)}}}if(a.clientY<controls.SCROLL_THRESHOLD){controls.updateScrolling(1,1,false)}else{if(a.clientY>window.innerHeight-controls.SCROLL_THRESHOLD){controls.updateScrolling(1,-1,false)}else{if(!controls.isKeyboardScrolling&&controls.scroll[1]!=0){controls.updateScrolling(1,0,false)}}}userInput.onMouseMove(a.clientX,a.clientY)}controls.mousePosition.x=a.clientX;controls.mousePosition.y=a.clientY};function mouseup(a){a.preventDefault();a.stopPropagation();this._state===controls.STATE.NONE;userInput.onMouseUp();document.removeEventListener("mouseup",mouseup)}function doubleClick(a){a.preventDefault();a.stopPropagation();userInput.doDoubleClick(a.clientX,a.clientY)}var userInput={};userInput.CAN_BE_BUILT_HERE=10;userInput.CANNOT_BE_BUILT_HERE=1;userInput.DOUBLE_CLICK_RADIUS_SIZE=15;userInput.isChatWindowOpen=false;userInput.hotKeysContent=[[],[],[],[],[]];userInput.doSelect=function(c,h,e,d){var b=GUI.isGUIClicked(c,h);if(b==GUI.GUI_ELEMENTS.bottomBar){return}else{if(b==GUI.GUI_ELEMENTS.minimap){GUI.clickOnMinimap(c,h);return}}if(gameContent.building!=null){this.tryBuildHere(d);return false}else{this.leaveConstructionMode();if(!e){gameSurface.unselectAll();gameContent.selected=[]}gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1);gameContent.selectionRectangle[0]=c;gameContent.selectionRectangle[1]=h;var a=gameSurface.getFirstIntersectObject(c,h);if(a!=null&&a.elementId!=null){if(e&&gameContent.selected.indexOf(a.object.elementId)>-1){gameContent.selected.splice(gameContent.selected.indexOf(a.object.elementId),1);gameSurface.unselectElement(a.object.elementId)}else{gameContent.selected.push(a.object.elementId);gameSurface.selectElement(a.object.elementId)}}if(gameContent.selected.length>1){for(var g in gameContent.selected){var f=""+gameContent.selected[g];if(parseInt(f.charAt(1))==gameData.FAMILIES.land){gameSurface.unselectElement(gameContent.selected[g]);gameContent.selected.splice(g,1);break}}}return true}};userInput.doAction=function(b,h,c,f){var a=GUI.isGUIClicked(b,h);if(a==GUI.GUI_ELEMENTS.bottomBar){return}if(gameContent.building!=null){this.leaveConstructionMode()}else{if(gameContent.selected.length>0){var e=utils.getElementFromId(gameContent.selected[0]);if(rank.isAlly(gameContent.players,gameContent.myArmy,e)&&(e.f==gameData.FAMILIES.unit||e.f==gameData.FAMILIES.building)){var g=false;var a=GUI.isGUIClicked(b,h);if(a==GUI.GUI_ELEMENTS.minimap){var d=GUI.convertToMinimapPosition(b,h);b=d.x;h=d.y;g=true}this.dispatchUnitAction(b,h,c,f,g)}}}};userInput.doDoubleClick=function(a,f){if(gameContent.selected.length>0){var e=utils.getElementFromId(gameContent.selected[0]);if(rank.isAlly(gameContent.players,gameContent.myArmy,e)){var b=tools.getTilesAround(gameContent.grid,e.p,this.DOUBLE_CLICK_RADIUS_SIZE,true);for(var d in b){if(b[d]>0){var c=utils.getElementFromId(b[d]);if(gameContent.selected.indexOf(c.id)==-1&&c.f==e.f&&rank.isAlly(gameContent.players,gameContent.myArmy,c)&&c.t==e.t){gameContent.selected.push(c.id);gameSurface.selectElement(c.id)}}}}}};userInput.pressToolbarShortcut=function(a){};userInput.pressEnterKey=function(){if(this.isChatWindowOpen){$("#chat").addClass("hide");var a=$("input","#chat").val();if(a!=""){if(a=="olivier !"||a=="/soundon"){gameManager.musicEnabled=true;soundManager.playMusic();gameSurface.showMessage(gameSurface.MESSAGES.musicEnabled)}else{if(a=="paranormalement"||a=="/soundoff"){gameManager.musicEnabled=false;soundManager.stopMusic();gameSurface.showMessage(gameSurface.MESSAGES.musicDisabled)}else{if(a=="/surrender"){gameManager.sendOrderToEngine(order.TYPES.surrender,[gameContent.myArmy])}else{gameManager.sendOrderToEngine(order.TYPES.chat,[gameContent.myArmy,$("input","#chat").val()])}}}}$("input","#chat").val("")}else{$("#chat").removeClass("hide");$("#chat").css("top",(window.innerHeight-$("#chat").height())/2);$("#chat").css("left",(window.innerWidth-$("#chat").width())/2);$("input","#chat")[0].focus()}this.isChatWindowOpen=!this.isChatWindowOpen};userInput.pressSpaceKey=function(){if(gameContent.selected.length>0){gameSurface.centerCameraOnElement(utils.getElementFromId(gameContent.selected[0]))}};userInput.onMouseMove=function(a,b){this.updateConstructionMode(a,b);this.updateMouseIcon(a,b)};userInput.onMouseUp=function(){this.removeSelectionRectangle()};userInput.clickSpecialButton=function(f){soundManager.playSound(soundManager.SOUNDS_LIST.button);if(f==gameData.BUTTONS.build.id){GUI.showBuildings=true}else{if(f==gameData.BUTTONS.back.id){GUI.showBuildings=false}else{if(f==gameData.BUTTONS.cancel.id){gameManager.sendOrderToEngine(order.TYPES.cancelConstruction,[utils.getElementFromId(gameContent.selected[0]).id])}else{if(GUI.showBuildings){var d=gameData.ELEMENTS[gameData.FAMILIES.building][gameContent.players[gameContent.myArmy].r];var c=d[Object.keys(d)[(""+f)[2]]];this.enterConstructionMode(c)}else{if(utils.getElementFromId(gameContent.selected[0]).f==gameData.FAMILIES.building){var e=(""+f)[0];var b;if(e==gameData.FAMILIES.unit){var a=gameData.ELEMENTS[gameData.FAMILIES.unit][gameContent.players[gameContent.myArmy].r];b=a[Object.keys(a)[(""+f)[2]]]}else{var g=gameData.ELEMENTS[gameData.FAMILIES.research][gameContent.players[gameContent.myArmy].r];b=g[(""+f).substring(2)]}gameManager.sendOrderToEngine(order.TYPES.buy,[gameContent.selected,b])}}}}}};userInput.enterConstructionMode=function(a){gameContent.building=a;GUI.selectButton(a);this.updateConstructionMode(controls.mousePosition.x,controls.mousePosition.y)};userInput.updateConstructionMode=function(a,d){if(gameContent.building!=null){gameContent.building.p=gameSurface.getAbsolutePositionFromPixel(a,d);gameContent.building.canBeBuiltHere=true;for(var c in gameContent.building.shape){for(var b in gameContent.building.shape[c]){gameContent.building.shape[c][b]=this.CAN_BE_BUILT_HERE}}utils.canBeBuiltHere(gameContent.building);gameSurface.updateBuildingGeometry()}};userInput.leaveConstructionMode=function(){gameContent.building=null;gameSurface.removeBuildingGeometry();GUI.unselectButtons();GUI.showBuildings=false};userInput.updateMouseIcon=function(c,b){var d=gameSurface.getFirstIntersectObject(c,b);var a=-controls.scroll[0];var g=controls.scroll[1];if(d!=null&&d.elementId!=null){var f=utils.getElementFromId(d.elementId);if(controls.clickMode!=controls.MODES.normal){GUI.updateMouse(GUI.MOUSE_ICONS.crossHover);return}else{if(f!=null&&f.f!=gameData.FAMILIES.land&&rank.isEnemy(gameContent.players,gameContent.myArmy,f)){GUI.updateMouse(GUI.MOUSE_ICONS.attack)}else{GUI.updateMouse(GUI.MOUSE_ICONS.select)}}}else{if(controls.clickMode!=controls.MODES.normal){GUI.updateMouse(GUI.MOUSE_ICONS.cross)}else{if(!controls.isKeyboardScrolling){if(a>0&&g>0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopRight)}else{if(a>0&&g==0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowRight)}else{if(a>0&&g<0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomRight)}else{if(a<0&&g>0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowTopLeft)}else{if(a<0&&g==0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowLeft)}else{if(a<0&&g<0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottomLeft)}else{if(a==0&&g>0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowTop)}else{if(a==0&&g<0){GUI.updateMouse(GUI.MOUSE_ICONS.arrowBottom)}else{GUI.updateMouse(GUI.MOUSE_ICONS.standard)}}}}}}}}}}}};userInput.tryBuildHere=function(a){if(gameContent.building.canBeBuiltHere){soundManager.playSound(soundManager.SOUNDS_LIST.hammer);gameManager.sendOrderToEngine(order.TYPES.buildThatHere,[gameContent.selected,gameContent.building,gameContent.building.p.x,gameContent.building.p.y,a]);if(!a){this.leaveConstructionMode()}}else{}};userInput.dispatchUnitAction=function(b,g,c,e,f){var a=null;if(f){a={x:parseInt(b/gameSurface.PIXEL_BY_NODE),y:parseInt(g/gameSurface.PIXEL_BY_NODE)}}else{var d=gameSurface.getFirstIntersectObject(b,g);if(d!=null){if(d.object.elementId!=null){a=utils.getElementFromId(d.object.elementId).p;gameSurface.animateSelectionCircle(d.object.elementId)}else{a={x:parseInt(d.point.x/gameSurface.PIXEL_BY_NODE),y:parseInt(d.point.y/gameSurface.PIXEL_BY_NODE)}}}}if(a!=null&&a.x>=0&&a.y>=0&&a.x<gameContent.map.size.x&&a.y<gameContent.map.size.y){gameManager.sendOrderToEngine(order.TYPES.action,[gameContent.selected,a.x,a.y,c,e])}};userInput.drawSelectionRectangle=function(o,n,m){if(gameContent.selectionRectangle.length>0){if(!m){gameSurface.unselectAll();gameContent.selected=[]}var b=false;gameSurface.updateSelectionRectangle(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1],o,n);var f=gameSurface.getFirstIntersectObject(gameContent.selectionRectangle[0],gameContent.selectionRectangle[1]).point;var e=gameSurface.getFirstIntersectObject(o,n).point;var c=gameSurface.convertScenePositionToGamePosition(f);var a=gameSurface.convertScenePositionToGamePosition(e);var p=[c.x,c.y,a.x,a.y];for(var k=Math.min(p[0],p[2]);k<=Math.max(p[0],p[2]);k++){for(var g=Math.min(p[1],p[3]);g<=Math.max(p[1],p[3]);g++){if(gameContent.grid[k][g]>0){var h=utils.getElementFromId(gameContent.grid[k][g]);if(rank.isAlly(gameContent.players,gameContent.myArmy,h)){if(!m||gameContent.selected.indexOf(h.id)==-1){gameContent.selected.push(h.id);gameSurface.selectElement(h.id);b=true}}}}}for(var k in gameContent.selected){var d=""+gameContent.selected[k];if(d.charAt(1)==gameData.FAMILIES.unit){var l=gameContent.selected.length;while(l--){var h=utils.getElementFromId(gameContent.selected[l]);if(h.f==gameData.FAMILIES.building){gameContent.selected.splice(l,1);gameSurface.unselectElement(h.id)}}break}}if(b){var l=gameContent.selected.length;while(l--){var h=utils.getElementFromId(gameContent.selected[l]);if(h.f==gameData.FAMILIES.land){gameContent.selected.splice(l,1);gameSurface.unselectElement(h.id)}}}}};userInput.removeSelectionRectangle=function(){gameContent.selectionRectangle=[];gameSurface.updateSelectionRectangle(-1,-1,-1,-1)};userInput.pressStopKey=function(){if(gameContent.selected.length>0){gameManager.sendOrderToEngine(order.TYPES.stop,[gameContent.selected])}};userInput.pressHoldKey=function(){if(gameContent.selected.length>0){gameManager.sendOrderToEngine(order.TYPES.hold,[gameContent.selected])}};userInput.enterPatrolMode=function(){if(gameContent.selected.length>0){GUI.unselectButtons();$("#patrolButton").addClass("selected");controls.clickMode=controls.MODES.patrol}};userInput.enterAttackMode=function(){if(gameContent.selected.length>0){GUI.unselectButtons();$("#attackButton").addClass("selected");controls.clickMode=controls.MODES.attack}};userInput.leaveSpecialClickMode=function(){GUI.unselectButtons();GUI.updateMouse(GUI.MOUSE_ICONS.standard);controls.clickMode=controls.MODES.normal};userInput.pressHotKey=function(b,a){if(a){this.hotKeysContent[b]=[];for(var c in gameContent.selected){this.hotKeysContent[b].push(gameContent.selected[c])}}else{var d=this.hotKeysContent[b].length;if(d==0){return}while(d--){if(utils.getElementFromId(this.hotKeysContent[b][d])==null){this.hotKeysContent[b].splice(d,1)}}if(gameContent.selected.length==this.hotKeysContent[b].length&&this.hotKeysContent[b].indexOf(gameContent.selected[0])>-1){gameSurface.centerCameraOnElement(utils.getElementFromId(gameContent.selected[0]))}gameSurface.unselectAll();gameContent.selected=[];for(var c in this.hotKeysContent[b]){gameContent.selected.push(this.hotKeysContent[b][c]);gameSurface.selectElement(this.hotKeysContent[b][c])}}};userInput.cancelQueue=function(a){gameManager.sendOrderToEngine(order.TYPES.cancelQueue,[gameContent.selected[0],a])};WaterSurface=function(a,f,c,e,d){this.speed=0.15;this.geometry=new THREE.PlaneGeometry(a,f,24*c,24*c);e.wrapT=e.wrapS=THREE.RepeatWrapping;e.repeat.set(32,32);d.wrapT=d.wrapS=THREE.RepeatWrapping;d.repeat.set(32,32);this.uniforms={texture:{type:"t",value:e},texture2:{type:"t",value:d},waveWidth:{type:"f",value:5},waveTime:{type:"f",value:0},textRepeat:{type:"f",value:32},};this.attributes={size:{type:"f",value:[]},};this.material=new THREE.ShaderMaterial({uniforms:this.uniforms,attributes:this.attributes,vertexShader:["uniform float waveWidth;","uniform float waveTime;","uniform float textRepeat;","attribute float size;","varying vec3 vPosition;","varying vec2 vUv;","void main() {","float z = sin(waveWidth * position.y + (waveTime-1.0)*.2) * cos(waveWidth * position.x + waveTime*.6) * 0.1","+ sin(waveWidth * waveTime*.2) * cos(waveWidth * (waveTime+1.0)*.2)*.09","+ sin(waveWidth * waveTime*.2 + size)*.08","+ sin(sqrt(waveWidth * position.x + (waveTime+2.0)) * size*1.0) * cos(sqrt(waveWidth * position.y + waveTime) * size*3.0) * 0.07;","float x = 0.0 + sin(waveWidth * position.x + waveTime/2.0) * 0.12;","float y = 0.0 - sin(waveWidth * position.y + waveTime/2.0) * 0.12;","vPosition = vec3(x, y, z);","vUv = vec2(uv.x * textRepeat + x + sin(waveTime * 0.025), uv.y * textRepeat + y + cos(waveTime * 0.05));","gl_Position = projectionMatrix * modelViewMatrix * vec4(position + vec3(vPosition.x, vPosition.y, vPosition.z * 80.0), 1.0);","}",].join("\n"),fragmentShader:["uniform sampler2D texture;","uniform sampler2D texture2;","varying vec3 vPosition;","uniform float waveTime;","uniform float textRepeat;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( texture, vUv ) * .6 + texture2D( texture2, vec2(vUv.y, vUv.x) ) * .6;","gl_FragColor = vec4(texel.rgb, 1.0);  // adjust the alpha","}",].join("\n"),transparent:false,});for(var b=0;b<this.geometry.vertices.length;b++){this.attributes.size.value[b]=Math.random()/(c*c)}this.model=new THREE.Mesh(this.geometry,this.material)};WaterSurface.prototype.animate=function(a){this.speed+=(0.5-Math.random())*0.02;if(this.speed>0.2){this.speed=0.2}if(this.speed<0.15){this.speed=0.15}this.uniforms.waveTime.value+=this.speed*a*10};