var accessors={};accessors.getStat=function(a,c,e,g){var d=null;switch(g){case fightLogic.STATS_BUFF.attack:d=e.attack;break;case fightLogic.STATS_BUFF.defense:d=e.defense;break;case fightLogic.STATS_BUFF.attackSpeed:d=e.attackSpeed;break;case fightLogic.STATS_BUFF.speed:d=e.speed;break;case fightLogic.STATS_BUFF.range:d=e.range;break;case fightLogic.STATS_BUFF.vision:d=e.vision;break}for(var h in e.techs){var k=e.techs[h];var b=gameData.ELEMENTS[gameData.FAMILIES.research][a[c].r][k];for(var f in b.addStats){if(b.addStats[f].stat==g&&a[c].tec.indexOf(k)>=0){d+=parseInt(b.addStats[f].value)}}}return d};var action={};action.ACTION_TYPES={move:0,attack:1,gather:2,patrol:3,build:4,hold:5};action.BUILD_ACTION_SPEED=3;action.ATTACK_SPEED_CONSTANT=5;action.doTheBuild=function(a,c,b){if(b.cp<100){if(a.iterate%this.BUILD_ACTION_SPEED==0){production.updateConstruction(a,b);c.fl=gameData.ELEMENTS_FLAGS.building}}else{if(b.l<tools.getElementData(b).l){if(a.iterate%this.BUILD_ACTION_SPEED==0){production.repairBuilding(a,b);c.fl=gameData.ELEMENTS_FLAGS.building}}else{order.goToElementNextOrder(a,c)}}};action.doTheAttack=function(k,e,h){var c=tools.getElementData(e);if(k.iterate%(this.ATTACK_SPEED_CONSTANT-accessors.getStat(k.players,e.o,c,fightLogic.STATS_BUFF.attackSpeed))==0){var b=c.passiveSkill[fightLogic.PASSIVE_SKILLS.shootDelay];if(b!=null){if(b.current>0){b.current--;return}}fightLogic.attack(k,e,h);e.fl=gameData.ELEMENTS_FLAGS.attacking;var j=c.passiveSkill[fightLogic.PASSIVE_SKILLS.zone];if(j!=null){var g=tools.getTilesAround(k.grid,h.p,j,true);for(var f in g){if(g[f].c!=null){var l=tools.getElementById(k,g[f].c);if(l.f!=gameData.FAMILIES.land){fightLogic.attack(k,e,l)}}}}var d=c.passiveSkill[fightLogic.PASSIVE_SKILLS.suicide];if(d!=null){e.l-=d/100*c.l;tools.addUniqueElementToArray(k.modified,e)}var a=c.passiveSkill[fightLogic.PASSIVE_SKILLS.poison];if(h.f==gameData.FAMILIES.unit&&a!=null){a.type=fightLogic.ACTIVE_BUFF.poison;h.buff.push(a)}}};action.doTheGathering=function(a,b,c){if(a.iterate%tools.getElementData(b).gatheringSpeed==0){production.gatherResources(a,b,c);b.fl=gameData.ELEMENTS_FLAGS.mining}};var AI={};AI.searchForNewResources=function(b,a,d){var c=tools.getNearestStuff(b,a,gameData.FAMILIES.land,d);if(c!=null){a.a=new gameData.Order(action.ACTION_TYPES.gather,null,c.id,d)}else{a.a=null}};AI.searchForNewEnemy=function(a,c){var b=tools.getNearestStuff(a,c,gameData.FAMILIES.unit,null,gameData.RANKS.enemy);if(b==null){b=tools.getNearestStuff(a,c,gameData.FAMILIES.building,null,gameData.RANKS.enemy)}if(b!=null){c.a=new gameData.Order(action.ACTION_TYPES.attack,null,b.id)}};AI.targetReaction=function(c,f,b){var d=tools.getElementData(f);if(d.isBuilder||(d.range>1&&tools.getElementData(b).range==1)){var e=tools.getFreeTilesAroundElements(c,f);if(e.length>0){var a=e[parseInt(Math.random()*(e.length-1))];f.a=new gameData.Order(action.ACTION_TYPES.move,a,null)}}else{f.a=new gameData.Order(action.ACTION_TYPES.attack,null,b.id)}};var aiOrders={};aiOrders.update=function(b,c){var a=c.o;this.buildHouses(b,c,a);this.harvest(b,c,a);this.trainHarvesters(b,a);this.trainSoldiers(b,c,a);this.buildRax(b,c,a);this.finishBuildings(b,a);this.buildTownHall(b,c,a);this.shoudIAttack(b,a)};aiOrders.buildRax=function(o,m,g){var l=gameData.ELEMENTS[gameData.FAMILIES.building][m.r].casern;if(m.re[0]>l.needs[0].value&&m.re[1]>l.needs[1].value){var b=null;var a=0;for(var a in o.gameElements.unit){var k=o.gameElements.unit[a];if(this.isHarvestingOrIdleWorker(k,g)){b=k}}if(b==null){return}var h=b.p;var e=0;try{for(var e=0;e<10;e++){h=b.p;order.move(o,[b],parseInt(Math.random()*o.grid[0].length-1),parseInt(Math.random()*o.grid.length-1),true);var f=tools.getFreeTilesAroundElements(o,b);for(var a in f){var p=tools.getNeighbors(o.grid,h.x,h.y);for(var d in p){h=p[d];if(this.canBeBuiltHere(o,h,l)){order.buildThatHere(o,[b.id],l,h.x,h.y,true)}}}}}catch(c){return}}};aiOrders.buildTownHall=function(o,m,h){var d=gameData.ELEMENTS[gameData.FAMILIES.building][m.r].mothertree;if(m.re[0]>d.needs[0].value&&m.re[1]>d.needs[1].value&&m.pop.current>30){var b=null;var a=0;for(var a in o.gameElements.unit){var l=o.gameElements.unit[a];if(this.isHarvestingOrIdleWorker(l,h)){b=l}}if(b==null){return}var k=b.p;var f=0;try{for(var f=0;f<10;f++){k=b.p;order.move(o,[b],parseInt(Math.random()*o.grid[0].length-1),parseInt(Math.random()*o.grid.length-1),true);var g=tools.getFreeTilesAroundElements(o,b);for(var a in g){var p=tools.getNeighbors(o.grid,k.x,k.y);for(var e in p){k=p[e];if(this.canBeBuiltHere(o,k,d)){order.buildThatHere(o,[b.id],d,k.x,k.y,true)}}}}}catch(c){return}}};aiOrders.buildHouses=function(o,m,h){var a=gameData.ELEMENTS[gameData.FAMILIES.building][m.r].house;if(m.re[0]>a.needs[0].value&&m.pop.current>m.pop.max-8){var c=null;var b=0;for(var b in o.gameElements.unit){var l=o.gameElements.unit[b];if(this.isHarvestingOrIdleWorker(l,h)){c=l}}if(c==null){return}var k=c.p;var f=0;try{for(var f=0;f<10;f++){order.move(o,[c],parseInt(Math.random()*o.grid[0].length-1),parseInt(Math.random()*o.grid.length-1),false);var g=tools.getFreeTilesAroundElements(o,c);for(var b in g){k=g[b];var p=tools.getNeighbors(o.grid,k.x,k.y);for(var e in p){k=p[e];if(this.canBeBuiltHere(o,k,a)){order.buildThatHere(o,[c.id],a,k.x,k.y,false);return}}}}}catch(d){return}}};aiOrders.finishBuildings=function(b,a){for(var g in b.gameElements.building){var d=b.gameElements.building[g];if(d.o==a&&d.l<2){var f=null;var c=0;for(var c in b.gameElements.unit){var e=b.gameElements.unit[c];if(this.isHarvestingOrIdleWorker(e,a)){f=e}}if(f==null){return}order.build(b,[f],d,false);return}}};aiOrders.trainHarvesters=function(b,a){for(var d in b.gameElements.building){var c=b.gameElements.building[d];if(c.o==a&&c.t==gameData.ELEMENTS[c.f][c.r].mothertree.t){if(c.q.length<2){order.buy(b,[c.id],gameData.ELEMENTS[gameData.FAMILIES.unit][c.r].builder)}}}};aiOrders.trainSoldiers=function(b,d,a){for(var e in b.gameElements.building){var c=b.gameElements.building[e];if(c.o==a&&c.t==gameData.ELEMENTS[gameData.FAMILIES.building][c.r].casern.t){if(c.q.length<2){if(d.re[1]<200){order.buy(b,[c.id],gameData.ELEMENTS[gameData.FAMILIES.unit][c.r].baseUnit2)}else{order.buy(b,[c.id],gameData.ELEMENTS[gameData.FAMILIES.unit][c.r].baseUnit1)}}}}};aiOrders.harvest=function(c,e,b){var h=[];for(var g in c.gameElements.unit){var f=c.gameElements.unit[g];if(this.isIdleWorker(f,b)){h.push(f)}}for(var d in h){if(e.re[1]<e.re[0]||(e.re[1]<102&&e.re[0]>80)){var a=tools.getNearestStuff(c,h[d],gameData.FAMILIES.land,1,null,true);if(a!=null){order.gather(c,[h[d]],tools.getNearestStuff(c,h[d],gameData.FAMILIES.land,1,null,true),true)}}else{var a=tools.getNearestStuff(c,h[d],gameData.FAMILIES.land,1,null,true);if(a!=null){order.gather(c,[h[d]],tools.getNearestStuff(c,h[d],gameData.FAMILIES.land,0,null,true),true)}}}};aiOrders.canBeBuiltHere=function(b,a,f){f.p=a;var g=tools.getPartPosition(f,-1,-1);var e={x:g.x+f.shape[0].length,y:g.y+f.shape.length};for(var d=g.x;d<=e.x;d++){for(var c=g.y;c<=e.y;c++){if(b.grid[d]!=null&&b.grid[d][c]!=null&&b.grid[d][c].c>0){return false}}}return true};aiOrders.isIdleWorker=function(c,a){var b=tools.getElementData(c);if(c.o==a&&b.isBuilder&&c.a==null&&c.pa.length==0){return true}return false};aiOrders.isHarvestingOrIdleWorker=function(c,a){var b=tools.getElementData(c);if(c.o==a&&b.isBuilder&&(c.a==null||c.a.type!=4)){return true}return false};aiOrders.shoudIAttack=function(j,e){var h=[];var c=0;for(var c in j.gameElements.unit){var g=j.gameElements.unit[c];var d=tools.getElementData(g);if(g.o==e&&!d.isBuilder){h.push(g)}}if(h.length>10){for(var a in j.gameElements.unit){var g=j.gameElements.unit[a];var d=tools.getElementData(g);if(g.o!=e&&!d.isBuilder){try{order.attack(j,h,g);return}catch(b){console.log("Attack failed. Error: "+b)}}}for(var a in j.gameElements.unit){var g=j.gameElements.unit[a];var d=tools.getElementData(g);if(g.o!=e&&!d.isBuilder){try{order.attack(j,h,g);return}catch(b){console.log("Attack failed. Error: "+b)}}}for(var a in j.gameElements.building){var f=j.gameElements.building[a];if(f.o!=e){try{order.attack(j,h,f);return}catch(b){console.log("Attack failed. Error: "+b)}}}}};var fightLogic={};fightLogic.WEAPON_TYPES={normal:0,piercing:1,siege:2,magic:3};fightLogic.ARMOR_TYPES={unarmored:0,light:1,medium:2,heavy:3,building:4};fightLogic.WEAPONS_EFFICIENCY=[[1,1,1.5,1,0.4],[1.5,1.5,0.5,0.5,0.2],[1.5,1,0.5,0.5,2],[1.5,1.5,1.5,1.5,0.1]];fightLogic.STATS_BUFF={attack:0,defense:1,attackSpeed:2,speed:3,range:4,vision:5};fightLogic.ACTIVE_BUFF={poison:0};fightLogic.PASSIVE_SKILLS={poison:"poison",zone:"zone",suicide:"suicide",shootDelay:"shootDelay"};fightLogic.LANDS_MODIFIERS={highgrass:0.5};fightLogic.attack=function(b,a,f){var e=tools.getElementData(a);var g=tools.getElementData(f);var c=this.WEAPONS_EFFICIENCY[e.weaponType][g.armorType];var d=Math.max(0,parseInt(accessors.getStat(b.players,a.o,e,this.STATS_BUFF.attack)*c*(1+0.2*Math.random()))-accessors.getStat(b.players,f.o,g,this.STATS_BUFF.defense));if(b.grid[f.p.x][f.p.y].s!=null){d*=fightLogic.LANDS_MODIFIERS[b.grid[f.p.x][f.p.y].s]}this.applyDamage(b,d,f,a);tools.addUniqueElementToArray(b.modified,f);if(f.f==gameData.FAMILIES.unit&&f.a==null){AI.targetReaction(b,f,a)}b.players[f.o].ra[a.o]=gameData.RANKS.enemy};fightLogic.applyDamage=function(b,c,d,a){if(d.l>0){d.l-=c;if(d.l<=0){d.fl=gameData.ELEMENTS_FLAGS.dying;if(a!=null){a.fr=a.fr+1;a.a=null;tools.addUniqueElementToArray(b.modified,a);d.murderer=a.o;AI.searchForNewEnemy(b,a)}if(d.f==gameData.FAMILIES.building){production.removeBuilding(b,d);gameCreation.removeGameElement(b,d);delete b.gameElements.building[d.id]}}}else{if(a!=null){AI.searchForNewEnemy(b,a)}}};var gameCreation={};gameCreation.PROBABILITY_TREE=0.6;gameCreation.ZONE_SIZE=8;gameCreation.createNewGame=function(f,e){var a=new gameData.Game();for(var d in e){var c=e[d];for(var g in f.ir.re){c.re.push(f.ir.re[g].value)}for(var b in e){if(b==d){c.ra.push(gameData.RANKS.me)}else{c.ra.push(gameData.RANKS.enemy)}}a.players.push(c)}this.createNewMap(a,f,e);stats.init(a);return a};gameCreation.createNewMap=function(a,d,b){a.grid=this.initGrid(d.size);if(d.t.id==gameData.MAP_TYPES.random.id){this.createRandomMap(a,d,b)}else{var c=gameData.MAP_TYPES[Object.keys(gameData.MAP_TYPES)[d.t.id]].map;this.createMap(a,d,b,c)}};gameCreation.initGrid=function(d){var c=[];for(var b=0;b<d.x;b++){c[b]=[];for(var a=0;a<d.y;a++){c[b][a]={c:0,x:b,y:a}}}return c};gameCreation.createMap=function(m,a,b,c){var k=parseInt(a.size.x/c.length);var e=[];for(var f in c){for(var d in c[f]){if(c[f][d]==gameData.ZONES.basecamp){e.push([f,d])}else{this.populateZone(m,a,{x:f*k+1,y:d*k+1},{x:(parseInt(f)+1)*k-1,y:(parseInt(d)+1)*k-1},c[f][d])}}}for(var f in b){var h=parseInt(Math.random()*e.length);var l=e[h];var g={x:l[0]*k+parseInt(k/3)+parseInt(Math.random()*k/3),y:l[1]*k+parseInt(k/3)+parseInt(Math.random()*k/3)};this.setupBasecamp(m,b[f],g);e.splice(h,1)}};gameCreation.createRandomMap=function(l,a,b){var k=parseInt(a.size.x/this.ZONE_SIZE);var h=parseInt(a.size.y/this.ZONE_SIZE);var d=[];for(var f=0;f<k;f++){d.push([]);for(var e=0;e<h;e++){d[f].push(-10)}}this.dispatchPlayers(l,d,b,k,h);var m=[];for(var f in a.ve.zones){var g=a.ve.zones[f];for(var c=0;c<g.factor;c++){m.push(g.t)}}for(var f=0;f<k;f++){for(var e=0;e<h;e++){if(d[f][e]<0){this.populateZone(l,a,{x:f*this.ZONE_SIZE,y:e*this.ZONE_SIZE},{x:(f+1)*this.ZONE_SIZE,y:(e+1)*this.ZONE_SIZE},m[parseInt(Math.random()*m.length)])}else{this.populateZone(l,a,{x:f*this.ZONE_SIZE,y:e*this.ZONE_SIZE},{x:(f+1)*this.ZONE_SIZE,y:(e+1)*this.ZONE_SIZE},d[f][e])}}}};gameCreation.populateZone=function(a,b,e,d,c){switch(c){case gameData.ZONES.forest:this.createForest(a,e,d);break;case gameData.ZONES.goldmine:this.createGoldMine(a,b,e,d);break;case gameData.ZONES.gold:this.createWaterZone(a,b,e,d);break;case gameData.ZONES.highgrass:this.createHighGrass(a,b,e,d);break}};gameCreation.createForest=function(a,e,d){for(var c=e.x;c<d.x;c++){for(var b=e.y;b<d.y;b++){if(Math.random()<this.PROBABILITY_TREE){this.addGameElement(a,new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.land][0].tree,c,b))}}}};gameCreation.createGoldMine=function(b,d,f,e){var c=gameData.ELEMENTS[gameData.FAMILIES.land][0].goldmine;var a=this.getRandomPositionInZoneForElement(c,f,e);this.addGameElement(b,new gameData.Terrain(c,a.x,a.y))};gameCreation.createHighGrass=function(a,d,f,e){for(var c=f.x;c<e.x;c++){for(var b=f.y;b<e.y;b++){this.addGameElement(a,new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.land][0].highgrass,c,b))}}};gameCreation.createWaterZone=function(a,d,f,e){for(var c=f.x;c<e.x;c++){for(var b=f.y;b<e.y;b++){this.addGameElement(a,new gameData.Terrain(gameData.ELEMENTS[gameData.FAMILIES.land][0].gold,c,b))}}};gameCreation.getRandomPositionInZoneForElement=function(a,c,b){return{x:parseInt(c.x+a.shape[0].length/2+Math.random()*(b.x-c.x-a.shape[0].length)),y:parseInt(c.y+a.shape.length/2+Math.random()*(b.y-c.y-a.shape.length))}};gameCreation.addGameElement=function(k,e){var c=tools.getElementData(e);var h=c.shape;k.gameElements[Object.keys(gameData.FAMILIES)[e.f]][e.id]=e;for(var f in h){var l=h[f];for(var d in l){var a=l[d];try{if(a>0&&(e.f!=gameData.FAMILIES.land||!c.canMoveIn)){var g=tools.getPartPosition(e,f,d);k.grid[g.x][g.y].c=e.id}else{var g=tools.getPartPosition(e,f,d);k.grid[g.x][g.y].s=e.t}}catch(b){console.log("Element Creation impossible. Error: "+b)}}}tools.addUniqueElementToArray(k.added,e)};gameCreation.removeGameElement=function(h,d){var b=tools.getElementData(d);var g=b.shape;for(var e in g){var k=g[e];for(var c in k){var a=k[c];if(a>0){var f=tools.getPartPosition(d,e,c);h.grid[f.x][f.y].c=0}}}tools.addUniqueElementToArray(h.removed,d)};gameCreation.dispatchPlayers=function(g,c,b,k,h){var j=this.getAvailableInitialPositions(b.length);for(var d in b){var a=parseInt(j.length*Math.random());var f=j[a];f={x:this.convertCoordinates(c[0].length,f.x),y:this.convertCoordinates(c.length,f.y)};j.splice(a,1);c[f.x][f.y]=gameData.ZONES.basecamp;var e={x:f.x*this.ZONE_SIZE+parseInt(this.ZONE_SIZE/4)+parseInt(Math.random()*this.ZONE_SIZE/2),y:f.y*this.ZONE_SIZE+parseInt(this.ZONE_SIZE/4)+parseInt(Math.random()*this.ZONE_SIZE/2)};this.setupBasecamp(g,b[d],e);this.placeZoneRandomlyAround(gameData.ZONES.forest,c,f.x,f.y);this.placeZoneRandomlyAround(gameData.ZONES.goldmine,c,f.x,f.y)}};gameCreation.placeZoneRandomlyAround=function(c,b,e,d){var a=null;var f=null;while(a==null||b[a][f]==1){a=Math.min(b[0].length-1,Math.max(0,parseInt(e+Math.random()*2-1)));f=Math.min(b.length-1,Math.max(0,parseInt(d+Math.random()*2-1)))}b[a][f]=c};gameCreation.setupBasecamp=function(b,e,a){var g=gameData.BASECAMPS[e.r];var f=new gameData.Building(g.buildings[0],a.x,a.y,e.o,true);this.addGameElement(b,f);var c=tools.getFreeTilesAroundElements(b,f);for(var d in g.units){this.addGameElement(b,new gameData.Unit(g.units[d],c[d].x,c[d].y,e.o))}};gameCreation.getAvailableInitialPositions=function(b){var c=[];if(b!=4){var e=[[0,0,0],[0,1,0],[0,0,0]];for(var d=0;d<b;d++){var a=null;var f=null;while(a==null||e[a][f]>0){a=parseInt(Math.random()*3);f=parseInt(Math.random()*3)}e[a][f]=1;c.push({x:a,y:f});if(b<=3){if(a<2){e[a+1][f]=1}if(a>0){e[a-1][f]=1}if(f<2){e[a][f+1]=1}if(f>0){e[a][f-1]=1}}}}else{if(Math.random()<0.5){c.push({x:0,y:0});c.push({x:0,y:2});c.push({x:2,y:0});c.push({x:2,y:2})}else{c.push({x:1,y:0});c.push({x:1,y:2});c.push({x:0,y:1});c.push({x:2,y:1})}}return c};gameCreation.convertCoordinates=function(a,b){if(b==0){return 1}else{if(b==1){return parseInt(a/2)}else{return a-2}}};var gameData={};gameData.FAMILIES={unit:0,building:1,land:2,research:3};gameData.ELEMENTS=[[],[],[],[]];gameData.BASECAMPS=[];gameData.RANKS={me:0,ally:1,neutral:2,enemy:3};gameData.PLAYER_STATUSES={ig:0,defeat:1,victory:2,watcher:3,surrender:4};gameData.ELEMENTS_FLAGS={nothing:0,moving:1,attacking:2,mining:3,dying:5,building:6};gameData.unitId=0;gameData.createUniqueId=function(a){this.unitId+=1;return parseInt("1"+a+""+this.unitId)};var gameLogic={};gameLogic.FREQUENCY=5;gameLogic.OFFLINE_FREQUENCY=6;gameLogic.AI_FREQUENCY=6;gameLogic.update=function(a){a.modified=[];a.added=[];a.removed=[];for(var e in a.orders){order.dispatchReceivedOrder(a,a.orders[e][0],a.orders[e][1])}a.orders=[];for(var g in a.players){if(a.players[g].s!=gameData.PLAYER_STATUSES.surrender){a.players[g].s=gameData.PLAYER_STATUSES.defeat}if(a.players[g].ai&&a.iterate%this.AI_FREQUENCY==0){aiOrders.update(a,a.players[g])}}for(var g in a.gameElements.unit){var d=a.gameElements.unit[g];this.resolveActions(a,d);this.updateMoves(a,d);this.protectAround(a,d);var c=d.buff.length;while(c--){var f=d.buff[c];if(f.type==fightLogic.ACTIVE_BUFF.poison){d.l-=f.damage;d.buff.time--;if(d.buff.time==0){d.buff.splice(c,1)}tools.addUniqueElementToArray(a.modified,d)}}}for(var g in a.gameElements.building){var d=a.gameElements.building[g];if(a.players[d.o].s!=gameData.PLAYER_STATUSES.surrender){a.players[d.o].s=gameData.PLAYER_STATUSES.ig}this.updateBuildings(a,d);if(tools.getElementData(d).attack!=null){this.resolveActions(a,d);this.protectAround(a,d)}}this.synchronizeActions(a);this.removeDeads(a);this.checkGameOver(a);stats.update(a);var b=[];for(var e in a.chat){b.push(a.chat[e])}a.chat=[];return{modified:a.modified,added:a.added,removed:a.removed,players:a.players,chat:b}};gameLogic.synchronizeActions=function(a){for(var b in a.newBuildings){a.newBuildings[b].l=1;gameCreation.addGameElement(a,a.newBuildings[b])}a.newBuildings=[];for(var b in a.cancelBuildings){gameCreation.removeGameElement(a,a.cancelBuildings[b])}a.cancelBuildings=[];for(var b in a.cancel){var c=a.cancel[b];production.cancel(a,c.building,c.index)}a.cancel=[]};gameLogic.updateMoves=function(a,b){if(b.a!=null&&b.a.moveTo!=null){move.moveElement(a,b,b.a.moveTo);b.fl=gameData.ELEMENTS_FLAGS.moving;tools.addUniqueElementToArray(a.modified,b)}};gameLogic.resolveActions=function(a,c){if(c.a!=null&&c.a.id!=null){var e=tools.getElementById(a,c.a.id);if(e!=null){var b=tools.getElementData(c);var f=tools.getElementsDistance(c,e);if(f==1){c.a.moveTo=null;c.fl=gameData.ELEMENTS_FLAGS.nothing;if(b.isBuilder&&e.f==gameData.FAMILIES.building&&rank.isAlly(a.players,c.o,e)){if(c.ga!=null){production.getBackResources(a,c)}else{action.doTheBuild(a,c,e)}}else{if(b.isBuilder&&e.f==gameData.FAMILIES.land){action.doTheGathering(a,c,e)}else{if(rank.isEnemy(a.players,c.o,e)){action.doTheAttack(a,c,e)}}}}else{if(f<=accessors.getStat(a.players,c.o,b,fightLogic.STATS_BUFF.range)){if(rank.isEnemy(a.players,c.o,e)){c.a.moveTo=null;action.doTheAttack(a,c,e)}}else{var d=tools.getClosestPart(c,e);c.a.moveTo={x:d.x,y:d.y}}}tools.addUniqueElementToArray(a.modified,c)}else{if(c.a.type==action.ACTION_TYPES.gather){AI.searchForNewResources(a,c,c.a.info)}else{if(c.a.type==action.ACTION_TYPES.move||c.a.type==action.ACTION_TYPES.patrol){order.goToElementNextOrder(a,c)}}}}};gameLogic.removeDeads=function(a){for(var c in a.gameElements.unit){var b=a.gameElements.unit[c];if(b.l<=0){production.removeUnit(a,b);gameCreation.removeGameElement(a,b);delete a.gameElements.unit[b.id]}}};gameLogic.updateBuildings=function(a,b){if(b.q.length>0){production.updateQueueProgress(a,b);tools.addUniqueElementToArray(a.modified,b)}};gameLogic.checkGameOver=function(a){var c=0;var d=-1;for(var b in a.players){if(a.players[b].s==gameData.PLAYER_STATUSES.defeat||a.players[b].s==gameData.PLAYER_STATUSES.surrender){c++}else{d=a.players[b].o}}if(c==a.players.length-1){a.players[d].s=gameData.PLAYER_STATUSES.victory}};gameLogic.protectAround=function(a,c){var b=tools.getElementData(c);if((c.a==null||c.a.type==action.ACTION_TYPES.move&&c.a.info==order.SPECIAL_ORDERS.attack)&&!b.isBuilder&&(c.f==gameData.FAMILIES.unit||c.cp>=100&&b.attack!=null)){AI.searchForNewEnemy(a,c)}};var move={};move.ASTAR_MAX_STEPS_SEARCH=4;move.DESTINATION_SEARCH_NUMBER=5;move.ASTAR_MAX_RADIUS_SEARCH=10;move.moveElement=function(m,e,h){var c=tools.getElementData(e);if(m.iterate%accessors.getStat(m.players,e.o,c,fightLogic.STATS_BUFF.speed)==0){var b=c.passiveSkill[fightLogic.PASSIVE_SKILLS.shootDelay];if(b!=null){b.current=b.delay}var a=0;grosBoucle:while(m.grid[h.x][h.y].c>0&&a<this.DESTINATION_SEARCH_NUMBER){a++;var l=astar.neighbors(m.grid,h.x,h.y,true);for(var f in l){if(l[f].c==0){h=l[f];e.a.moveTo={x:h.x,y:h.y};break grosBoucle}}h={x:l[1].x,y:l[1].y}}if(h.c>0){e.a.moveTo=null;return}var n=astar.search(m.grid,e.p,m.grid[h.x][h.y],true);if(n.length>0){var g=c.shape;for(var f in g){for(var d in g[f]){if(g[f][d]>0){var k=tools.getPartPosition(e,f,d);m.grid[k.x][k.y].c=0}}}e.p.x=n[0].x;e.p.y=n[0].y;for(var f in g){for(var d in g[f]){if(g[f][d]>0){var k=tools.getPartPosition(e,f,d);m.grid[k.x][k.y].c=e.id}}}if(e.a.moveTo.x==e.p.x&&e.a.moveTo.y==e.p.y){if(e.a.type==action.ACTION_TYPES.move){e.a=null;if(e.pa.length>0){order.goToElementNextOrder(m,e)}}else{e.a.moveTo=null;e.fl=gameData.ELEMENTS_FLAGS.nothing}}}}};var astar={init:function(a,b,e){var g=Math.max(0,Math.min(b.x,e.x)-move.ASTAR_MAX_RADIUS_SEARCH);var j=Math.min(a[0].length,Math.max(b.x,e.x)+move.ASTAR_MAX_RADIUS_SEARCH);var d=Math.max(0,Math.min(b.y,e.y)-move.ASTAR_MAX_RADIUS_SEARCH);var f=Math.min(a.length,Math.max(b.y,e.y)+move.ASTAR_MAX_RADIUS_SEARCH);for(var i=g;i<j;i++){for(var h=d;h<f;h++){var c=a[i][h];c.f=0;c.g=0;c.h=0;c.cost=1;c.visited=false;c.closed=false;c.parent=null}}},heap:function(){return new BinaryHeap(function(a){return a.f})},search:function(a,c,f,e,j){astar.init(a,c,f);j=j||astar.manhattan;e=!!e;var l=astar.heap();l.push(a[c.x][c.y]);while(l.size()>0){var d=l.pop();if(d===f||l.size()>this.ASTAR_MAX_STEPS_SEARCH){var p=d;var h=[];while(p.parent){h.push(p);p=p.parent}return h.reverse()}d.closed=true;var o=astar.neighbors(a,d.x,d.y,e);for(var g=0,m=o.length;g<m;g++){var n=o[g];if(n.closed||n.c>0){continue}var k=d.g+n.cost;var b=n.visited;if(!b||k<n.g){n.visited=true;n.parent=d;n.h=n.h||j(n,f);n.g=k;n.f=n.g+n.h;if(!b){l.push(n)}else{l.rescoreElement(n)}}}}return[]},manhattan:function(c,a){var d=Math.abs(a.x-c.x);var b=Math.abs(a.y-c.y);return d+b},neighbors:function(d,a,e,c){var b=[];if(d[a-1]&&d[a-1][e]){b.push(d[a-1][e])}if(d[a+1]&&d[a+1][e]){b.push(d[a+1][e])}if(d[a]&&d[a][e-1]){b.push(d[a][e-1])}if(d[a]&&d[a][e+1]){b.push(d[a][e+1])}if(c){if(d[a-1]&&d[a-1][e-1]){b.push(d[a-1][e-1])}if(d[a+1]&&d[a+1][e-1]){b.push(d[a+1][e-1])}if(d[a-1]&&d[a-1][e+1]){b.push(d[a-1][e+1])}if(d[a+1]&&d[a+1][e+1]){b.push(d[a+1][e+1])}}return b}};function BinaryHeap(a){this.content=[];this.scoreFunction=a}BinaryHeap.prototype={push:function(a){this.content.push(a);this.sinkDown(this.content.length-1)},pop:function(){var a=this.content[0];var b=this.content.pop();if(this.content.length>0){this.content[0]=b;this.bubbleUp(0)}return a},remove:function(d){var a=this.content.length;for(var c=0;c<a;c++){if(this.content[c]==d){var b=this.content.pop();if(c!=a-1){this.content[c]=b;if(this.scoreFunction(b)<this.scoreFunction(d)){this.sinkDown(c)}else{this.bubbleUp(c)}}return}}throw new Error("Node not found.")},size:function(){return this.content.length},rescoreElement:function(a){this.sinkDown(this.content.indexOf(a))},sinkDown:function(d){var a=this.content[d];while(d>0){var c=Math.floor((d+1)/2)-1,b=this.content[c];if(this.scoreFunction(a)<this.scoreFunction(b)){this.content[c]=a;this.content[d]=b;d=c}else{break}}},bubbleUp:function(b){var a=this.content.length,f=this.content[b],h=this.scoreFunction(f);while(true){var e=(b+1)*2,j=e-1;var c=null;if(j<a){var i=this.content[j],k=this.scoreFunction(i);if(k<h){c=j}}if(e<a){var g=this.content[e],d=this.scoreFunction(g);if(d<(c==null?h:k)){c=e}}if(c!=null){this.content[b]=this.content[c];this.content[c]=f;b=c}else{break}}}};var order={};order.TYPES={action:0,buildThatHere:1,buy:2,cancelConstruction:3,chat:4,diplomacy:5,surrender:6,stop:7,hold:8,cancelQueue:9};order.SPECIAL_ORDERS={normal:0,attack:1,patrol:2};order.dispatchReceivedOrder=function(a,b,c){switch(b){case 0:this.convertDestinationToOrder(a,c[0],c[1],c[2],c[3],c[4]);break;case 1:this.buildThatHere(a,c[0],c[1],c[2],c[3],c[4]);break;case 2:this.buy(a,c[0],c[1]);break;case 3:this.cancelConstruction(a,c[0]);break;case 4:this.receiveChatMessage(a,c[0],c[1]);break;case 5:this.updateDiplomacy(a,c[0],c[1],c[2]);break;case 6:this.surrender(a,c[0]);break;case 7:this.stopUnits(a,c[0]);break;case 8:this.holdUnits(a,c[0]);break;case 9:this.cancelQueue(a,c[0],c[1]);break}};order.buildThatHere=function(b,e,c,a,g,f){var d=tools.getGameElementsFromIds(b,e);var c=new gameData.Building(c,a,g,d[0].o,false);production.startConstruction(b,c);this.build(b,d,c,f)};order.buy=function(a,d,c){var b=tools.getGameElementsFromIds(a,d);production.buyElement(a,b,c)};order.cancelConstruction=function(b,a){var c=tools.getGameElementsFromIds(b,[a]);production.cancelConstruction(b,c[0])};order.cancelQueue=function(c,b,a){var d=tools.getGameElementsFromIds(c,[b]);c.cancel.push({building:d[0],index:a})};order.updateRallyingPoint=function(b,e,a,h){for(var d in e){var c=e[d];var f=tools.getElementData(c);var g=f.buttons;if(g.length>0){c.rp={x:a,y:h}}tools.addUniqueElementToArray(b.modified,c)}};order.attack=function(a,d,e){for(var c in d){var b=d[c];b.a=new gameData.Order(action.ACTION_TYPES.attack,null,e.id);b.pa=[];tools.addUniqueElementToArray(a.modified,b)}};order.build=function(a,e,d,f){for(var c in e){var b=e[c];if(f&&b.a!=null&&b.a.type!=action.ACTION_TYPES.gather){b.pa.push(new gameData.Order(action.ACTION_TYPES.build,null,d.id))}else{b.a=new gameData.Order(action.ACTION_TYPES.build,null,d.id);b.pa=[]}tools.addUniqueElementToArray(a.modified,b)}};order.move=function(c,b,a,h,g,f){for(var e in b){var d=b[e];if(g&&d.a!=null&&d.a.type!=action.ACTION_TYPES.gather){d.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:a,y:h},null,f))}else{d.a=new gameData.Order(action.ACTION_TYPES.move,{x:a,y:h},null,f);d.pa=[];if(f==order.SPECIAL_ORDERS.patrol){d.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:d.p.x,y:d.p.y},null,2))}}tools.addUniqueElementToArray(c.modified,d)}};order.gather=function(c,b,a,g){var f=tools.getElementData(a);for(var e in b){var d=b[e];if(g&&d.a!=null&&d.a.type!=action.ACTION_TYPES.gather){d.pa.push(new gameData.Order(action.ACTION_TYPES.gather,null,a.id,f.resourceType))}else{d.a=new gameData.Order(action.ACTION_TYPES.gather,null,a.id,f.resourceType);d.pa=[d.a]}tools.addUniqueElementToArray(c.modified,d)}};order.receiveChatMessage=function(a,b,c){a.chat.push({o:b,text:c})};order.updateDiplomacy=function(a,d,c,b){a.players[d].ra[c]=b};order.surrender=function(a,b){a.players[b].s=gameData.PLAYER_STATUSES.surrender};order.convertDestinationToOrder=function(n,g,l,h,b,k){var a=tools.getGameElementsFromIds(n,g);if(a.length==0||n.grid[l]==null||n.grid[l][h]==null){console.log(l+" "+h);return}var f=null;var m=n.grid[l][h].c;if(m>0){f=tools.getGameElementsFromIds(n,[m])}if(a[0].f==gameData.FAMILIES.building){this.updateRallyingPoint(n,a,l,h)}else{if(f!=null&&f.length>0){var j=tools.getElementData(f[0]);if(f[0].f==gameData.FAMILIES.unit){if(!rank.isAlly(n.players,a[0].o,f[0])){this.attack(n,a,f[0]);return}}else{if(f[0].f==gameData.FAMILIES.building){if(rank.isAlly(n.players,a[0].o,f[0])){for(var c in a){var d=a[c];if(tools.getElementData(d).isBuilder){order.build(n,[d],f[0],b)}else{order.move(n,[d],l,h,b,k)}}return}else{order.attack(n,a,f[0]);return}}else{if(f[0].f==gameData.FAMILIES.land&&j.resourceType>=0){for(var c in a){var d=a[c];if(tools.getElementData(d).isBuilder){order.gather(n,[d],f[0],b)}else{order.move(n,[d],l,h,b,k)}}return}}}}order.move(n,a,l,h,b,k)}};order.goToElementNextOrder=function(a,b){if(b.pa.length>0){if(b.a!=null&&b.a.type==action.ACTION_TYPES.gather){return}else{if(b.a!=null&&b.a.type==action.ACTION_TYPES.build){var c=tools.getElementById(a,b.a.id);var d=tools.getElementData(c);if(c.cp<100||c.l<d.l){return}}else{if(b.pa[0].type==action.ACTION_TYPES.move&&b.pa[0].info==order.SPECIAL_ORDERS.patrol&&b.pa.length==1){b.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:b.p.x,y:b.p.y},null,order.SPECIAL_ORDERS.patrol));b.pa.push(new gameData.Order(action.ACTION_TYPES.move,{x:b.pa[0].moveTo.x,y:b.pa[0].moveTo.y},null,order.SPECIAL_ORDERS.patrol))}}}b.a=b.pa[0];b.pa.splice(0,1)}else{b.a=null;b.fl=gameData.ELEMENTS_FLAGS.nothing}};order.stopUnits=function(a,e){var d=tools.getGameElementsFromIds(a,e);for(var c in d){var b=d[c];if(b.f==gameData.FAMILIES.unit){b.a=null;b.pa=[];tools.addUniqueElementToArray(a.modified,b)}}};order.holdUnits=function(a,e){var d=tools.getGameElementsFromIds(a,e);for(var c in d){var b=d[c];if(b.f==gameData.FAMILIES.unit){b.a=new gameData.Order(action.ACTION_TYPES.hold,null,null);b.pa=[];tools.addUniqueElementToArray(a.modified,b)}}};var production={};production.RESOURCE_AMOUNT_PER_GATHERING_ACTION=2;production.BUILDINGS_QUEUE_MAX_SIZE=5;production.REPAIRING_SPEED=5;production.startConstruction=function(a,b){var c=tools.getElementData(b);if(this.canBuyIt(a.players,b.o,c)){this.paysForElement(a,b.o,c);a.newBuildings.push(b)}};production.updateConstruction=function(a,b){var c=tools.getElementData(b);b.cp+=100/c.timeConstruction;b.l+=parseInt(c.l/c.timeConstruction);b.l=Math.min(c.l,b.l);if(b.cp>=100){this.finishConstruction(a,b)}tools.addUniqueElementToArray(a.modified,b)};production.cancelConstruction=function(a,c){if(c!=null&&c.cp<95){var d=tools.getElementData(c);this.sellsElement(a,c.o,d);this.removeBuilding(a,c);for(var b in a.gameElements.unit){if(a.gameElements.unit[b].a!=null&&a.gameElements.unit[b].a.id==c.id){order.goToElementNextOrder(a,a.gameElements.unit[b])}}a.cancelBuildings.push(c);delete a.gameElements.building[c.id]}};production.cancel=function(a,c,b){var d=null;if(c.q[b]>=0){d=gameData.FAMILIES.unit}else{d=gameData.FAMILIES.research;a.players[c.o].tecC.splice(a.players[c.o].tecC.indexOf(b))}this.sellsElement(a,c.o,tools.getElementDataFrom(d,c.r,c.q[b]));c.q.splice(b,1);if(b==0){c.qp=0}tools.addUniqueElementToArray(a.modified,c)};production.finishConstruction=function(a,b){var c=tools.getElementData(b);b.cp=100;b.l=c.l;a.players[b.o].tec.push(c.key);if(c.pop>0){a.players[b.o].pop.max+=c.pop}stats.updateField(a,b.o,"buildingsCreated",1)};production.repairBuilding=function(b,c){var a=b.players[c.o].re;if(a[gameData.RESOURCES.wood.id]>0&&a[gameData.RESOURCES.gold.id]>0){a[gameData.RESOURCES.gold.id]--;a[gameData.RESOURCES.wood.id]--;c.l+=this.REPAIRING_SPEED;c.l=Math.min(c.l,tools.getElementData(c).l);tools.addUniqueElementToArray(b.modified,c)}};production.removeBuilding=function(a,c){var d=tools.getElementData(c);if(d.pop>0&&c.cp==100){a.players[c.o].pop.max-=d.pop;a.players[c.o].tec.splice(a.players[c.o].tec.indexOf(d.key))}for(var b in c.q){this.cancel(a,c,b)}if(c.murderer!=null){stats.updateField(a,c.murderer,"buildingsDestroyed",1)}};production.gatherResources=function(b,a,f){var g=tools.getElementData(f);var d=tools.getElementData(a);if(a.ga==null||a.ga.t!=g.resourceType){a.ga={t:g.resourceType,amount:0}}var c=Math.min(d.maxGathering-a.ga.amount,this.RESOURCE_AMOUNT_PER_GATHERING_ACTION,f.ra);a.ga.amount+=c;f.ra-=c;tools.addUniqueElementToArray(b.modified,f);if(a.ga.amount==d.maxGathering){var e=tools.getNearestStuff(b,a,gameData.FAMILIES.building,gameData.ELEMENTS[gameData.FAMILIES.building][a.r].mothertree.t,gameData.RANKS.me,true);if(e!=null){a.a=new gameData.Order(action.ACTION_TYPES.gather,null,e.id,g.resourceType);a.pa=[new gameData.Order(action.ACTION_TYPES.gather,null,f.id,g.resourceType)]}else{a.a=null;a.pa=[]}}if(f.ra==0){gameCreation.removeGameElement(b,f);delete b.gameElements.land[f.id];AI.searchForNewResources(b,a,g.resourceType)}};production.getBackResources=function(b,a){var c=a.ga.t;b.players[a.o].re[a.ga.t]+=a.ga.amount;stats.updateField(b,a.o,"resources",a.ga.amount);a.ga=null;if(a.pa.length>0&&a.pa[0].type==action.ACTION_TYPES.gather){var d=tools.getElementById(b,a.pa[0].id);if(d==null||d.ra<=0){AI.searchForNewResources(b,a,c)}else{a.a=a.pa[0]}}a.pa=[]};production.buyElement=function(a,e,d){for(var c in e){var b=e[c];if(b.t==e[0].t&&b.cp==100&&b.q.length<this.BUILDINGS_QUEUE_MAX_SIZE&&this.canBuyIt(a.players,b.o,d)){this.paysForElement(a,b.o,d);b.q.push(d.t);tools.addUniqueElementToArray(a.modified,b);if(d.t>=0){}else{a.players[b.o].tecC.push(d.t);return}}}};production.updateQueueProgress=function(a,c){var b;if(c.q[0]>=0){b=tools.getElementDataFrom(gameData.FAMILIES.unit,c.r,c.q[0])}else{b=tools.getElementDataFrom(gameData.FAMILIES.research,c.r,c.q[0])}c.qp+=parseInt(100/(gameLogic.FREQUENCY*b.timeConstruction));if(c.qp>=100){var d=true;if(c.q[0]>=0){d=this.createNewUnit(a,c.q[0],c)}else{d=true;a.players[c.o].tec.push(c.q[0]);a.players[c.o].tecC.splice(a.players[c.o].tecC.indexOf(c.q[0]))}if(d){c.qp=0;c.q.splice(0,1)}else{c.qp=99}}tools.addUniqueElementToArray(a.modified,c)};production.createNewUnit=function(d,e,c){var f=tools.getElementDataFrom(gameData.FAMILIES.unit,c.r,e);var b=tools.getFreeTilesAroundElements(d,c);var h=d.players[c.o].pop;if(b.length>0&&h.current+f.pop<=h.max){if(f.isBuilder){stats.updateField(d,c.o,"buildersCreated",1)}else{stats.updateField(d,c.o,"unitsCreated",1)}var a=b[b.length-1];var g=new gameData.Unit(f,a.x,a.y,c.o);d.players[c.o].pop.current+=f.pop;gameCreation.addGameElement(d,g);if(c.rp!=null){order.convertDestinationToOrder(d,[g.id],c.rp.x,c.rp.y)}return true}return false};production.removeUnit=function(a,c){var b=tools.getElementData(c);if(b.pop>0){a.players[c.o].pop.current-=b.pop}if(c.murderer!=null){stats.updateField(a,c.murderer,"killed",1);stats.updateField(a,c.o,"lost",1)}};production.canBuyIt=function(e,a,c){for(var b in c.needs){var d=c.needs[b];if(d.t>=0){if(d.value>e[a].re[d.t]){return false}}else{if(e[a].tec.indexOf(d.t)==-1){return false}}}return true};production.paysForElement=function(b,a,d){for(var c in d.needs){var e=d.needs[c];if(e.t>=0){b.players[a].re[e.t]-=e.value}}};production.sellsElement=function(b,a,d){if(d!=null){for(var c in d.needs){var e=d.needs[c];if(e.t>=0){b.players[a].re[e.t]+=parseInt(e.value/2)}}}};production.getWhatCanBeBought=function(d,a,e){var f=[];for(var c in e){var b=e[c];if(b.t>=0||d[a].tec.indexOf(b.t)==-1&&d[a].tecC.indexOf(b.t)==-1){b.isEnabled=this.canBuyIt(d,a,b);b.id=""+b.f+b.r+b.t;f.push(b)}}if(e.house!=null){f.splice(0,0,gameData.BUTTONS.back)}return f};var rank={};rank.isEnemy=function(b,c,a){if(b[c].ra[a.o]==gameData.RANKS.enemy){return true}else{return false}};rank.canBeAttacked=function(b,c,a){if(b[c].ra[a.o]==gameData.RANKS.enemy||b[c].ra[a.o]==gameData.RANKS.neutral){return true}else{return false}};rank.isAlly=function(b,c,a){if(b[c].ra[a.o]==gameData.RANKS.me||b[c].ra[a.o]==gameData.RANKS.ally){return true}else{return false}};var stats={};stats.UPDATE_FREQUENCY=100;stats.init=function(a){for(var b in a.players){a.stats.push({pop:[],killed:0,lost:0,buildingsDestroyed:0,unitsCreated:0,resources:0,buildersCreated:0,buildingsCreated:0})}};stats.update=function(a){if(a.iterate%this.UPDATE_FREQUENCY==0){for(var b in a.players){a.stats[b].pop.push([new Date().getTime(),a.players[b].pop.current])}}};stats.updateField=function(b,a,d,c){b.stats[a][d]+=c};stats.getTotalScore=function(b,a){return b.killed*20-b.lost*20+b.buildingsDestroyed*100+b.unitsCreated*10+b.resources+b.buildersCreated*5+b.buildingsCreated*20+a*500};var tools={};tools.getPositionsDistance=function(b,a){return Math.max(Math.abs(b.x-a.x),Math.abs(b.y-a.y))};tools.getElementsDistance=function(g,f){var e=10000;if(f!=null){var d=tools.getElementData(f);var a=d.shape;for(var c in a){for(var b in a[c]){var h=this.getPositionsDistance(g.p,this.getPartPosition(f,c,b));if(h<e){e=h}if(e==1){return e}}}}return e};tools.getClosestPart=function(k,h){var d=10000;var b;var c=tools.getElementData(h);var g=c.shape;for(var f in g){for(var e in g[f]){var a=this.getPositionsDistance(k.p,this.getPartPosition(h,f,e));if(a<d){d=a;b=this.getPartPosition(h,f,e)}if(d==1){return b}}}return b};tools.getPartPosition=function(e,d,b){var a=null;if(e.shape==null){var c=tools.getElementData(e);a=c.shape}else{a=e.shape}return{x:parseInt(e.p.x+parseInt(d)-parseInt(a[0].length/2)),y:parseInt(e.p.y+parseInt(b)-parseInt(a.length/2))}};tools.getFreeTilesAroundElements=function(l,d){var f=[];var b=tools.getElementData(d);var g=b.shape;for(var e in g){for(var c in g[e]){if(g[e][c]>0){var h=this.getPartPosition(d,e,c);var m=this.getNeighbors(l.grid,h.x,h.y);for(var a in m){var k=m[a];if(l.grid[k.x][k.y].c==0){f.push({x:k.x,y:k.y})}}}}}return f};tools.getNeighbors=function(c,a,d){var b=[];if(c[a-1]&&c[a-1][d]!=null){b.push({x:a-1,y:d})}if(c[a+1]&&c[a+1][d]!=null){b.push({x:a+1,y:d})}if(c[a]&&c[a][d-1]!=null){b.push({x:a,y:d-1})}if(c[a]&&c[a][d+1]!=null){b.push({x:a,y:d+1})}if(c[a-1]&&c[a-1][d-1]!=null){b.push({x:a-1,y:d-1})}if(c[a+1]&&c[a+1][d-1]!=null){b.push({x:a+1,y:d-1})}if(c[a-1]&&c[a-1][d+1]!=null){b.push({x:a-1,y:d+1})}if(c[a+1]&&c[a+1][d+1]!=null){b.push({x:a+1,y:d+1})}return b};tools.getGameElementsFromIds=function(a,c){var d=[];for(var b in c){d.push(a.gameElements[Object.keys(gameData.FAMILIES)[(""+c[b]).charAt(1)]][c[b]])}return d};tools.addUniqueElementToArray=function(c,b){var a=c.indexOf(b);if(a==-1){c.push(b)}};tools.clone=function(b){var c={};for(var a in b){if(b.hasOwnProperty(a)&&a!="a"){c[a]=b[a]}}return c};tools.getNearestStuff=function(m,j,h,k,g,l){var a=null;if(!l){var b=0;var c=tools.getElementData(j);do{b++;a=tools.searchInTiles(m,this.getTilesAround(m.grid,j.p,b,false),j,h,k,g)}while(a==null&&b<c.vision)}else{var d=1000;for(var f in m.gameElements[Object.keys(gameData.FAMILIES)[h]]){var e=m.gameElements[Object.keys(gameData.FAMILIES)[h]][f];if((k==null||e.t==k)&&(g==null||m.players[j.o].ra[e.o]==g)){var b=this.getElementsDistance(j,e);if(b<d){d=b;a=e;if(d<5){return a}}}}}return a};tools.getTilesAround=function(g,a,f,e){var b=[];for(var d=a.x-f;d<=a.x+f;d++){if(g[d]!=null){if(e||d==a.x-f||d==a.x+f){for(var c=a.y-f;c<=a.y+f;c++){if(g[d][c]){b.push(g[d][c])}}}else{if(g[d][a.y-f]){b.push(g[d][a.y-f])}else{if(g[d][a.y+f]){b.push(g[d][a.y+f])}}}}}return b};tools.searchInTiles=function(b,a,h,e,d,g){for(var c in a){if(a[c].c>0){var f=b.gameElements[Object.keys(gameData.FAMILIES)[e]][a[c].c];if(f!=null&&f.f==e&&(d==null||f.t==d)&&(g==null||b.players[h.o].ra[f.o]==g)){return f}}}return null};tools.getElementById=function(a,b){return a.gameElements[Object.keys(gameData.FAMILIES)[(""+b)[1]]][b]};tools.getElementData=function(a){if(a.t>=0){var b=gameData.ELEMENTS[a.f][a.r];return b[Object.keys(b)[a.t]]}else{return gameData.ELEMENTS[a.f][a.r][a.t]}};tools.getElementDataFrom=function(c,a,b){var d=gameData.ELEMENTS[c][a];if(b>=0){return d[Object.keys(d)[b]]}else{return d[b]}};gameData.Building=function(c,b,e,a,d){this.f=gameData.FAMILIES.building;this.id=gameData.createUniqueId(this.f);this.t=c.t;this.o=a;this.r=c.r;this.p={x:b,y:e};this.fl=0;this.cp=(d?100:0);this.rp=null;this.q=[];this.qp=0;this.fr=0;this.l=c.l;this.a=null;this.toJSON=function(){return this}};gameData.Game=function(){this.stats=[];this.players=[];this.grid=[];this.gameElements={land:{},building:{},unit:{}};this.newBuildings=[];this.cancelBuildings=[];this.cancel=[];this.orders=[];this.modified=[];this.added=[];this.removed=[];this.chat=[];this.iterate=-1;this.update=function(){this.iterate=(this.iterate>100?0:this.iterate+1);var a=gameLogic.update(this);return a}};gameData.Map=function(c,b,e,d,a){this.t=c;this.size=b;this.ve=e;this.ir=d;this.objectives=a};gameData.Order=function(c,a,b,d){this.type=c;this.moveTo=a;this.id=b;this.info=d;this.toJSON=function(){var e=null;if(this.moveTo!=null){e={x:this.moveTo.x,y:this.moveTo.y}}return{type:this.type,moveTo:e,id:this.id,info:this.info}}};gameData.Player=function(b,a,e,g){this.pid=b;this.o=a;this.r=e;this.n="";this.re=[];this.ra=[];this.s=gameData.PLAYER_STATUSES.ig;this.tec=[];this.tecC=[];this.pop={max:0,current:0};this.ai=false;if(typeof g!="undefined"){if(g){this.ai=true}}for(var d in gameData.BASECAMPS[this.r].buildings){var c=gameData.BASECAMPS[this.r].buildings[d];if(c.pop>0){this.pop.max+=c.pop}}for(var d in gameData.BASECAMPS[this.r].units){var f=gameData.BASECAMPS[this.r].units[d];if(f.pop>0){this.pop.current+=f.pop}}};gameData.Terrain=function(b,a,c){this.f=gameData.FAMILIES.land;this.id=gameData.createUniqueId(this.f);this.t=b.t;this.r=0;this.p={x:a,y:c};this.sta=b.sta;this.ra=b.ra;this.toJSON=function(){return this}};gameData.Unit=function(c,b,d,a){this.f=gameData.FAMILIES.unit;this.id=gameData.createUniqueId(this.f);this.t=c.t;this.r=c.r;this.o=a;this.p={x:b,y:d};this.fl=0;this.a=null;this.pa=[];this.fr=0;this.ga=null;this.l=c.l;this.buff=[];this.toJSON=function(){var e=null;if(this.a!=null){e=this.a.toJSON()}return{id:this.id,f:this.f,t:this.t,r:this.r,o:this.o,p:{x:this.p.x,y:this.p.y},fl:this.fl,fr:this.fr,ga:this.ga,pa:this.pa,l:this.l,a:e}}};